<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
	<select id="pages.module.train.jobsBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		 <![CDATA[
		 SELECT row_number() OVER() AS row,* FROM(
		select 
		 t.*
		 ,(SELECT loadtime FROM bus_truck WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1) AS loadtime
		 ,(SELECT releasetime FROM bus_customs WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1) AS releasetime
		 ,(SELECT singtime  FROM bus_customs WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1) AS singtime
		 ,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 40 AND code =(SELECT custype  FROM bus_customs WHERE jobid = t.id AND clstype='O' AND isdelete = FALSE order by nos LIMIT 1)) AS custype
		 ,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 100 AND code =(SELECT status  FROM bus_customs WHERE jobid = t.id AND clstype='O' AND isdelete = FALSE order by nos LIMIT 1)) AS status
		 ,(SELECT cntcheck_time  FROM bus_customs WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1) AS cntchecktime
		 ,(SELECT cntrelease_time  FROM bus_customs WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1) AS cntreleasetime
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		 ,(SELECT count(*) FROM bus_ship_bill WHERE isdelete = FALSE AND bltype = 'H' AND jobid = t.id) AS hblnumber
		 ,(SELECT count(*) FROM bus_ship_bill WHERE isdelete = FALSE AND bltype = 'M' AND jobid = t.id) AS mblnumber
		 ,(SELECT bltype FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS bltype
		 ,(SELECT putstatus FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS putstatus
		 ,(SELECT substring(b.cnortitle FROM 1 FOR (CASE WHEN position(CHR(10) in b.cnortitle)< 1  THEN length(b.cnortitle) ELSE (position(CHR(10) in b.cnortitle)-1) END)) FROM bus_train b WHERE b.isdelete = FALSE AND b.jobid = t.id) AS cnortitle
		 ,(SELECT substring(b.cneetitle FROM 1 FOR (CASE WHEN position(CHR(10) in b.cneetitle)< 1  THEN length(b.cneetitle) ELSE (position(CHR(10) in b.cneetitle)-1) END)) FROM bus_train b WHERE b.isdelete = FALSE AND b.jobid = t.id) AS cneetitle
		 ,(SELECT (regexp_split_to_array(notifytitle,chr(10)))[1] FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS notifytitle
		 ,(select b.nos from _fina_jobs b  where b.id = t.newid) AS foreignnos
		 ,(SELECT piece FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS piece
		 ,(SELECT packer FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS packer
		 ,(SELECT SUM(grswgt) FROM bus_ship_container WHERE isdelete = FALSE AND jobid = t.id AND parentid is null) AS grswgt
		 ,(SELECT atd FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS atd
		 ,(SELECT ata FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS ata
		 ,(SELECT SUM(cbm) FROM bus_ship_container WHERE isdelete = FALSE AND jobid = t.id AND parentid is null) AS cbm
		 ,(SELECT destination FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS destination
		 ,(SELECT y.namec FROM bus_train x,dat_goodstype y WHERE x.isdelete = FALSE AND x.jobid = t.id AND x.goodstypeid = y.id) AS goodstypenamec
		 ,(SELECT y.abbr FROM bus_train x,sys_corporation y WHERE x.isdelete = FALSE AND x.jobid = t.id AND x.agentdesid = y.id) AS agentdesidabbr
		 ,(SELECT (CASE WHEN x.truckstate = 'I' THEN '初始' ELSE '完成' END) FROM bus_truck x,dat_filedata y WHERE x.isdelete = FALSE AND x.jobid = t.id AND x.truckstate = y.code LIMIT 1) AS truckstate
		 ,(SELECT isinsurance FROM bus_truck WHERE isdelete = FALSE AND jobid = t.id LIMIT 1) AS isinsurance
		 ,(SELECT y.abbr FROM bus_truck x,sys_corporation y WHERE x.isdelete = FALSE AND x.jobid = t.id AND x.truckid = y.id LIMIT 1) AS truckabbr
		 ,(SELECT y.abbr FROM bus_customs x,sys_corporation y WHERE x.isdelete = FALSE AND x.jobid = t.id AND x.customid = y.id LIMIT 1) AS customsabbr
		 ,(SELECT y.namec FROM bus_truck x,dat_filedata y WHERE x.isdelete = FALSE AND x.jobid = t.id AND x.trucktype = y.code AND x.trucktype IS NOT NULL AND x.trucktype <> '' AND y.isleaf = TRUE AND y.isdelete = false AND y.fkcode = 110 LIMIT 1) AS trucktype
		 ,(SELECT iscls FROM bus_truck WHERE isdelete = FALSE AND jobid = t.id LIMIT 1) AS iscls
		 ,(SELECT string_agg(x.namec,',') FROM sys_user x , sys_user_assign y WHERE x.id =y.userid AND y.roletype = 'F' AND y.linkid = t.shipid AND  COALESCE(y.isdelete,false) = false)  AS finance
		 ,(SELECT clstime FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS clstime
		 ,(select c.abbr from sys_corporation c, bus_train b where c.id=b.agentid AND b.jobid = t.id AND c.isagent  = TRUE AND b.isdelete = FALSE) AS agenter
		 ,(SELECT namec FROM dat_filedata WHERE isdelete = false AND fkcode = 150 AND isleaf = TRUE AND code = t.mbltype LIMIT 1) AS mbltypedesc
		 ,CASE WHEN ldtype = 'F' THEN (SELECT count(*) FROM bus_ship_container WHERE isdelete = false and parentid is null AND jobid = t.id) ELSE 0 END AS cncount
		 ,(CASE WHEN t.statetrace IS NULL THEN NULL ELSE f_sys_getls('userid=$userid$;lskey='||t.statetrace)||'-->'||f_sys_getls('userid=$userid$;lskey=下一步')||':'||COALESCE((SELECT f_sys_getls('userid=$userid$;lskey='||COALESCE(statusc,'')) FROM bus_goodstrack WHERE fkid = t.id AND isfinish = FALSE AND orderno > (SELECT orderno FROM bus_goodstrack WHERE isfinish = TRUE AND fkid = t.id ORDER BY orderno DESC LIMIT 1) ORDER BY orderno, dealdate LIMIT 1),'None') END) statetracenext
		 ,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 120 AND code =(SELECT clearingstate  FROM bus_customs WHERE jobid = t.id AND clstype='I' AND isdelete = FALSE order by nos LIMIT 1)) AS clearstate
		 ,(SELECT namec FROM sys_user x,bus_train y WHERE x.isdelete = FALSE AND y.isdelete = FALSE AND x.id = y.priceuserid AND y.jobid = t.id) priceusernamec
		 ,(SELECT contractno FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS contractno
		 ,(now()::DATE - t.eta) AS now_eta
		 ,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE id = t.saleid) saleuser
		 ,(select c.namec from dat_line c, bus_train b where (c.code = b.routecode OR c.namec = b.routecode) AND b.jobid = t.id AND c.isdelete = false LIMIT 1) AS routecode
		 ,(SELECT abbr FROM sys_corporation WHERE id = t.corpidop AND isdelete = FALSE) AS opcompany
		 ,(SELECT abbr FROM sys_corporation WHERE id = t.corpid AND isdelete = FALSE) AS company
		 ,(SELECT namec FROM sys_corporation WHERE id = t.customerid AND isdelete = FALSE) AS customernamec
		 ,(SELECT poa FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS poa
		 ,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 140 AND code =(SELECT hbltype FROM bus_train WHERE jobid = t.id and isdelete = false)) AS hbltypedesc
		 ,(SELECT (regexp_split_to_array(agentitle,chr(10)))[1] FROM bus_train WHERE isdelete = FALSE AND jobid = t.id) AS agentitle
		 ,(SELECT f_fina_jobs_cnts('jobid='::text||t.id)) AS cnts
		 ,(SELECT f_fina_jobs_cntdesc('jobid='::text||t.id)) AS cntdescnew
		 ,(SELECT namec FROM dat_filedata x , bus_train y WHERE x.isdelete = false AND x.fkcode = 320 AND x.isleaf = TRUE AND x.code = y.busstatus AND y.jobid = t.id LIMIT 1) AS busstatusdesc
		 ,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,''),',') FROM sys_user x , sys_user_assign y WHERE x.id =y.userid AND y.roletype = 'K' AND y.linkid = t.shipid AND  COALESCE(y.isdelete,false) = false)  AS bookinger
		FROM _fina_jobs_train t 
		WHERE $qry$
			$filter$
			AND jobtype = 'H'
			AND $icare$
			AND $carryitem$
			AND $dynamicClauseWhere$
			$setDays$
			 $corpfilter$
			AND isdelete = FALSE
			$ordersql$
			LIMIT $limit$ OFFSET $start$) AS T
		 ]]>
	</select>
	<select id="pages.module.train.jobsBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(1) AS counts 
		FROM _fina_jobs_train t 
		WHERE $qry$
			$filter$
			AND $icare$
			AND $carryitem$
			AND $dynamicClauseWhere$
			$setDays$
			 $corpfilter$
			AND isdelete = FALSE
			AND jobtype = 'H'
	</select>
	
	<select id="pages.module.train.jobseditBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[
		SELECT DISTINCT	t.id,prefix,code ,r.datefm , t.namec
			FROM sys_busnodesc t ,sys_busnorule r 
			WHERE $qry$
			AND t.id = r.busnotypeid 
			AND code like 'fina_jobs_train%'
			AND t.isdelete = FALSE AND r.isdelete = FALSE
			AND code NOT LIKE 'fina_jobs_air%' 
			AND code NOT LIKE 'fina_jobs_lan%' 
		order by t.namec,r.datefm, prefix
	]]>
	</select>
	<select id="pages.module.train.jobseditBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 10000 AS counts 
	</select>
	
	<select id="pages.module.train.bustrainBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 row_number() OVER() AS row,* 
		 ,COALESCE(piece,0) AS piece2
		 ,COALESCE(grswgt,0) AS grswgt2
		 ,COALESCE(cbm,0) AS cbm2
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		 ,(select vgm from bus_ship_container where id=t.id) AS vgm
		 ,(select ispace from bus_ship_container where id=t.id) AS ispace
		 ,(select spacecbm from bus_ship_container where id=t.id) AS spacecbm
		 ,(select goodstypeid from bus_train where id=t.id) AS goodstypeid
		FROM  _bus_ship_container t 
		WHERE $qry$
		AND parentid IS NULL
		AND isdelete = false
	</select>
	<select id="pages.module.train.bustrainBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  _bus_ship_container t 
		WHERE $qry$ 
		AND parentid IS NULL
		AND isdelete = false
	</select>
	
	
	<select id="pages.module.train.bustrainbillBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 * 
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		 ,f_bus_ship_bill_cntdesc('billid='||t.id) AS cntdesc
		 ,(SELECT String_agg(cntno,',') FROM bus_ship_container WHERE isdelete = FALSE AND ((t.bltype = 'H' AND billid = t.id AND jobid=t.jobid) OR (t.bltype = 'M' AND billmblid = t.id AND jobid=t.jobid))) AS cntnos
		FROM  _bus_train_bill t 
		WHERE $qry$
		AND isdelete = FALSE
		ORDER BY hblno
	</select>
	<select id="pages.module.train.bustrainbillBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  _bus_train_bill t 
		WHERE $qry$ 
		AND isdelete = FALSE
	</select>
	
	
	<select id="pages.module.train.bustrainbilleditBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 * 
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		FROM  _bus_ship_container t 
		WHERE $qry$
			AND isdelete = false
			AND NOT exists(SELECT 1 FROM bus_ship_container x where x.parentid = t.id and x.isdelete = false and x.jobid = t.jobid)
		ORDER BY $order$
	</select>
	
	<select id="pages.module.train.bustrainbilleditBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  _bus_ship_container t 
		WHERE $qry$ 
			AND NOT exists(SELECT 1 FROM bus_ship_container x where x.parentid = t.id and x.isdelete = false and x.jobid = t.jobid)
			AND isdelete = false
	</select>
	
	
	
	<select id="pages.module.train.bustrainBean.putgrid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[
		SELECT DISTINCT	t.id,prefix,code ,r.datefm , t.namec
			FROM sys_busnodesc t ,sys_busnorule r 
			WHERE $qry$
			AND t.id = r.busnotypeid 
			AND code like 'jobs_train_putno%'
			AND t.isdelete = FALSE AND r.isdelete = FALSE
		order by t.namec,r.datefm, prefix
	]]>
	</select>
	<select id="pages.module.train.bustrainBean.putgrid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 10000 AS counts 
	</select>
	
	
	
	<select id="pages.module.train.jobschildBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">

		SELECT DISTINCT t.*,(SELECT b.mblno FROM bus_train b WHERE b.jobid = t.id AND b.isdelete = false) AS mblno
				,(SELECT b.hblno FROM bus_train b WHERE b.jobid = t.id AND b.isdelete = false) AS hblno
				,(SELECT s.name FROM sys_department s WHERE s.id = t.deptid) AS name FROM(
									<!-- down  -->
									(WITH RECURSIVE  cte  AS  (
																SELECT a.*
																       ,(SELECT SUM(grswgt) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS grswgts
																       ,(SELECT SUM(cbm) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS cbms
																       ,(SELECT SUM(piece) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS pieces   
																       ,(SELECT SUM(netcbm) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS netcbm   
																       FROM fina_jobs a WHERE $child$
															    UNION ALL 
																SELECT k.*
																,(SELECT SUM(grswgt) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS grswgts
																,(SELECT SUM(cbm) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS cbms
																,(SELECT SUM(piece) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS pieces 
																,(SELECT SUM(netcbm) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS netcbm 
																 from fina_jobs k INNER JOIN cte c on c.id = k.parentid
															)SELECT * FROM cte
									)
									
									UNION ALL
									<!-- up  -->
									(WITH RECURSIVE cte  AS (
																SELECT a.*
																,(SELECT SUM(grswgt) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS grswgts
																,(SELECT SUM(cbm) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS cbms
																,(SELECT SUM(piece) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS pieces
																,(SELECT SUM(netcbm) FROM bus_ship_container c WHERE c.jobid = a.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS netcbm
																FROM fina_jobs a WHERE $child$
															UNION ALL 
																SELECT k.* 
																,(SELECT SUM(grswgt) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS grswgts
																,(SELECT SUM(cbm) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS cbms
														        ,(SELECT SUM(piece) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS pieces 
														        ,(SELECT SUM(netcbm) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS netcbm 
																from fina_jobs k INNER JOIN cte c on k.id = c.parentid
															)SELECT * from cte
									)UNION ALL


									<!-- 平级查找-->

									SELECT k.*
									,(SELECT SUM(grswgt) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS grswgts
						            ,(SELECT SUM(cbm) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS cbms
									,(SELECT SUM(piece) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS pieces 
									,(SELECT SUM(netcbm) FROM bus_ship_container c WHERE c.jobid = k.id AND c.isdelete = FALSE AND c.parentid IS NULL) AS netcbm 
									 FROM fina_jobs k WHERE parentid = $parentid$ AND $child2$ AND isdelete = FALSE

									
									
									
						    )AS t
		WHERE $qry$
		$sql3$
		ORDER BY nos
	</select>
	<select id="pages.module.train.jobschildBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 CAST(10 AS BIGINT) AS counts 
		FROM  _fina_jobschild t 
		
	</select>
	
	<select id="pages.module.train.busboxBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 * 
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		FROM  _bus_ship_container t 
		WHERE $qry$
			$filter$
			AND isdelete = false
			AND parentid IS NULL
		ORDER BY id
	</select>
	
	<select id="pages.module.train.busboxBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  _bus_ship_container t 
		WHERE $qry$ 
			$filter$
			AND isdelete = false
			AND parentid IS NULL
	</select>
	
	
</sqlMap>
