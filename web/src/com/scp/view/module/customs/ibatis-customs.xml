<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
	<select id="pages.module.customs.jobsBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select row_number() OVER() AS row,* from (
			select 
			 * 
			 ,(SELECT l2.jobidfm FROM fina_jobs_link l1 , fina_jobs_link l2  WHERE l1.jobidto = t.id AND l1.jobidfm = l2.jobidto )AS chid 
			  ,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE id = t.saleid) AS saledesc
			 ,(SELECT COALESCE((SELECT nos FROM fina_jobs WHERE t.parentid = id AND isdelete = FALSE),t.nos))AS ordenos
			 ,(SELECT abbr FROM sys_corporation x WHERE EXISTS(SELECT 1 FROM bus_customs WHERE customid = x.id AND jobid = t.id) LIMIT 1) AS customnamec
			 ,(SELECT abbr FROM sys_corporation WHERE id = t.corpidop AND isdelete = FALSE) AS opcompany
			 ,(SELECT abbr FROM sys_corporation WHERE id = t.corpid AND isdelete = FALSE) AS company
			 ,(SELECT x.namec||'/'||x.namee||'/'||d.name from  sys_user x ,sys_department d where x.deptid = d.id AND x.code = t.inputer) AS inpter2
			 ,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 45 AND code =(SELECT cusclass  FROM bus_customs WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1)) AS cusclass
			 ,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 100 AND code =(SELECT status  FROM bus_customs WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1)) AS status
			 ,(SELECT customstate  FROM bus_customs WHERE jobid = t.id AND isdelete = FALSE order by nos LIMIT 1) AS customstate
			 ,(SELECT f_fina_jobs_cnts('jobid='::text||t.id)) AS cnts
			 ,(SELECT string_agg(c.cntno,',') FROM bus_ship_container c WHERE c.jobid = t.id AND c.isdelete = FALSE AND c.cntno IS NOT NULL AND c.parentid is null) AS cntnos
			FROM fina_jobs t
		WHERE $qry$
		AND jobtype = 'C'
		$setDays$
		$filter$
		$corpfilter$
		AND isdelete = FALSE
		$ordersql$
		LIMIT $limit$ OFFSET $start$ ) as T 
	</select>
	<select id="pages.module.customs.jobsBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(1) AS counts 
		FROM	fina_jobs t 
		WHERE $qry$
		AND jobtype = 'C'
		$setDays$
		$filter$
		$corpfilter$
		AND isdelete = FALSE
		
	</select>
	
	<select id="pages.module.customs.jobseditBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[
		SELECT DISTINCT	t.id,prefix,code ,r.datefm , t.namec
			FROM sys_busnodesc t ,sys_busnorule r 
			WHERE $qry$
			AND t.id = r.busnotypeid 
			AND code like 'fina_jobs_customs%'
			AND t.isdelete = FALSE AND r.isdelete = FALSE
		order by t.namec,r.datefm, prefix
	]]>
	</select>
	<select id="pages.module.customs.jobseditBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 10000 AS counts 
	</select>
	
	<select id="pages.module.customs.buscustomsBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 row_number() OVER() AS row,* 
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		 ,(select status from bus_customs where id=t.id) AS status
		FROM  _bus_ship_container t 
		WHERE $qry$
		AND isdelete = false
		AND parentid IS NULL
		ORDER BY cntno,sealno,ldtype
	</select>
	
	<select id="pages.module.customs.buscustomsBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  _bus_ship_container t 
		WHERE $qry$ 
		AND isdelete = false
	</select>
	
</sqlMap>
