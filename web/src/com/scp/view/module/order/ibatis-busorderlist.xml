<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
	<select id="pages.module.order.busorderlistBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
			SELECT row_number() OVER() AS row,* FROM(
			SELECT 
				o.*
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = o.inputer and x.isdelete = false limit 1),o.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = o.updater and x.isdelete = false limit 1),o.updater) AS updatername
		 	,(select a.namee from _sys_corporation a,_bus_order b where a.id=o.customerid limit 1) customernamee
		 	,(SELECT namec FROM sys_user WHERE isdelete = FALSE AND id = o.priceuserid) priceusernamec
		 	,(SELECT string_agg(COALESCE((SELECT f_sys_getls('userid=$userid$;lskey='||COALESCE(namec,'')) FROM dat_filedata WHERE fkcode = 160 AND isleaf = TRUE AND code = p.roletype LIMIT 1),'')||':'||(SELECT namec FROM sys_user s WHERE s.id = p.userid ),',') FROM sys_user_assign p WHERE p.linkid = o.id AND isdelete =FALSE) AS cs
		 	,(SELECT mblno FROM bus_shipping x WHERE x.isdelete = FALSE AND x.jobid = o.jobid)||' '||(SELECT string_agg(mblno,',') FROM bus_ship_bill y WHERE y.isdelete = false AND y.jobid = o.jobid) AS mblno
		 	,(select abbr from sys_corporation  WHERE isagent = TRUE AND isdelete = false AND id = o.agentid) AS agenter
  			,(CASE WHEN piece20 > 0 THEN piece20||'X20GP,' ELSE '' END)||(CASE WHEN piece40gp > 0 THEN piece40gp||'X40GP,' ELSE '' END)
				||(CASE WHEN piece40hq > 0 THEN piece40hq||'X40HQ,' ELSE '' END)
				||(CASE WHEN pieceother > 0 THEN pieceother||'X'||COALESCE(cntypeothercode,'')||',' ELSE '' END)AS piececnytype
			,(SELECT nos FROM bpm_processinstance x WHERE x.isdelete = FALSE AND x.refid LIKE '%'||o.id||'%' LIMIT 1) AS bpmnos
  			FROM _bus_order o 
  			WHERE $qry$
  				$filter$
  				$corpfilter$
  				$setDays$
  				$sqlmblno$
  				$sqlcs$
  				$sqlpriceuser$
  				AND isdelete = FALSE
				$ordersql$
			LIMIT $limit$ OFFSET $start$) AS T
	</select>
	<select id="pages.module.order.busorderlistBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _bus_order o 
		WHERE $qry$
			$filter$
			$corpfilter$
			$setDays$
			$sqlmblno$
  			$sqlcs$
  			AND isdelete = FALSE
			
	</select>	
	
	<select id="pages.module.order.busorderlistCheckBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
			SELECT row_number() OVER() AS row,* FROM(
			SELECT 
				o.*
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = o.inputer and x.isdelete = false limit 1),o.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = o.updater and x.isdelete = false limit 1),o.updater) AS updatername
		 	,(select isclc from bus_order where id=o.id) AS isclc
		 	,(select isinvoice from bus_order where id=o.id) AS isinvoice
		 	,(SELECT namec FROM sys_user WHERE isdelete = FALSE AND id = o.priceuserid) priceusernamec
		 	,(SELECT string_agg(roletypedesc||':'||usernamec,',') FROM _sys_user_assign WHERE linkid = o.id) AS cs
		 	,(SELECT mblno FROM bus_shipping x WHERE x.isdelete = FALSE AND x.jobid = o.jobid)||' '||(SELECT string_agg(mblno,',') FROM bus_ship_bill y WHERE y.isdelete = false AND y.jobid = o.jobid) AS mblno
		 	,(select abbr from sys_corporation  WHERE isagent = TRUE AND isdelete = false AND id = o.agentid) AS agenter
  			FROM _bus_order o 
  			WHERE $qry$
  				$filter$
  				$corpfilter$
  				$setDays$
  				$sqlmblno$
  				$sqlcs$
  				AND isdelete = FALSE
			ORDER BY orderdate DESC ,salesid , orderno DESC
			LIMIT $limit$ OFFSET $start$) AS T
	</select>
	<select id="pages.module.order.busorderlistCheckBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _bus_order o 
		WHERE $qry$
			$filter$
			$corpfilter$
			$setDays$
			$sqlmblno$
  			$sqlcs$
  			AND isdelete = FALSE
			
	</select>	
</sqlMap>
