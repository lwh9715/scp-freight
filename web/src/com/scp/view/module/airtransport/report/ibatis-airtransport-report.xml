<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
	<select id="pages.module.airtransport.report.aircomplexqryBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[
		SELECT row_number() OVER() AS row,* FROM(
		select 
		  *
		  ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		  ,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		  ,(select c.code from sys_corporation c, bus_air b where c.id=b.carrierid AND b.jobid = t.id AND c.isairline  = TRUE) AS carrierid
		  ,(select c.abbr from sys_corporation c, bus_air b where c.id=b.agentid AND b.jobid = t.id AND c.isagent  = TRUE) AS agentid
		  ,(select b.goodsname from sys_corporation c, bus_air b where c.id=b.carrierid AND b.jobid = t.id) AS goodsname
		  ,(CASE WHEN t.statetrace IS NULL THEN NULL ELSE f_sys_getls('userid=$userid$;lskey='||t.statetrace)||'-->'||f_sys_getls('userid=$userid$;lskey=下一步')||':'||COALESCE((SELECT f_sys_getls('userid=$userid$;lskey='||COALESCE(statusc,'')) FROM bus_goodstrack WHERE fkid = t.id AND isfinish = FALSE AND orderno > (SELECT orderno FROM bus_goodstrack WHERE isfinish = TRUE AND fkid = t.id ORDER BY orderno DESC LIMIT 1) ORDER BY orderno, dealdate LIMIT 1),'None') END) statetracenext
		  ,(SELECT putstatus FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS putstatus
		  ,(SELECT flightno1 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS flightno1
		  ,(SELECT flightdate1::DATE FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS flightdate12
		  ,(SELECT arrwmstime::DATE FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS arrwmstime2
		  ,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE id = t.saleid) saleuser
		  ,(SELECT abbr FROM sys_corporation WHERE id = t.corpidop AND isdelete = FALSE) AS opcompany
		  ,(SELECT abbr FROM sys_corporation WHERE id = t.corpid AND isdelete = FALSE) AS company
		  ,(select string_agg(distinct c.goodsname,',') from bus_goods c, bus_air b where c.linkid=b.id AND b.jobid = t.id AND c.isdelete = FALSE AND b.isdelete = FALSE and c.goodsname <> '' and c.goodsname is not null) AS goodsname
		  ,(select taskname from _bpm_task where refid = t.id::text and state <> '3' and state <> '9' ORDER BY taskcreatedtime DESC limit 1) taskname
		  ,(select taskcreatedtime from _bpm_task where refid = t.id::text and state <> '3' and state <> '9' ORDER BY taskcreatedtime DESC limit 1) taskcreatedtime
		   ,(SELECT piece3 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS piece3
		   ,(SELECT weight3 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS weight3
		   ,(SELECT volume3 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS volume3
		   ,(select '件数:'||piece2||' '||'重量:'||weight2||' '||'体积:'||volume2||' '||'计费重:'||chargeweight2 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id ) AS accuratedate
		   ,(select '件数:'||piece4||' '||'重量:'||weight4||' '||'体积:'||volume4||' '||'计费重:'||chargeweight4 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id ) AS chudandate
		   ,(SELECT sizeremarks FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS sizeremarks
		   ,(SELECT polcode FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS polcode
		   ,(SELECT podcode FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS podcode
		   ,(SELECT bookingcode FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS bookingcode
		   ,(select taskcreatedtime from _bpm_task where refid = t.id::text and state <> '3' and state <> '9' ORDER BY taskcreatedtime DESC limit 1) taskcreatedtime
		   ,(SELECT airline FROM bus_air WHERE jobid = t.id AND isdelete = FALSE) AS airline
		   ,(select '件数:'||piece3||' '||'重量:'||weight3||' '||'体积:'||volume3 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id ) AS bookingdate
		   ,(SELECT string_agg(l::numeric(18,2)||'*'||w::numeric(18,2)||'*'||h::numeric(18,2)||'/'||piece, f_newline() ORDER BY id) FROM bus_goods WHERE isdelete = false AND status = 'airport' AND linkid = ANY(SELECT t.shipid UNION ALL SELECT id FROM bus_air_bill x WHERE x.busairid = t.shipid))AS datasum
		   ,(SELECT piece2 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS piece2
		   ,(SELECT weight2 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS weight2
		   ,(SELECT volume2 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS volume2
		   ,(SELECT chargeweight2 FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) AS chargeweight2
		   ,(select  string_agg(hawbno||'('||piece||')' , f_newline()) from  bus_air_bill where isdelete = false and jobid = t.id) AS partnumber
		    ,(SELECT d.namec FROM bus_air a, dat_filedata d WHERE jobid = t.id and a.freightstation = d.code and d.isdelete = false and d.fkcode = 290 and d.isleaf = TRUE limit 1) AS freightstation
		FROM _fina_jobs_air t
		WHERE $qry$
			$corpfilter$
			$filter$
			$setDays$
			$dynamicClauseWhere$
		AND t.jobtype = 'A'
		AND $icare$
		AND t.isdelete = FALSE
		$ordersql$
		LIMIT $limit$ OFFSET $start$) AS T
		]]>
	</select>
	
	<select id="pages.module.airtransport.report.aircomplexqryBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _fina_jobs_air t
		WHERE $qry$
			$corpfilter$
			$filter$
			$setDays$
			$dynamicClauseWhere$
		AND $icare$
		AND jobtype = 'A'
	</select>
	
</sqlMap>
