<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
	<select id="pages.module.jobs.jobslinkBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		
		SELECT 
			j.nos AS jobno,j.jobdate::DATE,(SELECT x.abbcode FROM sys_corporation x where x.id = j.corpid) AS corper
		FROM fina_jobs_link k , fina_jobs j
		WHERE 
			j.id = k.jobidto AND j.isdelete = FALSE
			AND k.jobidfm = ANY( SELECT $jobid$ UNION(SELECT jobidto FROM fina_jobs_link WHERE jobidfm = $jobid$))
		ORDER BY jobdate
	</select>
	<select id="pages.module.jobs.jobslinkBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM fina_jobs_link k , fina_jobs j
		WHERE 
			j.id = k.jobidto AND j.isdelete = FALSE
			AND k.jobidfm = ANY( SELECT $jobid$ UNION(SELECT jobidto FROM fina_jobs_link WHERE jobidfm = $jobid$))
	</select>
	
	
	<select id="pages.module.jobs.jobsinfoBean.agentgrid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		
		SELECT 
			*
			,(SELECT sono from bus_shipping where jobid = j.jobid AND isdelete = false) AS sono
			,(SELECT hblno from bus_shipping where jobid = j.jobid AND isdelete = false) AS hblnos
			,(SELECT mblno from bus_shipping where jobid = j.jobid AND isdelete = false) AS mblnos
		FROM _bus_ship_container j
		WHERE
			 parentid IS NULL
			AND isdelete = false
			AND jobid = $jobid$
	</select>
	<select id="pages.module.jobs.jobsinfoBean.agentgrid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  _bus_ship_container j
		WHERE
		 parentid IS NULL
		AND isdelete = false
		AND jobid = $jobid$
	</select>
	
	<select id="pages.module.jobs.jobsinfoBean.cusgrid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		
		SELECT 
			*
			,(SELECT abbr from sys_corporation where id = j.customid AND isdelete = false) AS customider
			,(select namec from dat_filedata where code = j.custype AND isleaf = TRUE AND isdelete = false AND fkcode = 40) AS custypedesc
			,(select namec from dat_filedata where code = j.status AND isleaf = TRUE AND isdelete = false AND fkcode = 100) AS statusdesc
		FROM bus_customs j
		WHERE
			 isdelete = false
			AND jobid = $jobid$
	</select>
	<select id="pages.module.jobs.jobsinfoBean.cusgrid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  bus_customs j
		WHERE
		 isdelete = false
		AND jobid = $jobid$
	</select>
	
	<select id="pages.module.jobs.jobsinfoBean.arapgrid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT DISTINCT id
		,ppcc
		,inputername
		,inputernamee
		,inputercorpor
		,inputerdept
		,updatername
		,updaternamee
		,updatercorpor
		,updaterdept
		,inputer
		,updater
		,arapdate
		,customecode
		,customeabbr
		,feeitemdec
		,currency
		,amount
		,invoiceno
		,billno
		,isconfirm
		,confirmer
		,confirmtime
		,inputtime
		,amtbalence
		,amtrpreq1
		,amtrpreq2
		,string_agg( actpayrecno , f_newline() ORDER BY actpayrecno) AS actpayrecno
		,string_agg( actpayrecdate::TEXT , f_newline() ORDER BY actpayrecno) AS actpayrecdate
		,string_agg( actpayrecinputer, f_newline() ORDER BY actpayrecno) AS actpayrecinputer
		,string_agg( rpdate::TEXT, f_newline() ORDER BY actpayrecno) AS rpdate
		,string_agg( actpayrecupdatetime::TEXT, f_newline() ORDER BY actpayrecno) actpayrecupdatetime
		,string_agg( actpayrecupdater, f_newline() ORDER BY actpayrecno) AS actpayrecupdater
		,string_agg( billtypedesc, f_newline() ORDER BY actpayrecno) AS billtypedesc
		,string_agg( billtype2, f_newline() ORDER BY actpayrecno) AS billtype2
		,string_agg( banker, f_newline() ORDER BY actpayrecno) AS banker
		,string_agg( actsetcode, f_newline() ORDER BY actpayrecno) AS actsetcode
		,string_agg( actsetname, f_newline() ORDER BY actpayrecno) AS actsetname 
		,string_agg( vchtype, f_newline() ORDER BY actpayrecno) AS vchtype
		,string_agg( actyear::TEXT, f_newline() ORDER BY actpayrecno) AS actyear
		,string_agg( actperiod::TEXT, f_newline() ORDER BY actpayrecno) AS actperiod
		,string_agg( actnos, f_newline() ORDER BY actpayrecno) AS actnos
		,string_agg( actsingtime::TEXT, f_newline() ORDER BY actpayrecno) AS actsingtime
		,string_agg( actinputer, f_newline() ORDER BY actpayrecno) AS actinputer
		,string_agg( chequeno, f_newline() ORDER BY actpayrecno) As chequeno
		,string_agg( chequeenddate::TEXT, f_newline() ORDER BY actpayrecno) AS chequeenddate
		,araptype
		,vchactcode
		,vchnos
		,vchyear
		,vchperiod
		,rerepno
		,string_agg( vhcdesc::TEXT, f_newline() ORDER BY actpayrecno) AS vhcdesc 
		,corper
		,payplace
		,confirmerdesc
		,amtstl2ap
		,amtstate
		,invoicedate,rpreqnos
		,invoicetype
		,string_agg( typePR, f_newline() ORDER BY actpayrecno) As typePR
	FROM(SELECT  *
		,COALESCE((CASE WHEN billtype2 IS NULL OR char_length(billtype2::TEXT) = 0 OR rpdate IS NULL OR char_length(rpdate::TEXT) = 0 THEN f_sys_getls('userid='||$userid$||';lskey=未') ELSE f_sys_getls('userid='||$userid$||';lskey=已') END)||(CASE WHEN T.araptype ='AR' THEN f_sys_getls('userid='||$userid$||';lskey=收') WHEN T.araptype ='AP' THEN f_sys_getls('userid='||$userid$||';lskey=付') END),'') AS typePR
		 FROM 
		(SELECT a.id
			,a.ppcc
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.inputer and x.isdelete = false limit 1),a.inputer) AS inputername
			,COALESCE((SELECT x.namee FROM sys_user x where x.code = a.inputer and x.isdelete = false limit 1),a.inputer) AS inputernamee
			,(SELECT COALESCE(x.abbr,'') FROM sys_corporation x WHERE x.iscustomer = false AND x.isdelete = FALSE AND EXISTS (SELECT 1 FROM sys_user y where y.code = a.inputer AND y.corpid = x.id and y.isdelete = false limit 1 )) AS inputercorpor
			,(SELECT COALESCE(x.name,'') FROM sys_department x WHERE x.isdelete = FALSE AND EXISTS (SELECT 1 FROM sys_user y where y.code = a.inputer AND y.deptid = x.id and y.isdelete = false limit 1 )) AS inputerdept
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.updater and x.isdelete = false limit 1),a.updater) AS updatername
			,COALESCE((SELECT x.namee FROM sys_user x where x.code = a.updater and x.isdelete = false limit 1),a.updater) AS updaternamee
			,(SELECT COALESCE(x.abbr,'') FROM sys_corporation x WHERE x.iscustomer = false AND x.isdelete = FALSE AND EXISTS (SELECT 1 FROM sys_user y where y.code = a.updater AND y.corpid = x.id and y.isdelete = false limit 1 )) AS updatercorpor
			,(SELECT COALESCE(x.name,'') FROM sys_department x WHERE x.isdelete = FALSE AND EXISTS (SELECT 1 FROM sys_user y where y.code = a.updater AND y.deptid = x.id and y.isdelete = false limit 1 )) AS updaterdept
			,a.inputer
			,a.updater
			,a.arapdate
			,a.customecode
			,a.customeabbr
			,a.feeitemdec
			,a.currency
			,a.amount
			,a.invoiceno
			,a.billno
			,a.isconfirm
			,a.confirmer
			,a.confirmtime
			,a.inputtime
			,(COALESCE(a.amount,0)-COALESCE(a.amtstl2,0)) AS amtbalence
		    , COALESCE((SELECT SUM(COALESCE(amtreq,0)) FROM fina_rpreqdtl x , fina_rpreq y WHERE x.arapid = a.id AND x.isdelete = FALSE AND x.rpreqid = y.id AND y.reqtype = 'S' AND y.isdelete = FALSE),0) AS amtrpreq1
		    , COALESCE((SELECT SUM(COALESCE(amtreq,0)) FROM fina_rpreqdtl x , fina_rpreq y WHERE x.arapid = a.id AND x.isdelete = FALSE AND x.rpreqid = y.id AND y.reqtype = 'Q' AND y.isdelete = FALSE),0) AS amtrpreq2
		    , COALESCE((SELECT y.actpayrecno FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid),'') AS actpayrecno
		    , COALESCE((SELECT y.actpayrecdate FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid)::TEXT,'') AS actpayrecdate
			, COALESCE((SELECT su.namec FROM sys_user su where su.isdelete = false AND EXISTS(SELECT 1 FROM fina_actpayrec y WHERE su.code = y.inputer AND y.id = rpdt.actpayrecid) limit 1),'') AS actpayrecinputer
		    , COALESCE((SELECT y.rpdate FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid)::TEXT,'') AS rpdate
			, COALESCE((SELECT to_char(y.updatetime,'yyyy-MM-dd HH24:MI') FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid)::TEXT,'') AS actpayrecupdatetime
			, COALESCE((SELECT su.namec FROM sys_user su where su.isdelete = false AND EXISTS(SELECT 1 FROM fina_actpayrec y WHERE su.code=y.updater AND y.id = rpdt.actpayrecid) limit 1 )::TEXT,'') AS actpayrecupdater
		    , COALESCE((SELECT (CASE WHEN y.billtype = 'A' THEN '现金' WHEN y.billtype = 'B' THEN '银行存款' WHEN y.billtype = 'C' THEN '支票' WHEN y.billtype = 'D' THEN '对冲' WHEN y.billtype = 'Z' THEN '其他' END) FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid),'') AS billtypedesc
			, COALESCE((SELECT billtype FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid),'') AS billtype2
			, COALESCE((SELECT string_agg(DISTINCT t.namec,',') FROM dat_bank t , fina_actpayrec_sum y WHERE y.actpayrecid = rpdt.actpayrecid AND y.bankid = t.id AND t.isdelete = FALSE AND rpdt.currencyto = y.cyid),'') AS banker
		  	, COALESCE((SELECT t.code FROM fs_actset t , fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.actsetid = t.id AND t.isdelete = FALSE AND xx.isdelete = FALSE LIMIT 1),'') AS actsetcode
		  	, COALESCE((SELECT t.name FROM fs_actset t , fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.actsetid = t.id AND t.isdelete = FALSE AND xx.isdelete = FALSE LIMIT 1),'') AS actsetname 
		  	, COALESCE((SELECT t.name FROM fs_vchtype t , fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.vchtypeid = t.id AND t.isdelete = FALSE AND xx.isdelete = FALSE  LIMIT 1),'') AS vchtype
		  	, COALESCE((SELECT xx.year FROM fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.isdelete = FALSE LIMIT 1)::TEXT,'') AS actyear
		  	, COALESCE((SELECT xx.period FROM fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.isdelete = FALSE LIMIT 1)::text,'') AS actperiod
		  	, COALESCE((SELECT xx.nos FROM fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.isdelete = FALSE LIMIT 1),'') AS actnos
		   	, COALESCE((SELECT xx.singtime FROM fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.isdelete = FALSE LIMIT 1)::TEXT,'') AS actsingtime
		 	, COALESCE((SELECT xx.inputer FROM fs_vch xx WHERE xx.srcid = rpdt.actpayrecid AND xx.isdelete = FALSE LIMIT 1),'') AS actinputer
			, COALESCE((SELECT y.chequeno FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid),'') As chequeno
			, COALESCE((SELECT y.chequeenddate FROM fina_actpayrec y WHERE y.id = rpdt.actpayrecid)::text,'') As chequeenddate
			, (CASE WHEN a.araptype = 'AP' THEN (-f_amtto_glp(a.jobdate::DATE,a.currency,a.amount)) ELSE (f_amtto_glp(a.jobdate::DATE,rpdt.currencyto,rpdt.amountrp)) END) AS amountrpto
			, a.araptype
			, (SELECT act.code FROM fs_vchdtl vch , fs_actset act WHERE vch.id = a.vchdtlid AND act.id = vch.actsetid LIMIT 1) AS vchactcode
			, (SELECT vch.nos FROM _fs_vchdtl vch WHERE vch.id = a.vchdtlid LIMIT 1) AS vchnos
			, (SELECT vch.year FROM _fs_vchdtl vch WHERE vch.id = a.vchdtlid LIMIT 1) AS vchyear
			, (SELECT vch.period FROM _fs_vchdtl vch WHERE vch.id = a.vchdtlid LIMIT 1) AS vchperiod
			, (SELECT string_agg(xx.nos,',') FROM fina_rpreq xx , fina_rpreqdtl yy WHERE xx.id = yy.rpreqid  AND  yy.arapid = a.id AND xx.isdelete = false and yy.isdelete = false) AS rerepno
			,COALESCE((SELECT string_agg(COALESCE((SELECT string_agg(DISTINCT ''||year||period || (SELECT t.name FROM fs_vchtype t WHERE xs.vchtypeid = t.id AND t.isdelete = FALSE) || xs.nos::text, ','::text) AS string_agg FROM fs_vch xs WHERE xs.actsetid > 0 AND xs.srcid = rpdt.actpayrecid AND xs.isdelete = false),'')||'-'||COALESCE(vx.name,'')||'-'||COALESCE(v.year,0)||'-'||COALESCE(v.period,0)||'-'||COALESCE(v.nos,'')||'['||(SELECT COALESCE(x.namec,'') FROM sys_user x where x.code = v.inputer and x.isdelete = false limit 1)||'-'||to_char(v.inputtime, 'yyyy-MM-dd HH:mm')||']'
						,'') FROM fs_vch v,fs_actset vx WHERE vx.id = v.actsetid AND vx.istart = TRUE AND vx.isdelete = FALSE AND v.srcid = rpdt.actpayrecid AND v.isdelete = FALSE
						),'') AS vhcdesc
			,(SELECT COALESCE(x.abbcode,'') FROM sys_corporation x WHERE x.id = a.corpid) AS corper
			,(SELECT x.payplace FROM fina_arap x WHERE x.id = a.id LIMIT 1) AS payplace
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.confirmer and x.isdelete = false limit 1),a.confirmer) AS confirmerdesc
			,(SELECT CASE WHEN a.araptype = 'AP' AND f_checkright('HideAPAmtstlShow',$userid$) > 0 THEN NULL ELSE a.amtstl2 END) as amtstl2ap
			,(SELECT CASE WHEN a.araptype = 'AP' AND f_checkright('HideAPAmtstlShow',$userid$) > 0 THEN NULL ELSE (CASE WHEN a.isfinish2 = TRUE THEN f_sys_getls('userid='||$userid$||';lskey=已销') WHEN (a.isfinish2 = FALSE AND a.amtstl2 = 0) THEN f_sys_getls('userid='||$userid$||';lskey=未销') WHEN (a.isfinish2 = FALSE AND a.amtstl2 > 0) THEN f_sys_getls('userid='||$userid$||';lskey=部分') END) END) as amtstate
			,(SELECT invoicedate FROM fina_invoice WHERE id = a.invoiceid LIMIT 1) AS invoicedate
			,(SELECT invoicetype FROM fina_invoice WHERE id = a.invoiceid LIMIT 1) AS invoicetype
			,(SELECT String_agg(nos,';') FROM fina_rpreq x WHERE EXISTS(SELECT 1 FROM fina_rpreqdtl WHERE rpreqid = x.id AND arapid = a.id)) AS rpreqnos
		FROM _fina_arap a LEFT JOIN fina_actpayrecdtl rpdt ON(a.id = rpdt.arapid AND rpdt.isdelete = FALSE AND rpdt.amountwf != 0)
		where 
			a.jobid = ANY (
							SELECT id FROM fina_jobs WHERE isdelete = FALSE AND id = $jobid$ 
							UNION
							SELECT id FROM fina_jobs WHERE isdelete = FALSE AND parentid = $jobid$ 
						)
			AND EXISTS(SELECT 1 FROM f_fina_arap_filter('jobid='||$jobid$||';userid='||$userid$) xx WHERE xx.id = a.id) 
			and a.isdelete = false 
			and a.agenbillid is null) AS T) Q
		GROUP BY id
		,ppcc
		,inputername
		,inputernamee
		,inputercorpor
		,inputerdept
		,updatername
		,updaternamee
		,updatercorpor
		,updaterdept
		,inputer
		,updater
		,arapdate
		,customecode
		,customeabbr
		,feeitemdec
		,currency
		,amount
		,invoiceno
		,billno
		,isconfirm
		,confirmer
		,confirmtime
		,inputtime
		,amtbalence
		,amtrpreq1
		,amtrpreq2
		,araptype
		,vchactcode
		,vchnos
		,vchyear
		,vchperiod
		,rerepno
		,corper
		,payplace
		,confirmerdesc
		,amtstl2ap
		,amtstate
		,invoicedate,rpreqnos
		,invoicetype
		ORDER BY araptype DESC ,ppcc DESC ,  arapdate,id
	</select>
	<select id="pages.module.jobs.jobsinfoBean.arapgrid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 10000 AS counts 
	</select>
	
	<select id="pages.module.jobs.jobsinfoBean.hblgrid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT DISTINCT 
			 t.*  
		FROM f_rpa_fina_jobs_paycheck('userid=$userid$;srctype=JOBINFO;jobid=$jobid$') t , bus_shipping s 
		WHERE t.shipid = s.id
		AND s.jobid = $jobid$
	</select>
	<select id="pages.module.jobs.jobsinfoBean.hblgrid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 1000 AS counts
	</select>
	
	<select id="pages.module.jobs.jobsondeleteBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	select * from(	
		select 
		 * 
		 ,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE id = t.saleid) AS saledesc
		 ,(SELECT code||'/'||namec||'/'||COALESCE((SELECT abbr FROM sys_corporation WHERE id = x.corpid),'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE isdelete = false and code = t.inputer) AS inputer2
		 ,(SELECT code||'/'||namec||'/'||COALESCE((SELECT abbr FROM sys_corporation WHERE id = x.corpid),'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE isdelete = false and code = t.updater) AS updater2
		FROM fina_jobs t ) AS t
		WHERE $qry$
		$filter$
		$corpfilter$
		AND isdelete = true
		ORDER BY updatetime desc,nos 
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.jobs.jobsondeleteBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	select  count(*) AS counts  from(
		select 
		 * 
		 ,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE id = t.saleid) AS saledesc
		 ,(SELECT code||'/'||namec||'/'||COALESCE((SELECT abbr FROM sys_corporation WHERE id = x.corpid),'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE isdelete = false and code = t.inputer) AS inputer2
		 ,(SELECT code||'/'||namec||'/'||COALESCE((SELECT abbr FROM sys_corporation WHERE id = x.corpid),'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE isdelete = false and code = t.updater) AS updater2
		FROM fina_jobs t ) AS t
		WHERE $qry$
		$filter$
		$corpfilter$
		AND isdelete = true
	</select>
	
	<select id="pages.module.jobs.jobsAllBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		<!--工作单号，工作单日期，业务员，参考号，委托人中文名，业务员，MBL HBL ，SO ，箱号 ，装箱，进出口，收款状态，付款状态，发票状态，发货人，收货人，通知人，目的港代理 工作单类型（jobtype），-->
		SELECT row_number() OVER() AS row,* FROM( 
		WITH rc_jobs AS (SELECT id,nos,jobdate,inputtime
		,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE id = t.saleid) AS saledesc
		,t.refno
		,(SELECT (CASE WHEN COALESCE(namec,'') = '' THEN namee ELSE namec END) FROM sys_corporation WHERE id = t.customerid) AS customernamec
		,t.ldtype
		,t.tradeway
		,t.impexp
		,(SELECT COALESCE(d.namee,d.namec) FROM dat_filedata AS d WHERE d.isleaf = TRUE AND d.isdelete = false AND d.fkcode = 170 AND d.code = t.impexp LIMIT 1) AS impexpv
		,t.arstatus
		,t.apstatus
		,t.invstatus
		,t.jobtype
		,(CASE  t.jobtype WHEN 'S' THEN '海运' WHEN 'A' THEN '空运' WHEN 'L' THEN '陆运' WHEN 'C' THEN '报关' WHEN 'H' THEN '铁运' END) AS jobtypev
		,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		,inputtime
		,updatetime
		,(SELECT (CASE WHEN COALESCE(abbr,'') = '' THEN namec ELSE abbr END) FROM sys_corporation WHERE id = t.customerid) AS customerabbr
		,(SELECT abbr FROM sys_corporation WHERE id = t.corpidop AND isdelete = FALSE) AS opcompany
		,(SELECT abbr FROM sys_corporation WHERE id = t.corpid AND isdelete = FALSE) AS company
		,(SELECT f_fina_jobs_cnts('jobid='::text||t.id)) AS cnts
		FROM fina_jobs t
		WHERE $qry$
			$filter$
			$corpfilter$
			$dynamicClauseWhere$
			AND isdelete = FALSE
			$ordersql$
		)
		SELECT
				a.*
				,b.mblno
				,b.hblno
				,b.sono
				,(SELECT string_agg(cntno,',') FROM bus_ship_container WHERE isdelete = FALSE AND parentid IS NULL AND jobid = a.id) AS cntnos
				,b.cnortitle
				,b.cneetitle
				,b.notifytitle
				,(SELECT abbr FROM sys_corporation WHERE id = b.agenid) AS agenabbr
				,b.etd
				,b.eta
				,b.cls
		FROM rc_jobs a,bus_shipping b
		WHERE b.isdelete = FALSE AND a.id = b.jobid AND jobtype = 'S'
		UNION ALL
		SELECT
				a.*
				,b.mawbno AS mblno
				,b.hawbno AS hblno
				,b.sono
				,(SELECT string_agg(cntno,',') FROM bus_ship_container WHERE isdelete = FALSE AND parentid IS NULL AND jobid = a.id) AS cntnos
				,b.cnortitle
				,b.cneetitle
				,b.notifytitle
				,(SELECT abbr FROM sys_corporation WHERE id = b.agentdesid) AS agenabbr
				,b.flightdate1::DATE AS etd
				,b.eta
				,NULL AS cls
		FROM rc_jobs a,bus_air b
		WHERE b.isdelete = FALSE AND a.id = b.jobid AND jobtype = 'A'
		UNION ALL
		SELECT
				a.*
				,'' AS mblno
				,'' AS hblno
				,b.sono
				,(SELECT string_agg(cntno,',') FROM bus_ship_container WHERE isdelete = FALSE AND parentid IS NULL AND jobid = a.id) AS cntnos
				,'' AS cnortitle
				,'' AS cneetitle
				,'' AS notifytitle
				,'' AS agenabbr
				,b.etd
				,NULL AS eta
				,b.cls
		FROM rc_jobs a,bus_truck b
		WHERE b.isdelete = FALSE AND a.id = b.jobid AND jobtype = 'L'
		UNION ALL
		SELECT
				a.*
				,b.mblno AS mblno
				,b.hblno AS hblno
				,b.sono
				,(SELECT string_agg(cntno,',') FROM bus_ship_container WHERE isdelete = FALSE AND parentid IS NULL AND jobid = a.id) AS cntnos
				,b.cnortitle AS cnortitle
				,b.cneetitle AS cneetitle
				,b.notifytitle AS notifytitle
				,'' AS agenabbr
				,b.etd
				,b.eta AS eta
				,b.cls
		FROM rc_jobs a,bus_train b
		WHERE b.isdelete = FALSE AND a.id = b.jobid AND jobtype = 'H'
		UNION ALL
		SELECT
				a.*
				,'' AS mblno
				,'' AS hblno
				,b.sono
				,(SELECT string_agg(cntno,',') FROM bus_ship_container WHERE isdelete = FALSE AND parentid IS NULL AND jobid = a.id) AS cntnos
				,'' AS cnortitle
				,'' AS cneetitle
				,'' AS notifytitle
				,'' AS agenabbr
				,NULL AS etd
				,NULL AS eta
				,NULL AS cls
		FROM rc_jobs a LEFT JOIN bus_customs b ON(b.isdelete = FALSE AND a.id = b.jobid )
		WHERE jobtype = 'C' ) AS T
		
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.jobs.jobsAllBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			count(*) AS counts 
		FROM fina_jobs t 
		WHERE $qry$
			$filter$
			$corpfilter$
			$dynamicClauseWhere$
			AND isdelete = FALSE
	</select>
</sqlMap>
