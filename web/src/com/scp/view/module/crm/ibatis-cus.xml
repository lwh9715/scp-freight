<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
	<select id="pages.module.crm.clientmgrBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		   id
		 ,isjoin
		 ,joiniddesc
		 ,joinid
		 ,jointype
		 ,iscarrier
		 ,istruck
		 ,iscustom
		 ,issupplier
		 ,ishipper
		 ,isconsignee
		 ,iswarehouse
		 ,isagent
		 ,isfcl
		 ,isddp
		 ,islcl
		 ,isair
		 ,code
		 ,abbr
		 ,namec
		 ,namee
		 ,level
		 ,salesnamec
		 ,portdesc
		 ,isofficial
		 ,iscustomer
		 ,isairline
		 ,iscooperative
		 ,iscarrier
		 ,isconsignee
		 ,isar
		 ,isap
		 ,isfactory
		 ,inputer
		 ,inputtime
		 ,updater
		 ,updatetime
		 ,corper
		 ,depter
		 ,(SELECT string_agg(x.namec||'/'||x.namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),''),f_newline()) FROM sys_user x WHERE x.isdelete = FALSE AND EXISTS(SELECT 1 FROM sys_user_assign y WHERE y.isdelete = FALSE AND y.linkid=a.id AND linktype='C' AND roletype='S' AND y.userid=x.id)) AS assignsalesnamec
		 ,(SELECT string_agg(x.namec,',') FROM sys_user x , sys_user_assign y WHERE x.isdelete = FALSE AND y.isdelete = FALSE AND y.linkid=a.id AND linktype='C' AND roletype='O' AND y.userid=x.id) AS operationnamec
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.inputer and x.isdelete = false limit 1),a.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.updater and x.isdelete = false limit 1),a.updater) AS updatername
		 ,daysar
		 ,addressc
		 ,addresse
		 ,contact
		 ,tel1
		 ,(select namec from dat_filedata d WHERE d.isleaf = TRUE AND d.isdelete = false AND d.fkcode = 90 AND d.code = a.srctype) AS srctype
		FROM _sys_corporation a  
		WHERE $qry$ 
			$filter$
			$filter2$
			AND isdelete = false
	</select>
	<select id="pages.module.crm.clientmgrBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _sys_corporation a 
		WHERE $qry$ 
			$filter$
			$filter2$
			AND isdelete = false
	</select>
	
	<select id="pages.module.crm.clientcontactinfoBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		  t.* 
		FROM _sys_corpservice t  ,sys_corporation a 
		WHERE $qry$ 
			AND t.customerid = a.id
			AND t.isdelete = false
			AND a.isdelete = false
	</select>
	<select id="pages.module.crm.clientcontactinfoBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _sys_corpservice t  ,sys_corporation a 
		WHERE $qry$ 
			AND t.customerid = a.id
			AND t.isdelete = false
			AND a.isdelete = false
	</select>
	
	<select id="pages.module.crm.clientcontacterBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		  c.* 
		FROM _sys_corpcontacts c  ,sys_corporation a 
		WHERE $qry$ 
			AND c.customerid = a.id
			AND c.isdelete = false
			AND a.isdelete = false
			$filter2$
		ORDER BY contactypedesc2 DESC
	</select>
	<select id="pages.module.crm.clientcontacterBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _sys_corpcontacts c ,sys_corporation a 
		WHERE $qry$ 
			AND c.customerid = a.id
			AND c.isdelete = false
			AND a.isdelete = false
			$filter2$
	</select>
	<select id="pages.module.crm.clientdispatchBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		   id
		 ,isjoin
		 ,joiniddesc
		 ,joinid
		 ,jointype
		 ,iscarrier
		 ,istruck
		 ,iscustom
		 ,issupplier
		 ,ishipper
		 ,isconsignee
		 ,iswarehouse
		 ,isagent
		 ,isfcl
		 ,isddp
		 ,islcl
		 ,isair
		 ,code
		 ,abbr
		 ,namec
		 ,namee
		 ,level
		 ,salesnamec
		 ,portdesc
		 ,isofficial
		 ,iscustomer
		 ,isairline
		 ,iscooperative
		 ,iscarrier
		 ,isconsignee
		 ,isar
		 ,isap
		 ,isfactory
		 ,inputer
		 ,inputtime
		 ,updater
		 ,updatetime
		 ,corper
		 ,depter
		 ,(SELECT string_agg(x.namec||'/'||x.namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),''),f_newline()) FROM sys_user x WHERE x.isdelete = FALSE AND EXISTS(SELECT 1 FROM sys_user_assign y WHERE y.isdelete = FALSE AND y.linkid=a.id AND linktype='C' AND roletype='S' AND y.userid=x.id)) assignsalesnamec
		 ,(SELECT string_agg(x.namec,',') FROM sys_user x , sys_user_assign y WHERE x.isdelete = FALSE AND y.isdelete = FALSE AND y.linkid=a.id AND linktype='C' AND roletype='O' AND y.userid=x.id) operationnamec
		 ,(SELECT string_agg(x.namec,',') FROM sys_user x , sys_user_assign y WHERE x.isdelete = FALSE AND y.isdelete = FALSE AND y.linkid=a.id AND linktype='C' AND roletype='C' AND y.userid=x.id) servicenamec
		 ,(SELECT string_agg(x.namec,',') FROM sys_user x , sys_user_assign y WHERE x.isdelete = FALSE AND y.isdelete = FALSE AND y.linkid=a.id AND linktype='C' AND roletype='D' AND y.userid=x.id) filesnamec
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.inputer and x.isdelete = false limit 1),a.inputer) AS inputername
		 ,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.updater and x.isdelete = false limit 1),a.updater) AS updatername
		FROM _sys_corporation a  
		WHERE $qry$ 
			$filter$
			AND isdelete = false
			AND (salesid IS NOT NULL OR EXISTS(SELECT 1 FROM sys_user_assign x WHERE x.linktype='C' AND x.userid IS NOT NULL AND x.linkid = a.id))
	</select>
	<select id="pages.module.crm.clientdispatchBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _sys_corporation a 
		WHERE $qry$ 
			$filter$
			AND isdelete = false
			AND (salesid IS NOT NULL OR EXISTS(SELECT 1 FROM sys_user_assign x WHERE x.linktype='C' AND x.userid IS NOT NULL AND x.linkid = a.id))
	</select>
	
	
	<select id="pages.module.crm.clientshareBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 *
		 ,substring((select string_agg(nos||'['||sales||']'||':'||jobdate,f_newline() order by jobdate desc) from fina_jobs b where a.id = b.customerid AND b.isdelete = false AND jobdate > now()- INTERVAL '6 month') from 1 for 255) AS salesnos
		 ,(select MAX(b.jobdate) from fina_jobs b where a.id = b.customerid AND b.isdelete = false) AS jobdate
		 ,(select now()::date - MAX(b.jobdate)::date from fina_jobs b where a.id = b.customerid AND b.isdelete = false) AS nojobsdate
		 ,(SELECT string_agg(x.namec||'/'||x.namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),''),f_newline()) FROM sys_user x WHERE x.isdelete = FALSE AND EXISTS(SELECT 1 FROM sys_user_assign y WHERE y.isdelete = FALSE AND y.linkid=a.id AND linktype='C' AND roletype='S' AND y.userid=x.id)) AS assignsalesnamec
		 ,(select string_agg(namec||':'||y.remarks,f_newline()) from sys_user x , sys_user_assign y where x.id = y.userid AND x.isdelete = false AND y.isdelete = false AND y.linkid = a.id AND y.linktype='C' AND y.roletype='S') assignsalesremarks
		FROM sys_corporation a, sys_cust_share s
		WHERE $qry$ 
			$filter2$
			AND a.id = s.customerid
			AND isdelete = false
			ORDER BY a.code
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.crm.clientshareBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM sys_corporation a, sys_cust_share s
		WHERE $qry$ 
			$filter2$
			AND a.id = s.customerid
			AND isdelete = false
	</select>
	
	
	<select id="pages.module.crm.notifyweixinBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 *
		FROM _crm_notify_weixin c
		WHERE $qry$ 
			$filter$
			ORDER BY types DESC, code
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.crm.notifyweixinBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _crm_notify_weixin c
		WHERE $qry$ 
			$filter$
	</select>
	
	<select id="pages.module.crm.notifysmsBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 *
		FROM _crm_notify_sms c
		WHERE $qry$ 
			$filter$
			ORDER BY code
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.crm.notifysmsBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _crm_notify_sms c
		WHERE $qry$ 
			$filter$
	</select>
	
</sqlMap>
