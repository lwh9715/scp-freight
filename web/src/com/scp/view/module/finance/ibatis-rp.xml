<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>

	<select id="pages.module.finance.actpayrecBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.inputer and x.isdelete = false limit 1),a.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.updater and x.isdelete = false limit 1),a.updater) AS updatername
		 	,(CASE WHEN $clientid$ > 0 AND a.clientid != $clientid$ THEN TRUE ELSE FALSE END) AS islink
		FROM _fina_actpayrec a
		WHERE $qry$
			$corpfilter$
			$setDays$
			AND $filter$
			AND a.isdelete = FALSE
		ORDER BY actpayrecdate DESC , a.id
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.actpayrecBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_actpayrec a
		WHERE $qry$
			$corpfilter$
			$setDays$
			AND $filter$
			AND a.isdelete = FALSE
	</select>
	
	<select id="pages.module.finance.prepaidBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.inputer and x.isdelete = false limit 1),a.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = a.updater and x.isdelete = false limit 1),a.updater) AS updatername
		FROM _fina_prepaid a
		WHERE $qry$
			$corpfilter$
			$setDays$
			AND $filter$
			AND a.isdelete = FALSE
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.prepaidBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_prepaid a
		WHERE $qry$
			$corpfilter$
			$setDays$
			AND $filter$
			AND a.isdelete = FALSE
	</select>
	<select id="pages.module.finance.prepaideditBean.grid.rpsum"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			s.id,COALESCE(s.rp,'R') AS rp,c.code AS cyid , s.amt ,s.bankid,s.chequeno,s.chequeenddate
		FROM dat_currency c LEFT JOIN fina_prepaid_sum s ON (c.code = s.cyid AND s.prepaid = $prepaid$)
		WHERE c.isdelete = FALSE
			AND COALESCE(isuseinact,true) = TRUE
			ORDER BY c.code
	</select>


	<!-- ,(CASE WHEN a.xrate != 0 THEN a.xrate ELSE (SELECT x.rate FROM
			dat_exchangerate x , _fina_actpayrec y WHERE x.currencyfm = y.currency
			AND x.currencyto = a.currency AND y.id = $actpayrecid$ AND a.arapdate
			BETWEEN x.datafm AND x.datato) END) AS xrates -->

	<select id="pages.module.finance.actpayreceditBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,amountactrecpay AS amountactrecpay0
			,(CASE WHEN amountactrecpay = 0 THEN TRUE ELSE FALSE END) AS isfinish
			,(SELECT zz.isconfirm FROM fina_arap zz WHERE zz.id = arapid) AS isconfirm
			,COALESCE((SELECT x.namec FROM sys_user x where x.code =
				(SELECT zz.confirmer FROM fina_arap zz WHERE zz.id = arapid) and x.isdelete = false limit 1),(SELECT zz.confirmer FROM fina_arap zz WHERE zz.id = arapid)) AS confirmerdesc
		FROM
			(SELECT
				actpayrecid
				,t.id ||'-0' AS dtlid
				,x.id AS arapid
				,x.customerid
				,x.araptype
				,x.rptype
				,j.id AS jobid
				,j.nos AS jobno
				,(select bc.ponum from bus_commerce bc where bc.jobid = j.id and bc.isdelete = false limit 1) AS ponum
				,x.feeitemdec
				,x.arapdate
				,x.currency
				,(CASE WHEN feetype = 'A' THEN x.amtcost ELSE (x.amount - COALESCE(x.amtcost,0)) END) AS amount
				,(CASE WHEN (SELECT COUNT(1) > 0 FROM fina_actpayrecdtl xx where xx.isdelete = false AND xx.arapid = t.arapid AND xx.amountwf > 0) THEN 0
				  ELSE 
						(CASE WHEN feetype = 'A' THEN x.amtcost - (SELECT sum(xx.amountwf) FROM fina_actpayrecdtl xx where xx.isdelete = false AND xx.arapid = t.arapid AND xx.feetype = 'A') 
							 ELSE (x.amount - (SELECT sum(xx.amountwf) FROM fina_actpayrecdtl xx where xx.isdelete = false AND xx.arapid = t.arapid AND COALESCE(xx.feetype,'') != 'A') ) 
						END)
				  END) AS amountactrecpay
				,currencyto
				,t.xtype AS xtype
				,xrate
				,t.amountrp AS amountrpflag
				,rpdate
				,amountwf
				,billno
				,invoiceno
				,0 AS amountremaindabs
				,x.descinfo As arapdesc
				,x.remarks AS arapremarks
				,arapbranch
				,COALESCE((SELECT xx.corpidlink FROM sys_corporation xx WHERE xx.id = x.corpid and xx.iscustomer = false AND xx.corpidlink IS NOT NULL),x.corpid) AS arapcorpid
				,(SELECT zz.payplace FROM fina_arap zz WHERE zz.id = x.id) AS payplace 
				,x.ppcc
				,x.piece
				,x.price
				,x.customecode
				,j.sales
				,(SELECT xx.name FROM sys_department xx , sys_user yy WHERE yy.deptid = xx.id AND yy.id = j.saleid AND xx.isdelete = FALSE AND yy.isdelete = FALSE) AS salesdpt
				,j.vessel AS ves
				,j.voyage AS voy
				,j.etd AS etd
				,j.eta AS eta
				,j.bargeetd
				,(CASE WHEN COALESCE(x.blno,'') != '' THEN (EXISTS(SELECT 1 FROM fina_jobs_paycheck xx , bus_ship_bill yy  WHERE x.blno = yy.mblno AND yy.jobid = x.jobid AND xx.jobid = yy.id AND xx.ispayagree = TRUE AND yy.isdelete = false)) ELSE j.ispayagree END) AS ispayagree
				,(SELECT zz.abbr FROM sys_corporation zz WHERE zz.id = j.customerid) AS jobscustomerabbr
				,j.jobdate AS jobdate
				,COALESCE((SELECT (CASE WHEN COALESCE(zz.blno,'')='' THEN NULL ELSE zz.blno END) FROM fina_arap zz WHERE zz.id = x.id),j.mblno) AS mblno
				,j.orderno AS orderno
				,replace(j.sono, CHR (10), ',') AS sono
				,(SELECT string_agg(zz.cntno,',') FROM bus_ship_container zz WHERE zz.jobid = x.jobid AND zz.isdelete = FALSE AND zz.parentid IS NULL) AS cntnos
				,100 AS odno
				,j.isconfirm_bus
				,COALESCE(x.amtcost,0) AS amtcost
				,x.inputer AS arapinputer
				,j.refno
				,(CASE WHEN t.feetype = 'A' THEN TRUE ELSE FALSE END) AS isamtcost
				,j.atd AS atd
				,(SELECT string_agg(nos,',') FROM fina_rpreq fx WHERE fx.id = ANY(SELECT fy.rpreqid FROM fina_rpreqdtl fy WHERE fy.arapid = x.id AND fy.isdelete = false) AND fx.isdelete = FALSE)  AS rpreqnos
				,j.opcoper AS opcoper
				,(SELECT i.invoicedate FROM fina_invoice i WHERE i.id = x.invoiceid AND i.isdelete = FALSE LIMIT 1) AS invoicedate
			FROM fina_actpayrecdtl t , _fina_arap x , _fina_jobs_rp j
			WHERE 1=1 AND x.id = t.arapid AND x.jobid = j.id
				AND (CASE WHEN -1 = $actpayrecid$ THEN FALSE ELSE (t.actpayrecid = $actpayrecid$) END)
				AND t.isdelete = false
				AND x.isdelete = false
				AND j.isdelete = false
 				$filter$
 				
			UNION ALL
			<!--提取 a.amtcost = 0 的费用-->
			SELECT
				0 AS actpayrecid
				,a.id ||'-1' AS dtlid
				,a.id AS arapid
				,customerid
				,araptype
				,rptype
				,jobid
				,jobno
				,(select bc.ponum from bus_commerce bc where bc.jobid = a.jobid and bc.isdelete = false limit 1) AS ponum
				,feeitemdec
				,arapdate
				,currency
				,(a.amount - COALESCE(a.amtcost,0)) AS amount
				<!--,(amountremaind2 - a.amtcost) AS amountactrecpay-->
				,COALESCE((a.amount - COALESCE(a.amtcost,0) -COALESCE((SELECT sum(xx.amountwf) FROM fina_actpayrecdtl xx where xx.isdelete = false AND xx.arapid = a.id AND COALESCE(xx.feetype,'') != 'A'),0)
				 ),0) AS amountactrecpay
				,a.currency AS currencyto
				,'' AS xtype
				,0 AS xrate
				,0 AS amountrp
				,NULL AS rpdate
				,0 AS amountwf
				,billno
				,invoiceno
				,amountremaind2 AS amountremaindabs
				,a.descinfo AS arapdesc
				,a.remarks AS arapremarks
				,arapbranch
				,COALESCE((SELECT x.corpidlink FROM sys_corporation x WHERE x.id = a.corpid and x.iscustomer = false AND x.corpidlink IS NOT NULL),a.corpid) AS arapcorpid
				,(SELECT zz.payplace FROM fina_arap zz WHERE zz.id = a.id) AS payplace 
				,ppcc
				,piece
				,price
				,a.customecode
				,(SELECT j.sales FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS sales
				,(SELECT xx.name FROM sys_department xx , sys_user yy WHERE yy.deptid = xx.id AND yy.id = (SELECT j.saleid FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AND xx.isdelete = FALSE AND yy.isdelete = FALSE) AS salesdpt
				,(SELECT j.vessel FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS ves
				,(SELECT j.voyage FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS voy
				,(SELECT j.etd FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS etd
				,(SELECT j.eta FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS eta
				,(SELECT j.bargeetd FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS bargeetd
				,(CASE WHEN COALESCE(a.blno,'') != '' THEN (EXISTS(SELECT 1 FROM fina_jobs_paycheck xx , bus_ship_bill yy  WHERE a.blno = yy.mblno AND yy.jobid = a.jobid AND xx.jobid = yy.id AND xx.ispayagree = TRUE AND yy.isdelete = false) ) 
					ELSE (SELECT j.ispayagree FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE)
					END) AS ispayagree
				,(SELECT zz.abbr FROM sys_corporation zz , fina_jobs j WHERE j.id = a.jobid AND j.isdelete = FALSE AND zz.id = j.customerid) AS jobscustomerabbr
				,(SELECT j.jobdate FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS jobdate
				,COALESCE((SELECT (CASE WHEN COALESCE(zz.blno,'')='' THEN NULL ELSE zz.blno END) FROM fina_arap zz WHERE zz.id = a.id),(SELECT mblno FROM _fina_jobs_rp b WHERE b.id = a.jobid AND b.isdelete = FALSE)) AS mblno
				,(SELECT orderno FROM _fina_jobs_rp b WHERE b.id = a.jobid AND b.isdelete = FALSE) AS orderno
				,(SELECT replace(sono, CHR (10), ',') FROM _fina_jobs_rp b WHERE b.id = a.jobid AND b.isdelete = FALSE) AS sono
				,(SELECT string_agg(zz.cntno,',') FROM bus_ship_container zz WHERE zz.jobid = a.jobid AND zz.isdelete = FALSE AND zz.parentid IS NULL) AS cntnos
				,(CASE WHEN EXISTS(SELECT 1 FROM fina_actpayrecdtl x,fina_arap y where x.actpayrecid = $actpayrecid$ AND x.arapid = y.id AND x.isdelete = false AND y.jobid = a.jobid AND y.isdelete = false) THEN 100 ELSE 0 END) AS odno
				,(SELECT j.isconfirm_bus FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS isconfirm_bus

				,COALESCE(a.amtcost,0) AS amtcost
				,a.inputer AS arapinputer

				,(SELECT j.refno FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS refno
				,false AS isamtcost
				,(SELECT j.atd FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS atd
				,(SELECT string_agg(nos,',') FROM fina_rpreq fx WHERE fx.id = ANY(SELECT fy.rpreqid FROM fina_rpreqdtl fy WHERE fy.arapid = a.id AND fy.isdelete = false) AND fx.isdelete = FALSE)  AS rpreqnos
				,(SELECT j.opcoper FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS opcoper
				,(SELECT x.invoicedate FROM fina_invoice x WHERE x.id = a.invoiceid AND x.isdelete = FALSE LIMIT 1) AS invoicedate
			FROM _fina_arap a
			WHERE a.isfinish2 = FALSE
				AND a.rptype != 'S'
				AND a.rptype != 'O'
				AND (a.amountremaind2 - COALESCE(a.amtcost,0)) != 0
				AND a.isdelete = false
				AND (a.customerid = $customerid$ OR EXISTS(SELECT 1 FROM sys_corporation_join x WHERE x.idto = $customerid$ AND x.idfm = a.customerid) OR EXISTS(SELECT 1 FROM fina_actpayrec_clients x WHERE actpayrecid = $actpayrecid$ AND actpayrecid > 0 AND x.clientid = a.customerid AND x.isdelete = FALSE))
				AND a.jobno IS NOT NULL 
				AND a.jobno != ''
				AND NOT EXISTS(SELECT 1 FROM fina_actpayrecdtl x where x.actpayrecid = $actpayrecid$ AND x.arapid = a.id AND x.isdelete = false AND a.isfinish2 = true)
				<!--AND (CASE WHEN -1 = $actpayrecid$ THEN TRUE ELSE FALSE END)-->
				$filter$
				$corpfilter$
				$hideallarap$
				
			UNION ALL
			<!--提取 a.amtcost != 0 的费用-->
			SELECT
				0 AS actpayrecid
				,a.id ||'-2' AS dtlid
				,a.id AS arapid
				,customerid
				,araptype
				,rptype
				,jobid
				,jobno
				,(select bc.ponum from bus_commerce bc where bc.jobid = a.jobid and bc.isdelete = false limit 1) AS ponum
				,feeitemdec
				,arapdate
				,currency
				,a.amtcost AS amount
				,COALESCE((a.amtcost -COALESCE((SELECT sum(xx.amountwf) FROM fina_actpayrecdtl xx where xx.isdelete = false AND xx.arapid = a.id AND COALESCE(xx.feetype,'') = 'A'),0)
				 ),0) AS amountactrecpay
				,a.currency AS currencyto
				,'' AS xtype
				,0 AS xrate
				,0 AS amountrp
				,NULL AS rpdate
				,0 AS amountwf
				,billno
				,invoiceno
				,amountremaind2 AS amountremaindabs
				,a.descinfo AS arapdesc
				,a.remarks AS arapremarks
				,arapbranch
				,COALESCE((SELECT x.corpidlink FROM sys_corporation x WHERE x.id = a.corpid and x.iscustomer = false AND x.corpidlink IS NOT NULL),a.corpid) AS arapcorpid
				,(SELECT zz.payplace FROM fina_arap zz WHERE zz.id = a.id) AS payplace 
				,ppcc
				,piece
				,price
				,a.customecode
				,(SELECT j.sales FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS sales
				,(SELECT xx.name FROM sys_department xx , sys_user yy WHERE yy.deptid = xx.id AND yy.id = (SELECT j.saleid FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AND xx.isdelete = FALSE AND yy.isdelete = FALSE) AS salesdpt
				,(SELECT j.vessel FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS ves
				,(SELECT j.voyage FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS voy
				,(SELECT j.etd FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS etd
				,(SELECT j.eta FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS eta
				,(SELECT j.bargeetd FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS bargeetd
				,(CASE WHEN COALESCE(a.blno,'') != '' THEN (EXISTS(SELECT 1 FROM fina_jobs_paycheck xx , bus_ship_bill yy  WHERE a.blno = yy.mblno AND yy.jobid = a.jobid AND xx.jobid = yy.id AND xx.ispayagree = TRUE AND yy.isdelete = false) ) 
					ELSE (SELECT j.ispayagree FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE)
					END) AS ispayagree
				,(SELECT zz.abbr FROM sys_corporation zz , fina_jobs j WHERE j.id = a.jobid AND j.isdelete = FALSE AND zz.id = j.customerid) AS jobscustomerabbr
				,(SELECT j.jobdate FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS jobdate
				,COALESCE((SELECT (CASE WHEN COALESCE(zz.blno,'')='' THEN NULL ELSE zz.blno END) FROM fina_arap zz WHERE zz.id = a.id),(SELECT mblno FROM _fina_jobs_rp b WHERE b.id = a.jobid AND b.isdelete = FALSE)) AS mblno
				,(SELECT orderno FROM _fina_jobs_rp b WHERE b.id = a.jobid AND b.isdelete = FALSE) AS orderno
				,(SELECT replace(sono, CHR (10), ',') FROM _fina_jobs_rp b WHERE b.id = a.jobid AND b.isdelete = FALSE) AS sono
				,(SELECT string_agg(zz.cntno,',') FROM bus_ship_container zz WHERE zz.jobid = a.jobid AND zz.isdelete = FALSE AND zz.parentid IS NULL) AS cntnos
				,(CASE WHEN EXISTS(SELECT 1 FROM fina_actpayrecdtl x,fina_arap y where x.actpayrecid = $actpayrecid$ AND x.arapid = y.id AND x.isdelete = false AND y.jobid = a.jobid AND y.isdelete = false) THEN 100 ELSE 0 END) AS odno
				,(SELECT j.isconfirm_bus FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS isconfirm_bus

				,COALESCE(a.amtcost,0) AS amtcost
				,a.inputer AS arapinputer

				,(SELECT j.refno FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS refno
				,true AS isamtcost
				,(SELECT j.atd FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS atd
				,(SELECT string_agg(nos,',') FROM fina_rpreq fx WHERE fx.id = ANY(SELECT fy.rpreqid FROM fina_rpreqdtl fy WHERE fy.arapid = a.id AND fy.isdelete = false) AND fx.isdelete = FALSE)  AS rpreqnos
				,(SELECT j.opcoper FROM _fina_jobs_rp j WHERE j.id = a.jobid AND j.isdelete = FALSE) AS opcoper
				,(SELECT x.invoicedate FROM fina_invoice x WHERE x.id = a.invoiceid AND x.isdelete = FALSE LIMIT 1) AS invoicedate
			FROM _fina_arap a
			WHERE a.isfinish2 = FALSE
				AND COALESCE(a.amtcost,0) != 0 
				AND a.rptype != 'S'
				AND a.rptype != 'O'
				AND a.amountremaind2 != 0
				AND a.isdelete = false
				AND (a.customerid = $customerid$ OR EXISTS(SELECT 1 FROM sys_corporation_join x WHERE x.idto = $customerid$ AND x.idfm = a.customerid) OR EXISTS(SELECT 1 FROM fina_actpayrec_clients x WHERE actpayrecid = $actpayrecid$ AND actpayrecid > 0 AND x.clientid = a.customerid AND x.isdelete = FALSE))
				AND a.jobno IS NOT NULL 
				AND a.jobno != ''
				AND NOT EXISTS(SELECT 1 FROM fina_actpayrecdtl x where x.actpayrecid = $actpayrecid$ AND x.arapid = a.id AND x.isdelete = false AND a.isfinish2 = true)
				<!--AND (CASE WHEN -1 = $actpayrecid$ THEN TRUE ELSE FALSE END)-->
				$filter$
				$corpfilter$
				$hideallarap$
			) As a
		WHERE ($qry$ OR actpayrecid != 0)
			$filter2$
		$orderby$
			
			
	</select>
	<select id="pages.module.finance.actpayreceditBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">

		SELECT
			COUNT(1) AS counts
		FROM
			(SELECT
				actpayrecid
				,t.id AS dtlid
				,customerid
				,araptype
				,jobno
				,feeitemdec
				,arapdate
				,currency
				,amount
				,(SELECT j.jobdate FROM _fina_jobs j , fina_arap x WHERE x.id = t.arapid AND j.id = x.jobid AND j.isdelete = FALSE and x.isdelete = false) AS jobdate
				,(SELECT COALESCE(x.amount,0)-COALESCE(x.amtstl2,0) FROM fina_arap x WHERE
				x.id = t.arapid and x.isdelete = false) AS amountactrecpay
				,currencyto
				,xrate
				,amountrpflag AS amountrpflag
				,rpdate
				,amountwf
				,billno
				,invoiceno
				,0 AS amountremaindabs
				,arapdesc
				,arapremarks
				,arapbranch
				,ppcc
				,piece
				,price
				,t.customercode
			FROM _fina_actpayrecdtl t
			WHERE 1=1
				AND (CASE WHEN -1 = $actpayrecid$ THEN FALSE ELSE (t.actpayrecid = $actpayrecid$)END)
			) As a
		WHERE $qry$ 
			$corpfilter$
	
	</select>

	<select id="pages.module.finance.actpayreceditBean.grid.rate"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
		FROM _dat_exchangerate x
		WHERE x.isdelete=false 
		AND NOW()::DATE BETWEEN datafm AND datato
			$qry$
			$filter$
		ORDER BY (CASE WHEN currencyfm = currencyto THEN 0 ELSE 100 END) , x.currencyfm , x.currencyto
		;
	</select>
	
	<select id="pages.module.finance.actpayreceditBean.grid.rpsum"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			 s.id,s.rp,c.code AS cyid 
			,COALESCE(s.amt,0) AS amt
			,COALESCE(s.amtother,0) AS amtother
			,COALESCE(s.amtrest,0) AS amtrest
			,s.bankid
			,s.chequeno
			,s.chequeenddate
			,COALESCE(s.amtback,0) AS amtback
		FROM dat_currency c LEFT JOIN fina_actpayrec_sum s ON (c.code = s.cyid AND s.actpayrecid = $actpayrecid$)
		WHERE c.isdelete = FALSE
			AND COALESCE(isuseinact,true) = TRUE
			$filter$
		ORDER BY c.ordno
	</select>



	<select id="pages.module.finance.arapeditBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		 <![CDATA[
		SELECT row_number() OVER() AS row,* FROM(
		SELECT
			(t.price+COALESCE((select a.price FROM fina_arap a where a.isdelete = false AND a.parentid = t.id limit 1),0)) AS price,
			(t.amount+COALESCE((select a.amount FROM fina_arap a where a.isdelete = false AND a.parentid = t.id limit 1),0)) AS amount,
			COALESCE((select a.amount FROM fina_arap a where a.isdelete = false AND a.parentid = t.id limit 1),0) AS amtcost,
			(CASE WHEN COALESCE((select a.amount FROM fina_arap a where a.isdelete = false AND a.parentid = t.id limit 1),0) > 0 THEN COALESCE(t.amount,0) ELSE 0 END) AS cost,
			0 AS pricenotax,
			*,
			( (isconfirm IS NOT NULL AND isconfirm = TRUE)
			OR (billid IS NOT NULL AND billid != 0)
			OR (invoiceid IS NOT NULL AND invoiceid != 0)
			OR (amtstl2 IS NOT NULL AND amtstl2 != 0)
			OR EXISTS(SELECT 1 FROM fina_jobs WHERE id = t.jobid AND isdelete =FALSE AND islock=true)
			OR (vchdtlid IS NOT NULL AND vchdtlid != 0)
			OR EXISTS(SELECT 1 FROM fina_arap j WHERE j.jobid = t.jobid AND j.isdelete = false AND j.id = t.fkid AND t.fktbl = 'fina_arap')
			OR EXISTS(SELECT 1 FROM fina_arap j WHERE j.jobid = t.jobid AND j.isdelete = false AND j.fkid = t.id AND j.fktbl = 'fina_arap')
			) AS islock
			,(CASE WHEN (isconfirm IS NOT NULL AND isconfirm = TRUE) THEN '费用确认锁(取消费用确认即可解锁);' ELSE '' END)
			||(CASE WHEN (billid IS NOT NULL AND billid != 0) THEN '生成账单锁(删除账单即可解锁);' ELSE '' END)
			||(CASE WHEN (invoiceid IS NOT NULL AND invoiceid != 0) THEN '已开发票锁(删除发票即可解锁);' ELSE '' END)
			||(CASE WHEN (amtstl2 IS NOT NULL AND amtstl2 != 0) THEN '已销账锁(删除收付款即可解锁);' ELSE '' END)
			||(CASE WHEN EXISTS(SELECT 1 FROM fina_jobs WHERE id = t.jobid AND isdelete =FALSE AND islock=true) THEN '关账锁(工作单取消关账即可解锁);' ELSE '' END)
			||(CASE WHEN (vchdtlid IS NOT NULL AND vchdtlid != 0) THEN '结账锁(不可解锁，只能录入增减费用);' ELSE '' END)
			||(CASE WHEN EXISTS(SELECT 1 FROM fina_arap j WHERE j.jobid = t.jobid AND j.isdelete = false AND j.fkid = t.id AND j.fktbl = 'fina_arap') THEN  '生成往来费用锁(删除往来费用即可解锁);'  ELSE '' END )
			||(CASE WHEN EXISTS(SELECT 1 FROM fina_arap j WHERE j.jobid = t.jobid AND j.isdelete = false AND j.id = t.fkid AND t.fktbl = 'fina_arap') THEN  '往来费用锁(无法修改,可删除);'  ELSE '' END ) AS locktips
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
			,(SELECT COALESCE(x.abbr,'') FROM sys_corporation x WHERE id = t.customerid AND isdelete = FALSE) AS customeabbr
			,(SELECT payplace FROM fina_arap WHERE isdelete = FALSE AND id = t.id) AS payplace
			,(SELECT blno FROM fina_arap WHERE isdelete = FALSE AND id = t.id) AS blno
			,(CASE WHEN f_sys_config('rp2vch_no_rpdate_as_checkfee') = 'Y' THEN 
					COALESCE((SELECT SUM(yy.amountwf) FROM fina_actpayrec xx , fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = t.id AND xx.isdelete = FALSE AND yy.isdelete = FALSE AND xx.rpdate IS NOT NULL),0)
			  ELSE t.amtstl2 END) AS amtstl3
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.confirmer and x.isdelete = false limit 1),t.confirmer) AS confirmerdesc
			,(CASE WHEN EXISTS(SELECT 1 FROM fina_arap j WHERE j.jobid = t.jobid AND j.isdelete = false AND j.id = t.fkid AND t.fktbl = 'fina_arap') THEN  true  ELSE false END ) AS iswlfy
			,(CASE WHEN EXISTS(SELECT 1 FROM fina_arap j WHERE j.jobid = t.jobid AND j.isdelete = false AND j.fkid = t.id AND j.fktbl = 'fina_arap') THEN  true  ELSE false END ) AS isgenwlfy
			,(SELECT invoicedate FROM fina_invoice WHERE id = t.invoiceid LIMIT 1) AS invoicedate
			,(SELECT string_agg(nos,',') FROM fina_rpreq x WHERE x.id = ANY(SELECT y.rpreqid FROM fina_rpreqdtl y WHERE y.arapid = t.id AND y.isdelete = false) AND x.isdelete = FALSE)  AS rpreqnos
			,(SELECT x.year||'-'||x.period FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY(SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = t.vchdtlid LIMIT 1)  LIMIT 1) AS yearperiod
			,(1-t.taxrate) as taxrate2
			, falq.quoteamount
			, falq.quotecurrency
		FROM _fina_arap t
		LEFT JOIN fina_arap_link_quote falq on t.id=falq.arapid
		WHERE $qry$
			AND $jobs$
			AND $isShowJoin$
			AND t.isdelete = FALSE
			AND t.rptype !='H'
			AND t.agenbillid IS NULL
		ORDER BY jobno,araptype desc, ppcc,customerid , currency DESC , feeitemdec  $orderSql$) AS T
		 ]]>
	</select>
	<select id="pages.module.finance.arapeditBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_arap t
		WHERE $qry$
			AND $jobs$
			AND $isShowJoin$
			AND t.isdelete = FALSE
			AND t.rptype !='H'
			AND t.agenbillid IS NULL
	</select>


	<select id="pages.module.finance.billBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			t.id,t.billno,t.billdate,t.clientcode,t.currency,t.inputer,t.inputtime,t.updater,t.updatetime,t.amount,t.isconfirm
		FROM _fina_bill t
		WHERE $qry$
			AND t.isdelete = FALSE
		ORDER BY t.inputtime DESC
	</select>
	<select id="pages.module.finance.billBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_bill t
		WHERE $qry$
			AND t.isdelete = FALSE
	</select>
	
	<select id="pages.module.finance.billdtlBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
		FROM _fina_arap a
		WHERE $qry$
			AND $clause$
		ORDER BY arapdate
	</select>
	<select id="pages.module.finance.billdtlBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_arap a
		WHERE $qry$
			AND $clause$
	</select>
	
	
	<select id="pages.module.finance.invoiceBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,t.editype AS invoicekind
			,(CASE WHEN t.jobid IS NULL THEN (SELECT string_agg(DISTINCT a.nos,',') FROM fina_jobs a,fina_arap b
			WHERE a.id = b.jobid AND t.id = b.invoiceid AND a.isdelete = FALSE AND b.isdelete = FALSE)
			ELSE (SELECT x.nos FROM fina_jobs x WHERE x.isdelete = FALSE AND x.id = t.jobid) END) AS nos
			,(CASE WHEN t.jobid IS NULL THEN '' ELSE (SELECT arstatus FROM fina_jobs WHERE id = t.jobid) END) AS arstatus
			,(SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1) AS inputername
			,(SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1) AS updatername
			,(SELECT d.code FROM dat_account d where d.id = t.accountid and d.isdelete = false limit 1) AS bankcode
			,(SELECT da.abbr FROM dat_account d,dat_bank da where d.bankid = da.id AND d.id = t.accountid AND d.isdelete = false limit 1) AS bankname
			,(select string_agg ( scp.merchantcode, ',' ) from sys_corporation sc inner join sys_corpext scp on sc.id=scp.customerid where sc.isdelete=false and sc.id = t.clientid) AS astmdgcode
		FROM _fina_invoice t
		WHERE $qry$
			$qry3$
			$corpfilter$
			AND t.isdelete = FALSE
		ORDER BY invoicedate DESC , invoiceno
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.invoiceBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_invoice t
		WHERE $qry$
			$corpfilter$
			AND t.isdelete = FALSE
	</select>


	<select id="pages.module.finance.invoicedtlBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
			SELECT * FROM
			(WITH rc_arap AS(
				SELECT
					 a.id
					,a.jobid
					,(CASE WHEN a.invoiceid is not null then true else false end) AS ischoose
					,a.jobno
					,a.jobdate
					,a.araptype
					,a.ppcc
					,a.arapdate
					,a.feeitemdec
					,a.currency
					,a.amount
					,a.piece
					,a.price
					,(CASE WHEN a.invoiceid IS NULL THEN (SELECT x.rate FROM _inv_exchangerate x WHERE x.currencyfm = a.currency AND x.currencyto = $cyto$ AND a.jobdate BETWEEN x.datafm AND x.datato AND x.isdelete = FALSE LIMIT 1) ELSE a.invoicexrate END) AS invoicexrate
					,(CASE WHEN a.invoiceid IS NULL THEN (SELECT x.xtype FROM _inv_exchangerate x WHERE x.currencyfm = a.currency AND x.currencyto = $cyto$ AND a.jobdate BETWEEN x.datafm AND x.datato AND x.isdelete = FALSE LIMIT 1) ELSE a.invoicextype END) AS invoicextype
					,(CASE WHEN a.invoiceid IS NULL THEN f_amtto_inv(a.jobdate::DATE , a.currency , $cyto$ , (CASE WHEN a.araptype = 'AR' THEN amount ELSE -amount END))::NUMERIC(18,2) ELSE a.invoiceamountflag::NUMERIC(18,2) END) AS invoiceamountflag
					,(CASE WHEN EXISTS(SELECT 1 FROM fina_jobs j WHERE j.id = a.jobid AND j.jobtype = 'S') THEN (SELECT string_agg(COALESCE(x.sono,''),',') FROM bus_shipping x WHERE x.isdelete = FALSE AND x.jobid = a.jobid AND x.sono IS NOT NULL AND x.sono &lt;&gt; '') WHEN EXISTS(SELECT 1 FROM fina_jobs j WHERE j.id = a.jobid AND j.jobtype = 'L') THEN  (SELECT string_agg(COALESCE(x.sono,''),',') FROM bus_truck x WHERE x.isdelete = FALSE AND x.jobid = a.jobid AND x.sono IS NOT NULL AND x.sono &lt;&gt; '') ELSE '' END )AS sono
					,a.remarks
					,(SELECT COALESCE(x.abbcode,'') FROM sys_corporation x WHERE x.id = a.corpid) AS corper
					,invoiceid
					,payplace
					,(SELECT refno FROM fina_jobs WHERE id = a.jobid) AS jobrefno
					,(SELECT SUM(COALESCE(x.amountwf,0)) FROM fina_actpayrecdtl x WHERE x.arapid = a.id AND x.isdelete = FALSE AND EXISTS(SELECT 1 FROM fina_actpayrec WHERE id = x.actpayrecid AND actpayrecdate IS NOT NULL)) AS amount_wf
					,a.isamend
					,a.customerid
					,a.amtstl2
					,(SELECT s.atd FROM bus_shipping s WHERE s.jobid = a.jobid) AS atd
					,(SELECT s.etd FROM bus_shipping s WHERE s.jobid = a.jobid) AS etd
					,a.billno
					,(SELECT r.nos FROM fina_rpreq  r , _fina_rpreqdtl d WHERE a.id = d.arapid AND r.id = d.rpreqid limit 1) AS cbillnos
					,(SELECT s.mblno FROM bus_shipping s WHERE s.jobid = a.jobid) AS mblno
					,(1-a.taxrate) as taxrate2
				FROM _fina_arap AS a
				WHERE 1=1
					$corpfilter$
					AND a.isdelete = FALSE
					AND a.jobno IS NOT NULL
					AND a.jobno != ''
					$clause$
					$sonoFilter$
					$sonostr$
					$selectedIdsStr$
					$currencyparame$
					$taxrateparame$
					$permissionsfilter$
					AND isunionfee IS NOT TRUE
			)

			SELECT * FROM rc_arap q
			WHERE TRUE
				$accountfilter$
				$onlyShowwriteoff$

			UNION ALL
			SELECT
				id
				,NULL AS jobid
				,TRUE AS ischoose
				,'' AS jobno
				,NULL AS jobdate
				,araptype
				,NULL AS ppcc
				,NULL AS arapdate
				,feeitemdec
				,currency
				,amount
				,NULL AS piece
				,NULL AS price
				,invoicexrate
				,invoicextype
				,(CASE WHEN araptype = 'AR' THEN invoiceamountflag ELSE -1*invoiceamountflag END)::NUMERIC(18,2) AS invoiceamountflag
				,'' AS sono
				,'' AS remarks
				,'' AS corper
				,invoiceid
				,'' AS payplace
				,'' AS jobrefno
				,0 AS amount_wf
				,NULL AS isamend
				,NULL AS customerid
				,0 AS amtstl2
				,NULL AS atd
				,NULL AS etd
				,NULL AS billno
				,(SELECT r.nos FROM fina_rpreq  r ,_fina_rpreqdtl d WHERE d.arapid=ANY(SELECT a.id FROM fina_invoice_dtl i, _fina_arap a WHERE a.invoiceid = i.invoiceid) AND r.id = d.rpreqid  limit 1) AS cbillnos
				,NULL AS mblno
				,0 as taxrate2
			FROM fina_invoice_dtl AS b
			WHERE 1=1
				$dtlFilter$
		) AS T
		WHERE $qry$
			$jobnostr$
			$jobrefnostr$
			$filterArapType$
			$dynamicClauseWhere$

		ORDER BY T.invoiceid,T.araptype DESC,T.jobdate,T.arapdate
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.invoicedtlBean.grid.count"
			parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT count(*) AS counts FROM
		(

			SELECT * FROM
				(WITH rc_arap AS(
					SELECT
						 a.id
						,a.jobid
						,(CASE WHEN a.invoiceid is not null then true else false end) AS ischoose
						,a.jobno
						,a.jobdate
						,a.araptype
						,a.ppcc
						,a.arapdate
						,a.feeitemdec
						,a.currency
						,a.amount
						,a.piece
						,a.price
						,(CASE WHEN a.invoiceid IS NULL THEN (SELECT x.rate FROM _inv_exchangerate x WHERE x.currencyfm = a.currency AND x.currencyto = $cyto$ AND a.jobdate BETWEEN x.datafm AND x.datato AND x.isdelete = FALSE LIMIT 1) ELSE a.invoicexrate END) AS invoicexrate
						,(CASE WHEN a.invoiceid IS NULL THEN (SELECT x.xtype FROM _inv_exchangerate x WHERE x.currencyfm = a.currency AND x.currencyto = $cyto$ AND a.jobdate BETWEEN x.datafm AND x.datato AND x.isdelete = FALSE LIMIT 1) ELSE a.invoicextype END) AS invoicextype
						,(CASE WHEN a.invoiceid IS NULL THEN f_amtto_inv(a.jobdate::DATE , a.currency , $cyto$ , (CASE WHEN a.araptype = 'AR' THEN amount ELSE -amount END))::NUMERIC(18,2) ELSE a.invoiceamountflag::NUMERIC(18,2) END) AS invoiceamountflag
						,(CASE WHEN EXISTS(SELECT 1 FROM fina_jobs j WHERE j.id = a.jobid AND j.jobtype = 'S') THEN (SELECT string_agg(COALESCE(x.sono,''),',') FROM bus_shipping x WHERE x.isdelete = FALSE AND x.jobid = a.jobid AND x.sono IS NOT NULL AND x.sono &lt;&gt; '') WHEN EXISTS(SELECT 1 FROM fina_jobs j WHERE j.id = a.jobid AND j.jobtype = 'L') THEN  (SELECT string_agg(COALESCE(x.sono,''),',') FROM bus_truck x WHERE x.isdelete = FALSE AND x.jobid = a.jobid AND x.sono IS NOT NULL AND x.sono &lt;&gt; '') ELSE '' END )AS sono
						,a.remarks
						,(SELECT COALESCE(x.abbcode,'') FROM sys_corporation x WHERE x.id = a.corpid) AS corper
						,invoiceid
						,payplace
						,(SELECT refno FROM fina_jobs WHERE id = a.jobid) AS jobrefno
						,(SELECT SUM(COALESCE(x.amountwf,0)) FROM fina_actpayrecdtl x WHERE x.arapid = a.id AND x.isdelete = FALSE AND EXISTS(SELECT 1 FROM fina_actpayrec WHERE id = x.actpayrecid AND actpayrecdate IS NOT NULL)) AS amount_wf
						,a.isamend
						,a.customerid
						,a.amtstl2
						,(SELECT s.atd FROM bus_shipping s WHERE s.jobid = a.jobid) AS atd
						,(SELECT s.etd FROM bus_shipping s WHERE s.jobid = a.jobid) AS etd
						,a.billno
						,(SELECT r.nos FROM fina_rpreq  r , _fina_rpreqdtl d WHERE a.id = d.arapid AND r.id = d.rpreqid limit 1) AS cbillnos
						,(SELECT s.mblno FROM bus_shipping s WHERE s.jobid = a.jobid) AS mblno
						,(1-a.taxrate) as taxrate2
					FROM _fina_arap AS a
					WHERE 1=1
						$corpfilter$
						AND a.isdelete = FALSE
						AND a.jobno IS NOT NULL
						AND a.jobno != ''
						$clause$
						$sonoFilter$
						$sonostr$
						$selectedIdsStr$
						$currencyparame$
						$taxrateparame$
						$permissionsfilter$
						AND isunionfee IS NOT TRUE
				)

				SELECT * FROM rc_arap q
				WHERE TRUE
					$accountfilter$
					$onlyShowwriteoff$

				UNION ALL
				SELECT
					id
					,NULL AS jobid
					,TRUE AS ischoose
					,'' AS jobno
					,NULL AS jobdate
					,araptype
					,NULL AS ppcc
					,NULL AS arapdate
					,feeitemdec
					,currency
					,amount
					,NULL AS piece
					,NULL AS price
					,invoicexrate
					,invoicextype
					,(CASE WHEN araptype = 'AR' THEN invoiceamountflag ELSE -1*invoiceamountflag END)::NUMERIC(18,2) AS invoiceamountflag
					,'' AS sono
					,'' AS remarks
					,'' AS corper
					,invoiceid
					,'' AS payplace
					,'' AS jobrefno
					,0 AS amount_wf
					,NULL AS isamend
					,NULL AS customerid
					,0 AS amtstl2
					,NULL AS atd
					,NULL AS etd
					,NULL AS billno
					,(SELECT r.nos FROM fina_rpreq  r ,_fina_rpreqdtl d WHERE d.arapid=ANY(SELECT a.id FROM fina_invoice_dtl i, _fina_arap a WHERE a.invoiceid = i.invoiceid) AND r.id = d.rpreqid  limit 1) AS cbillnos
					,NULL AS mblno
					,0 as taxrate2
				FROM fina_invoice_dtl AS b
				WHERE 1=1
					$dtlFilter$
			) AS T
			WHERE $qry$
				$jobnostr$
				$jobrefnostr$
				$filterArapType$
				$dynamicClauseWhere$

		) AS TT
	</select>


	<select id="pages.module.finance.actpayreceditBean.grid.vch"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,( SELECT t.name FROM fs_actset t WHERE v.actsetid = t.id AND t.isdelete = false) AS actsetname
			,( SELECT t.name FROM fs_vchtype t WHERE v.vchtypeid = t.id AND t.isdelete = false) AS vchtype
			,false AS iswl
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.inputer and x.isdelete = false limit 1),v.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.updater and x.isdelete = false limit 1),v.updater) AS updatername
		FROM fs_vch v
		WHERE  v.srcid = $srcid$ 
			AND v.srctype = 'R'
			$filter$
		UNION ALL
		SELECT
			*
			,( SELECT t.name FROM fs_actset t WHERE v.actsetid = t.id AND t.isdelete = false) AS actsetname
			,( SELECT t.name FROM fs_vchtype t WHERE v.vchtypeid = t.id AND t.isdelete = false) AS vchtype
			,true AS iswl
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.inputer and x.isdelete = false limit 1),v.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.updater and x.isdelete = false limit 1),v.updater) AS updatername
		FROM fs_vch v
		WHERE  EXISTS(SELECT 1 FROM fs_vch v2 WHERE v.srcid = v2.id AND v2.isdelete = FALSE AND v2.srcid = $srcid$ AND v2.srctype = 'R')
			AND v.srctype = 'W'
			$filter$
			
	</select>


	<select id="pages.module.finance.costmgrBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			* 
		FROM _fina_arap2 a
		WHERE $qry$
		ORDER BY carrier ,vessel,voyage,jobno
		
	</select>
	<select id="pages.module.finance.costmgrBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			count(*) AS counts
		FROM _fina_arap2 a
		WHERE $qry$
	</select>


	<select id="pages.module.finance.costconfirmBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		 SELECT row_number() OVER() AS row,* FROM(
			select
				*
				 ,(CASE WHEN t.tradeway = 'F' THEN 'FOB' WHEN t.tradeway = 'C' THEN 'CIF' WHEN t.tradeway = 'D' THEN 'DDP' WHEN t.tradeway = 'E' THEN 'EXW'
				     WHEN t.tradeway = 'A' THEN 'FCA' WHEN t.tradeway = 'G' THEN 'DDU' WHEN t.tradeway = 'H' THEN 'DAP' END) AS tradeway2
				 ,(SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y
				   WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = (CASE
					WHEN t.jobtype = 'S' THEN (SELECT id FROM bus_shipping WHERE jobid = t.id LIMIT 1)
					WHEN t.jobtype = 'A' THEN (SELECT id FROM bus_air WHERE jobid = t.id LIMIT 1)
							  WHEN t.jobtype = 'L' THEN (SELECT id FROM bus_truck WHERE jobid = t.id LIMIT 1)
							  WHEN t.jobtype = 'R' THEN (SELECT id FROM bus_train WHERE jobid = t.id LIMIT 1)
							  WHEN t.jobtype = 'D' THEN (SELECT id FROM bus_commerce WHERE jobid = t.id LIMIT 1) END)) as csname
				 ,(SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y
					WHERE x.id = y.userid AND y.roletype::text = 'O'::text AND y.linkid = (CASE
							  WHEN t.jobtype = 'S' THEN (SELECT id FROM bus_shipping WHERE jobid = t.id LIMIT 1)
							  WHEN t.jobtype = 'A' THEN (SELECT id FROM bus_air WHERE jobid = t.id LIMIT 1)
							  WHEN t.jobtype = 'L' THEN (SELECT id FROM bus_truck WHERE jobid = t.id LIMIT 1)
							  WHEN t.jobtype = 'R' THEN (SELECT id FROM bus_train WHERE jobid = t.id LIMIT 1)
							  WHEN t.jobtype = 'D' THEN (SELECT id FROM bus_commerce WHERE jobid = t.id LIMIT 1) END)) as opname
				,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
			 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
			 	,(SELECT f_fina_jobs_cntdesc('jobid='::text||t.id)) AS cntdesc
			 	,(SELECT pol FROM bus_shipping WHERE isdelete = FALSE AND jobid = t.id) AS pol
			 	,(SELECT pod FROM bus_shipping WHERE isdelete = FALSE AND jobid = t.id) AS pod
			 	,(CASE WHEN t.jobtype = 'A' THEN (SELECT to_char(singtime,'yyyy-MM-dd')::date FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) WHEN t.jobtype = 'L' THEN (SELECT loadtime FROM bus_truck WHERE isdelete = FALSE AND jobid = t.id) WHEN t.jobtype = 'D' THEN (SELECT etd FROM bus_commerce WHERE isdelete = FALSE AND jobid = t.id) ELSE (SELECT etd FROM bus_shipping WHERE isdelete = FALSE AND jobid = t.id) END) AS etd
			 	,(CASE WHEN t.jobtype = 'A' THEN (SELECT to_char(eta,'yyyy-MM-dd')::date FROM bus_air WHERE isdelete = FALSE AND jobid = t.id) WHEN t.jobtype = 'D' THEN (SELECT eta FROM bus_commerce WHERE isdelete = FALSE AND jobid = t.id) ELSE (SELECT eta FROM bus_shipping WHERE isdelete = FALSE AND jobid = t.id) END) AS eta
			 	,(SELECT contractno FROM bus_shipping WHERE isdelete = FALSE AND jobid = t.id) AS contractno
			 	,(SELECT string_agg(goodsnamedesc,',') FROM _bus_ship_container WHERE isdelete = FALSE AND jobid = t.id) goodsnamedesc
			 	,t.statetrace||'-->下一步:'||COALESCE((SELECT COALESCE(statusc,'') FROM bus_goodstrack WHERE fkid = t.id AND isfinish = FALSE AND orderno > (SELECT orderno FROM bus_goodstrack WHERE isfinish = TRUE AND fkid = t.id ORDER BY orderno DESC LIMIT 1) ORDER BY orderno, dealdate LIMIT 1),'None') statetracenext
			 	,(SELECT x.name FROM sys_department x  WHERE ((x.isdelete = false) AND (x.id = t.deptid))) AS depter2
		 		,(CASE WHEN t.jobtype = 'D' THEN (SELECT nos FROM fina_jobs WHERE id = t.parentid AND isdelete = FALSE LIMIT 1) ELSE t.nos END) AS mnos
		 		,(SELECT namec FROM dat_filedata AS d WHERE d.isleaf = TRUE AND d.isdelete = false AND d.fkcode = 170 AND d.code = t.impexp) AS impexpnamec
			FROM _fina_jobs2 t
			WHERE $qry$
				$filter$
				$jobdatefilter$
				$corpfilter$
				$qryppcc$
				$qrytradeway$
				AND $icare$
				AND $customer$
				AND isdelete = FALSE
			ORDER BY mainnos desc,nos
			LIMIT $limit$ OFFSET $start$
		) Q
	</select>
	<select id="pages.module.finance.costconfirmBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			count(*) AS counts
		FROM _fina_jobs2 t
		WHERE $qry$
				$filter$
				$jobdatefilter$
				$corpfilter$
				$qryppcc$
				$qrytradeway$
				AND (jobtype IN ('S','A','D','L','Z','H') OR (jobtype = 'B' AND parentid IS NOT NULL))
				AND $icare$
				AND $customer$
				AND isdelete = FALSE
	</select>


	<select id="pages.module.finance.busbillBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			*
		FROM _fina_bill t
		WHERE $qry$
			AND isdelete = FALSE
		ORDER BY billno,jobno,hblno
	</select>
	<select id="pages.module.finance.busbillBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			count(*) AS counts
		FROM _fina_bill t
		WHERE $qry$
			AND isdelete = FALSE
	</select>

	<select id="pages.module.finance.report.otherBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			*
		FROM sys_report t
		WHERE $qry$
			AND modcode = 'otherreport'
			AND t.isdelete = FALSE
			ORDER BY id
			
	</select>
	<select id="pages.module.finance.report.otherBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			count(*) AS counts
		FROM sys_report t
		WHERE $qry$
			AND modcode = 'otherreport' 
			AND t.isdelete = FALSE
	</select>

	<select id="pages.module.finance.actpayrecBean.customergrid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			araptype,customerid,customercode,customerabbr,customernamec,customernamee
			,(select scp.merchantcode from sys_corporation sc inner join sys_corpext scp on sc.id=scp.customerid where sc.isdelete=false and sc.code =customercode) AS mdgcustcode
		FROM _fina_actpayrec_search t
		WHERE $qry$
			  $filter$
			group by araptype,customerid,customercode,customerabbr,customernamec,customernamee
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.actpayrecBean.customergrid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			1000 AS counts
	</select>
	
	<select id="pages.module.finance.actpaymoreBean.customergrid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select    
			 c.id AS customerid    
			,COALESCE((CASE WHEN EXISTS (SELECT 1 FROM fina_arap x WHERE x.isdelete = FALSE AND c.id = x.customerid AND x.araptype = 'AR') THEN 'R' ELSE '' END) ,'')
				|| COALESCE((CASE WHEN EXISTS (SELECT 1 FROM fina_arap x WHERE x.isdelete = FALSE AND c.id = x.customerid AND araptype = 'AP') THEN 'P' ELSE '' END) ,'') AS araptype      
			,c.abbr AS customerabbr    
			,c.namec AS customernamec    
			,c.namee AS customernamee   
		FROM sys_corporation c
		WHERE $qry$
			$filter$
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.actpaymoreBean.customergrid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			count(*) AS counts
		FROM sys_corporation c
		WHERE $qry$
			$filter$
	</select>

	<select id="pages.module.finance.actpaysearchBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
		 	,(SELECT bankname FROM sys_corpaccount WHERE isdelete = FALSE AND id = t.accountid)	AS bankname
			,(SELECT code || '/' || abbr FROM sys_corporation WHERE isdelete = FALSE AND id = t.corpid LIMIT 1) AS corpname
		 	,(SELECT accountcont FROM sys_corpaccount WHERE isdelete = FALSE AND id = t.accountid)	AS accountcont
		FROM _fina_actpayrec t
		WHERE $qry$
			$filter$
		LIMIT $limit$ OFFSET $start$
	</select>
	
	<select id="pages.module.finance.actpaysearchBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			count(*) AS counts
		FROM _fina_actpayrec t
		WHERE $qry$
			$filter$
	</select>

	<select id="pages.module.finance.actpayrecBean.arapfeel.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			b.*
			,(SELECT refno FROM fina_jobs WHERE id = b.jobid AND isdelete = FALSE) AS refno
			,(SELECT sales FROM fina_jobs WHERE id = b.jobid AND isdelete = FALSE) AS sales
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = b.inputer and x.isdelete = false limit 1),b.inputer) AS inputername
		 	,COALESCE((SELECT x.namec FROM sys_user x where x.code = b.updater and x.isdelete = false limit 1),b.updater) AS updatername
		 	,(SELECT COALESCE(x.abbr , '') || '/' ||x.code  FROM sys_corporation x WHERE x.id = b.customerid LIMIT 1) AS clientcode
		FROM _fina_arap b LEFT JOIN fina_actpayrecdtl f ON (f.arapid = b.id AND f.isdelete = FALSE) LEFT JOIN fina_actpayrec t ON (t.id = f.actpayrecid AND t.isdelete = FALSE)
		WHERE b.isdelete = FALSE
			AND $qry$;
	</select>
	
	<select id="pages.module.finance.actpayrecBean.arapfeel.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			count(*) AS counts
		FROM _fina_arap b LEFT JOIN fina_actpayrecdtl f ON (f.arapid = b.id AND f.isdelete = FALSE) LEFT JOIN fina_actpayrec t ON (t.id = f.actpayrecid AND t.isdelete = FALSE)
		WHERE b.isdelete = FALSE
			AND $qry$;
	</select>

	<select id="pages.module.finance.actpaymoreBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			* 
		FROM _fina_actpayrec_clients t 
		WHERE $qry$
			AND isdelete = FALSE
	</select>
	<select id="pages.module.finance.actpaymoreBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			COUNT(*) AS counts
		FROM _fina_actpayrec_clients t 
		WHERE $qry$
			AND isdelete = FALSE
	</select>
	
	
	<select id="pages.module.finance.arapeditunionBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*,
			( (isconfirm IS NOT NULL AND isconfirm = TRUE)
			OR (fmsdcno IS NOT NULL AND fmsdcno != '')
			OR (fmsinvno IS NOT NULL AND fmsinvno != '')
			OR (billid IS NOT NULL AND billid != 0)
			OR (invoiceid IS NOT NULL AND invoiceid != 0)
			OR (amtstl IS NOT NULL AND amtstl != 0)
			OR (amtstl2 IS NOT NULL AND amtstl2 != 0)
			OR EXISTS(SELECT 1 FROM fina_jobs WHERE id = t.jobid AND isdelete =
			FALSE AND islock=true)
			OR EXISTS(SELECT 1 FROM fs_vch WHERE srcid = t.jobid AND isdelete =
			FALSE)
			) AS islock
			,(SELECT COALESCE(x.abbcode,'') FROM sys_corporation
			x WHERE x.id = t.corpid) AS corper
			,(SELECT COALESCE(x.abbcode,'') FROM sys_corporation
			x WHERE x.id = t.corpid2) AS corper2
			,COALESCE((SELECT SUM(COALESCE(amtreq,0)) FROM fina_rpreqdtl x , fina_rpreq y WHERE x.arapid = t.id AND x.isdelete = FALSE AND x.rpreqid = y.id AND y.reqtype = 'S' AND y.isdelete = FALSE),0) AS amtrpreq1
		FROM _fina_arap t
		WHERE $qry$
			AND $jobs$
			AND $isShowJoin$
			AND t.isdelete = FALSE
			AND t.rptype !='H'
			AND t.agenbillid IS NULL
		ORDER BY jobno,araptype , customerid , feeitemid , currency
	</select>
	<select id="pages.module.finance.arapeditunionBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_arap t
		WHERE $qry$
			AND $jobs$
			AND $isShowJoin$
			AND t.isdelete = FALSE
			AND t.rptype !='H'
			AND t.agenbillid IS NULL
	</select>
	
	
	<select id="pages.module.finance.paycheckBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT row_number() OVER() AS row,* FROM(
		SELECT
			b.id,
			b.araptype,
			b.customecode,
			b.feeitemdec,
			b.currency,
			b.amount,
			b.amtstl2,
			b.remarks,
			t.actpayrecno,
			b.arapdate,
			b.rptype,
			(SELECT COALESCE(x.abbr,'') FROM sys_corporation x WHERE id = b.customerid AND isdelete = FALSE) AS customeabbr,
			(b.amount - b.amtstl2) AS aroverage,
			t.rpdate,
			t.notesdesc,
			t.billtype
		FROM _fina_arap b LEFT JOIN fina_actpayrecdtl f ON (f.arapid = b.id AND f.isdelete = FALSE) LEFT JOIN fina_actpayrec t ON (t.id = f.actpayrecid AND t.isdelete = FALSE)
		WHERE $qry$
			AND $isShowJoin$
			AND $filter$
			AND b.isdelete = FALSE
			AND b.rptype !='H'
			AND b.agenbillid IS NULL
		ORDER BY jobno,b.araptype desc, b.ppcc,b.customerid , b.currency DESC , b.feeitemdec) AS T
	</select>
	<select id="pages.module.finance.paycheckBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_arap b LEFT JOIN fina_actpayrecdtl f ON (f.arapid = b.id AND f.isdelete = FALSE) LEFT JOIN fina_actpayrec t ON (t.id = f.actpayrecid AND t.isdelete = FALSE)
		WHERE $qry$
			AND $isShowJoin$
			AND $filter$
			AND b.isdelete = FALSE
			AND b.rptype !='H'
			AND b.agenbillid IS NULL
	</select>
	
	<select id="pages.module.finance.paycheckdtlBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			b.id
			,b.cntno
			,b.cntypeid
			,(select t.hblno from bus_shipping t where t.jobid = b.jobid) AS hblno
			,(select t.mblno from bus_shipping t where t.jobid = b.jobid) AS mblno
		FROM _bus_ship_container b
		WHERE $qry$
			AND b.jobid = $jobid$
			AND b.isdelete = FALSE
			AND b.parentid is null
	
	</select>
	<select id="pages.module.finance.paycheckdtlBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _bus_ship_container b
		WHERE $qry$
			AND b.jobid = $jobid$
			AND b.isdelete = FALSE
			AND b.parentid is null
	</select>
	
	
	<select id="pages.module.finance.apcomparebillBean.grid.page"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT row_number() OVER() AS row,* FROM(
		SELECT
			*,
			( (isconfirm IS NOT NULL AND isconfirm = TRUE)
			OR (billid IS NOT NULL AND billid != 0)
			OR (invoiceid IS NOT NULL AND invoiceid != 0)
			OR (amtstl2 IS NOT NULL AND amtstl2 != 0)
			OR EXISTS(SELECT 1 FROM fina_jobs WHERE id = t.jobid AND isdelete =
			FALSE AND islock=true)
			OR EXISTS(SELECT 1 FROM fs_vch WHERE srcid = t.jobid AND isdelete =
			FALSE)
			) AS islock
			,(SELECT COALESCE(x.abbcode,'') FROM sys_corporation
			x WHERE x.id = t.corpid) AS corper
			,COALESCE((SELECT SUM(COALESCE(amtreq,0)) FROM fina_rpreqdtl x , fina_rpreq y WHERE x.arapid = t.id AND x.isdelete = FALSE AND x.rpreqid = y.id AND y.reqtype = 'S' AND y.isdelete = FALSE),0) AS amtrpreq1
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.inputer and x.isdelete = false limit 1),t.inputer) AS inputername
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = t.updater and x.isdelete = false limit 1),t.updater) AS updatername
			,(SELECT COALESCE(x.abbr,'') FROM sys_corporation x WHERE id = t.customerid AND isdelete = FALSE) AS customeabbr
			,(SELECT payplace FROM fina_arap WHERE isdelete = FALSE AND id = t.id) AS payplace
			,(SELECT jobtype FROM fina_jobs WHERE t.jobid = id AND isdelete = FALSE LIMIT 1) AS jobtype
			,(SELECT mblno FROM bus_shipping WHERE t.jobid = jobid AND isdelete = FALSE LIMIT 1) AS mblno
		FROM _fina_arap t
		WHERE $qry$
			AND $jobs$
			AND $isShowJoin$
			AND t.isdelete = FALSE
			AND t.rptype !='H'
			AND t.agenbillid IS NULL
		ORDER BY jobno,araptype desc, ppcc,customerid , currency DESC , feeitemdec) AS T
	</select>
	<select id="pages.module.finance.apcomparebillBean.grid.count"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fina_arap t
		WHERE $qry$
			AND $jobs$
			AND $isShowJoin$
			AND t.isdelete = FALSE
			AND t.rptype !='H'
			AND t.agenbillid IS NULL
	</select>
	
	<select id="pages.module.finance.choosefclbyhandBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT *
		 FROM f_rpa_qryfcl_table('$args$') WHERE $filter$ $ord$;
	</select>
	<select id="pages.module.finance.choosefclbyhandBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 10000 AS counts;
	</select>
	
</sqlMap>
