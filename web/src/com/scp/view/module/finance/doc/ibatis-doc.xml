<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>

	
	
	<select id="pages.module.finance.doc.inBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			   v.*
			  ,srctype AS srctypedesc
			  ,(CASE WHEN COALESCE(srctype,'')='' THEN TRUE ELSE FALSE END) AS isgenvch
			  ,srcno
			  ,(CASE WHEN v.srctype = 'S' THEN CAST((SELECT x.nos FROM fs_vch x WHERE x.id = v.srcid AND x.isdelete = FALSE) AS INTEGER) ELSE CAST(v.nos AS INTEGER) END) AS orderno
			  ,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.inputer and x.isdelete = false limit 1),v.inputer) AS inputername
		  	  ,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.updater and x.isdelete = false limit 1),v.updater) AS updatername
			  ,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.checkter and x.isdelete = false limit 1),v.checkter) AS checktername
		FROM _fs_vch_main v
		WHERE $qry$
			AND v.isdelete = FALSE
			AND COALESCE(v.srctype,'') != 'I' 
		ORDER BY v.period,orderno,v.nos
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.doc.inBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vch_main v
		WHERE $qry$
			AND v.isdelete = FALSE
			AND COALESCE(v.srctype,'') != 'I' 
	</select>
	
	<select id="pages.module.finance.doc.checkBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			   v.*
			  ,srctype AS srctypedesc
			  ,(CASE WHEN COALESCE(srctype,'')='' THEN TRUE ELSE FALSE END) AS isgenvch
			  ,(CASE COALESCE(srctype,'') WHEN 'R' THEN (SELECT x.actpayrecno FROM fina_actpayrec x WHERE x.id = v.srcid AND x.isdelete = FALSE) 
			  	WHEN 'A' THEN (SELECT x.nos FROM fina_jobs x WHERE x.id=v.srcid AND x.isdelete = FALSE) 
			  	WHEN 'S'  THEN (SELECT x.nos FROM fs_vch x WHERE x.id=v.srcid AND x.isdelete = FALSE)
			  	WHEN 'J' THEN (SELECT x.nos FROM fina_jobs x WHERE x.id=v.srcid AND x.isdelete = FALSE) 
			  	 END) AS srcno
			  ,(CASE WHEN v.srctype = 'S' THEN CAST((SELECT x.nos FROM fs_vch x WHERE x.id = v.srcid AND x.isdelete = FALSE) AS INTEGER) ELSE CAST(v.nos AS INTEGER) END) AS orderno
			  ,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.checkter and x.isdelete = false limit 1), v.checkter) AS checktername
			  ,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.inputer and x.isdelete = false limit 1),v.inputer) AS inputername
		FROM _fs_vch_main v
		WHERE $qry$
			AND v.isdelete = FALSE
			AND v.srctype != 'I' 
		ORDER BY v.period,orderno,v.nos
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.doc.checkBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vch_main t
		WHERE $qry$
			AND t.isdelete = FALSE
			AND t.srctype != 'I' 
	</select>
	
	<select id="pages.module.finance.doc.indtlBean_Bak.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
		FROM _fs_vchdtl t
		WHERE $qry$
		ORDER BY vdorder,id
	</select>
	<select id="pages.module.finance.doc.indtlBean_Bak.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vchdtl t
		WHERE $qry$
	</select>
	
	
	<select id="pages.module.finance.doc.indtl_readonlyBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
		FROM _fs_vchdtl t
		WHERE $qry$
		ORDER BY vdorder,id
	</select>
	<select id="pages.module.finance.doc.indtl_readonlyBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vchdtl t
		WHERE $qry$
	</select>

	<select id="pages.module.finance.doc.indtl_readonly_sapBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,(SELECT _fa.name FROM _fs_ast _fa WHERE t.astid = _fa.id AND _fa.isdelete = FALSE) AS astidname
			,(SELECT _fa.name FROM _fs_ast _fa WHERE t.astid2 = _fa.id AND _fa.isdelete = FALSE) AS astid2name
			,(SELECT _fa.name FROM _fs_ast _fa WHERE t.astid3 = _fa.id AND _fa.isdelete = FALSE) AS astid3name
			,(SELECT _fa.name FROM _fs_ast _fa WHERE t.astid4 = _fa.id AND _fa.isdelete = FALSE) AS astid4name
		FROM
		 (
			SELECT v.id,
			v.actsetid,
			v.vchid,
			v.actid,
			v.vchdesc,
			v.cyid,
			v.xtype,
			v.xrate,
			v.oamt,
			v.damt,
			v.camt,
			v.vdorder,
			v.refno,
			v.srctype,
			v.isautogen,
			v.corpid,
			v.isdelete,
			v.inputer,
			v.inputtime,
			v.updater,
			v.updatetime,
			v.astid,
			v.astid2,
			v.astid3,
			v.astid4,
			v.srcid,
			v.linkactsetid,
			CASE
			WHEN (v.damt &lt;&gt; (0)::numeric) THEN v.oamt
			ELSE (0)::numeric
			END AS odamt,
			CASE
			WHEN (v.camt &lt;&gt; (0)::numeric) THEN v.oamt
			ELSE (0)::numeric
			END AS ocamt,
			h.year,
			h.period,
			( SELECT x.code
			FROM fs_act x
			WHERE ((x.id = v.actid) AND (x.isdelete = false))) AS actcode,
			f_fs_vchdtl_getactdesc(('id='::text || v.id)) AS actdesc,
			h.singtime AS vchdate,
			( SELECT t.name
			FROM fs_vchtype t
			WHERE ((h.vchtypeid = t.id) AND (t.isdelete = false))) AS vchtype,
			h.nos,
			f_com_str_addline(v.vchdesc, 15) AS vchdescshow
			FROM fs_vchdtl v,
			fs_vch h
			WHERE (((v.isdelete = false) AND (v.vchid = h.id)) AND (h.isdelete = false))
		 )

		 t
		WHERE $qry$
		ORDER BY vdorder,id
	</select>
	<select id="pages.module.finance.doc.indtl_readonly_sapBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vchdtl t
		WHERE $qry$
	</select>

	<select id="pages.module.finance.doc.indtlBean_Bak.gridAst.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			* 
		FROM _fs_ast t 
		WHERE $qry$ 
	</select>
	<select id="pages.module.finance.doc.indtlBean_Bak.gridAst.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			COUNT(*) AS counts
		FROM _fs_ast t 
		WHERE $qry$ 
	</select>
	
	<select id="pages.module.finance.doc.indtlBean_Bak.gridRate.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 * 
		FROM  _fs_xrate t 
		WHERE $qry$ 
		AND isdelete = FALSE
		
	</select>
	<select id="pages.module.finance.doc.indtlBean_Bak.gridRate.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 count(*) AS counts 
		FROM _fs_xrate t 
		WHERE $qry$
		AND isdelete = FALSE 
	</select>
	
	
	<select id="pages.module.finance.doc.indtlBean_Bak.gridAct.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 * 
		FROM  fs_act t 
		WHERE $qry$ 
		AND isdelete = FALSE
	</select>
	<select id="pages.module.finance.doc.indtlBean_Bak.gridAct.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 count(*) AS counts 
		FROM fs_act t 
		WHERE $qry$
		AND isdelete = FALSE
	</select>
	
	<select id="pages.module.finance.doc.indtlBean_Bak.gridVchdesc.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			* 
		FROM fs_vchdesc t
		WHERE $qry$ 
		AND t.isdelete = FALSE
	</select>
	<select id="pages.module.finance.doc.indtlBean_Bak.gridVchdesc.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			COUNT(*) AS counts
		FROM fs_vchdesc t 
		WHERE $qry$ 
		AND t.isdelete = FALSE
	</select>
	
	<select id="pages.module.finance.doc.reportBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
			,srctype as srctypedesc
			,(CASE WHEN v.srctype = 'S' THEN CAST((SELECT x.nos FROM fs_vch x WHERE x.id = v.srcid AND x.isdelete = FALSE) AS INTEGER) ELSE CAST(v.nos AS INTEGER) END) AS orderno
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.inputer and x.isdelete = false limit 1),v.inputer) AS inputername
			,COALESCE((SELECT x.namec FROM sys_user x where x.code = v.singpeople and x.isdelete = false limit 1),v.singpeople) AS singpeoplename
			,f_fs_vchdtl_getactdesc('id='||v.vchdtlid) AS actdesc
			,(SELECT string_agg(DISTINCT x.name,',') FROM fs_ast x WHERE x.id = v.astid) AS astname
			,(SELECT (select  string_agg ( scp.merchantcode, ',' ) from sys_corporation sc inner join sys_corpext scp on sc.id=scp.customerid where sc.isdelete=false and sc.id = (select id from sys_corporation where id = (SELECT refid FROM fs_astref r WHERE r.astid = x.id limit 1) AND isdelete = FALSE limit 1))
				FROM fs_ast x WHERE x.id = v.astid) AS astmdgcode
			,(SELECT string_agg(DISTINCT x.name,',') FROM fs_ast x WHERE x.id = (SELECT astid2 FROM fs_vchdtl WHERE id = v.vchdtlid AND isdelete = FALSE LIMIT 1) AND x.isdelete = FALSE ) AS astname2
			,(SELECT (CASE WHEN jobtype = 'A' THEN 'CIMC010202' WHEN jobtype = 'D' THEN 'CIMC020301' WHEN jobtype = 'H' THEN 'CIMC010301' WHEN jobtype = 'L' THEN 'CIMC010305' WHEN jobtype = 'C' THEN 'CIMC030201' WHEN jobtype = 'S' THEN (SELECT (CASE WHEN COALESCE(b.bltype,'M') = 'H' THEN 'CIMC010103' ELSE 'CIMC010102' END) FROM bus_shipping b WHERE b.isdelete = FALSE AND b.jobid = j.id) ELSE '其他' END) AS procode FROM fina_jobs j WHERE isdelete = FALSE AND id = ANY(SELECT a.jobid FROM fina_arap a WHERE a.isdelete = FALSE AND EXISTS (SELECT 1 FROM fs_vchdtl WHERE isdelete = FALSE AND id = a.vchdtlid AND vchid = v.id)))
			,(SELECT (SELECT d.name FROM sys_department d WHERE d.isdelete = FALSE AND d.id = (SELECT u.deptid FROM sys_user u WHERE u.id = saleid AND isdelete = FALSE LIMIT 1) LIMIT 1) FROM fina_jobs WHERE id = ANY(SELECT a.jobid FROM fina_arap a WHERE a.isdelete = FALSE AND EXISTS (SELECT 1 FROM fs_vchdtl WHERE isdelete = FALSE AND id = a.vchdtlid AND vchid = v.id))) AS dept
		FROM _fs_vch v
		WHERE $qry$
			AND v.srctype != 'I'
		ORDER BY period,orderno,nos
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.doc.reportBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vch t
		WHERE $qry$
			AND t.srctype != 'I'
	</select>
	
	
	<select id="pages.module.finance.doc.autorpBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	SELECT
			*
			,EXISTS (SELECT 1 FROM fs_vch x , fs_actset y WHERE x.actsetid = $actsetid$ AND x.actsetid = y.id AND y.period = x.period AND x.srcid = t.id AND x.isdelete = FALSE) AS currenthave
			,EXISTS (SELECT 1 FROM fs_vch x , fs_actset y WHERE x.actsetid = $actsetid$ AND x.actsetid = y.id AND y.period != x.period AND x.srcid = t.id AND x.isdelete = FALSE) AS otherhave
			,(SELECT string_agg(x.tips,',') FROM fs_vchgen x WHERE  x.actsetid = $actsetid$ AND x.linkid = t.id ) AS tips
			,(SELECT string_agg(y.nos,',') FROM fs_vchgen x , fs_vch y WHERE  x.actsetid = $actsetid$ AND x.linkid = t.id AND x.vchid = y.id AND y.isdelete = FALSE) As vchnos
		FROM _fs_rp t
		WHERE $qry$
			ORDER BY nos
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.doc.autorpBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_rp t
		WHERE $qry$
	</select>
	
	
	<select id="pages.module.finance.doc.autoarapBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
			SELECT a.*,COALESCE(s.returncnttime,t.vgmdate) AS returncnttime,j.isconfirm2_pp,j.isconfirm2_cc 
			FROM f_rpt_fs_getarapvch('actsetid=$actsetid$;startdatestr=$startdatestr$;enddatestr=$enddatestr$;filtertype=$filtertype$;qrydates=$qrydates$;') a 
			LEFT JOIN fina_jobs j ON (j.id = a.jobid AND j.isdelete = FALSE)
			LEFT JOIN bus_shipping s ON (s.jobid = a.jobid AND s.isdelete = FALSE)
			LEFT JOIN bus_train t ON (t.jobid = a.jobid AND t.isdelete = FALSE)
			WHERE $qry$ 
			$confirmppcc$
			$returncnttime$
			LIMIT $limit$ OFFSET $start$;
	</select>
	<select id="pages.module.finance.doc.autoarapBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(DISTINCT idindex) AS counts 
		FROM f_rpt_fs_getarapvch('actsetid=$actsetid$;startdatestr=$startdatestr$;enddatestr=$enddatestr$;filtertype=$filtertype$;qrydates=$qrydates$') a 
			LEFT JOIN fina_jobs j ON (j.id = a.jobid AND j.isdelete = FALSE)
			LEFT JOIN bus_shipping s ON (s.jobid = a.jobid AND s.isdelete = FALSE)
			LEFT JOIN bus_train t ON (t.jobid = a.jobid AND t.isdelete = FALSE)
		WHERE $qry$
			$confirmppcc$
			$returncnttime$
	</select>
	
	
	
	<select id="pages.module.finance.doc.indtlBean.gridAst.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			id ,astypename,code,name,inputer,inputtime,updater,updatetime 
		FROM _fs_ast t 
		WHERE $qry$ 
			$filter1$
		
		UNION ALL
		
		SELECT 
			id,astypename
			,(CASE WHEN astypecode = 'C' THEN code WHEN astypecode = 'D' THEN (SELECT y.code FROM sys_user x , sys_department y , fs_astref z WHERE x.deptid = y.id AND x.id = z.refid AND z.astid = t.id )||'----->'||code END) AS code
			,(CASE WHEN astypecode = 'C' THEN name WHEN astypecode = 'D' THEN (SELECT y.name FROM sys_user x , sys_department y , fs_astref z WHERE x.deptid = y.id AND x.id = z.refid AND z.astid = t.id )||'----->'||name END) AS name
			,inputer,inputtime,updater,updatetime 
		FROM _fs_ast t 
		where $qry$
			$filter2$
			ORDER By code,name
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="pages.module.finance.doc.indtlBean.gridAst.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			COUNT(*) AS counts
		FROM (
				SELECT 
					id ,astypename,code,name,inputer,inputtime,updater,updatetime 
				FROM _fs_ast t 
				WHERE $qry$ 
					$filter1$
				
				UNION ALL
				
				SELECT 
					id,astypename
					,(CASE WHEN astypecode = 'C' THEN code WHEN astypecode = 'D' THEN (SELECT y.code FROM sys_user x , sys_department y , fs_astref z WHERE x.deptid = y.id AND x.id = z.refid AND z.astid = t.id )||'----->'||code END) AS code
					,(CASE WHEN astypecode = 'C' THEN name WHEN astypecode = 'D' THEN (SELECT y.name FROM sys_user x , sys_department y , fs_astref z WHERE x.deptid = y.id AND x.id = z.refid AND z.astid = t.id )||'----->'||name END) AS name
					,inputer,inputtime,updater,updatetime 
				FROM _fs_ast t 
				where $qry$
					$filter2$
			) AS T
	</select>
	
	<select id="pages.module.finance.doc.indtlBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
		FROM _fs_vchdtl t
		WHERE $qry$
		ORDER BY vdorder,id
	</select>
	<select id="pages.module.finance.doc.indtlBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vchdtl t
		WHERE $qry$
	</select>
	<select id="pages.module.finance.doc.indtlBean.gridRate.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 * 
		FROM  _fs_xrate t 
		WHERE $qry$ 
		AND isdelete = FALSE
		
	</select>
	<select id="pages.module.finance.doc.indtlBean.gridRate.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 count(*) AS counts 
		FROM _fs_xrate t 
		WHERE $qry$
		AND isdelete = FALSE 
	</select>
	
	
	<select id="pages.module.finance.doc.indtlBean.gridAct.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 * 
		FROM  fs_act t 
		WHERE $qry$ 
		AND isdelete = FALSE
	</select>
	<select id="pages.module.finance.doc.indtlBean.gridAct.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 count(*) AS counts 
		FROM fs_act t 
		WHERE $qry$
		AND isdelete = FALSE
	</select>
	
	<select id="pages.module.finance.doc.indtlBean.gridVchdesc.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			* 
		FROM fs_vchdesc t 
		WHERE $qry$ 
	</select>
	<select id="pages.module.finance.doc.indtlBean.gridVchdesc.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			COUNT(*) AS counts
		FROM fs_vchdesc t 
		WHERE $qry$ 
	</select>
	
	<!--新增indtl_sapBean-->
	<select id="pages.module.finance.doc.indtl_sapBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			*
		FROM _fs_vchdtl t
		WHERE $qry$
		ORDER BY vdorder,id
	</select>
	<select id="pages.module.finance.doc.indtl_sapBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM _fs_vchdtl t
		WHERE $qry$
	</select>
	<select id="pages.module.finance.doc.indtl_sapBean.gridRate.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 * 
		FROM  _fs_xrate t 
		WHERE $qry$ 
		AND isdelete = FALSE
		
	</select>
	<select id="pages.module.finance.doc.indtl_sapBean.gridRate.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 count(*) AS counts 
		FROM _fs_xrate t 
		WHERE $qry$
		AND isdelete = FALSE 
	</select>
	
	
	<select id="pages.module.finance.doc.indtl_sapBean.gridAct.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 * 
		FROM  fs_act t 
		WHERE $qry$ 
		AND isdelete = FALSE
	</select>
	<select id="pages.module.finance.doc.indtl_sapBean.gridAct.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 count(*) AS counts 
		FROM fs_act t 
		WHERE $qry$
		AND isdelete = FALSE
	</select>
	
	<select id="pages.module.finance.doc.indtl_sapBean.gridVchdesc.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			* 
		FROM fs_vchdesc t 
		WHERE $qry$ 
	</select>
	<select id="pages.module.finance.doc.indtl_sapBean.gridVchdesc.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			COUNT(*) AS counts
		FROM fs_vchdesc t 
		WHERE $qry$ 
	</select>
	<!--新增indtl_sapBean结束-->
</sqlMap>
