<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
    <!--查询工作单列表-->
    <select id="base.commerce.list" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS commercelist
        FROM (SELECT fj.id,
                     fj.parentid,
                     fj.id                                        as        jobid,
                     fj.nos,
                     jobdate,
                     ponum,
                     productname,
                     customerabbr,
                     deliverybl,
                     sonum,
                     fbaref,
                     shipmentid,
                     pkgnum,
                     gw,
                     vol,
                     tweight,
                     chargeweight,
                     vw,
                     bkpkgnum,
                     bkgw,
                     bkvol,
                     mblnum,
                     etd,
                     eta,
                     checksremark,
                     vsl,
                     voy,
                     flight,
                     cargoname,
                     mark,
                     pieces,
                     deliverydate,
                     freightterm,
                     declaretype,
                     refnum,
                     goodsdiscription,
                     pornamec,
                     polnamec,
                     podnamec,
                     destnamec,
                     deliverynamec,
                     remarks,
                     remark,
                     fj.customerid                                as customeraddrid,
                     TO_CHAR(bc.wmsindate, 'yyyy-MM-dd')          AS wmsintime,
                     TO_CHAR(fj.submitime, 'yyyy-MM-dd')          AS submitime,
                     fj.inputer                                   as inputer,
                     TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi')  AS inputtime,
                     fj.sales AS sales,
                     (SELECT x.nos from fina_jobs x where fj.parentid = x.id LIMIT 1) as mblno,
                     (SELECT x.refno from fina_jobs x where fj.parentid = x.id LIMIT 1) as mblrefno,
                     (SELECT t.namec FROM sys_user t WHERE t.id = bc.checkbyid limit 1) as checkbyname,
                     (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1) as corpidname,
                     (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1) as corpidopname,
                     (SELECT t.namec FROM dat_filedata t WHERE fkcode = 1250 and t.code = bc.deliveryway LIMIT 1) AS cdeliveryway,
                     (SELECT statusc from bus_goodstrack where fkid = fj.id AND iscs = true ORDER BY inputtime desc limit 1) as newtrace,
                     (CASE WHEN fj.iscomplete_ar THEN '是' ELSE '否' END) as complete_ar,
                     (CASE WHEN fj.iscomplete_ap THEN '是' ELSE '否' END) as complete_ap,
                     (CASE WHEN bc.checkstatus = 'unapproved' THEN '审核未通过' WHEN bc.checkstatus = 'approved' THEN '审核通过' ELSE '未审核' END) AS checkstatus,
                     (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bc.id and y.isdelete = false) as csname,
                     (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'O'::text AND y.linkid = bc.id and y.isdelete = false) as opname,
                     (CASE WHEN fj.jobtype = 'D' THEN (CASE WHEN fj.ldtype2 = 'H' THEN 'FBA海运' WHEN fj.ldtype2 = 'K' THEN 'FBA空运' WHEN fj.ldtype2 = 'T' THEN 'FBA铁运' WHEN fj.ldtype2 = 'X' THEN '快递专线' WHEN fj.ldtype2 IN ('Z','M') THEN '海运整柜' ELSE '其它' END) END) as cldtype2,
                     (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
                     (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id) THEN '未付款' ELSE '部分付款' END) AS apstatus
                     FROM fina_jobs fj, bus_commerce bc
        WHERE fj.id = bc.jobid
          AND fj.isdelete = FALSE
          AND fj.jobtype = 'D'
          AND fj.parentid IS NOT NULL $qry$ $filter$ $nostype$ $orderby$ LIMIT 1000 OFFSET 0
              ) json;
    </select>
    <!--查询业务统计报表-->
    <select id="base.commerce.business" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS businesslist
        FROM (SELECT *,$newfield$ FROM (
           SELECT fj.id           as id,
                  fj.nos          as nos,
                  fj.jobtype      as jobtype,
                  fj.parentid     as parentid,
                  fj.customerid   as customerid,
                  fj.customerabbr as customerabbr,
                  (SELECT refno FROM fina_jobs WHERE id = fj.parentid AND isdelete = FALSE LIMIT 1) as refno2,
                  (select nos from fina_jobs where id = fj.parentid and isdelete = false LIMIT 1)  as pnos,
                  fj.jobdate as jobdate,
                  TO_CHAR(fj.submitime, 'yyyy-MM-dd') as submitime,
                  to_char(bc.etd, 'YYYY"年"IW"周"') AS year_week,
                  to_char(bc.etd, 'YYYY"年"MM"月"') AS year_month,
                  '' as dotype,
                  '' as cntnum,
                  bc.polnamec as tcpol,
                  bc.podnamec as tcpod,
                  bc.jobid as jobid,
                  TO_CHAR(bc.etd, 'yyyy-MM-dd') as etd,
                  TO_CHAR(bc.eta, 'yyyy-MM-dd') as eta,
                  bc.productname as tcproductname,
                  bc.ponum as ponum,
                  bc.sonum as sonum,
                  fj.inputer AS inputer,
                  TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                  fj.updater AS updater,
                  TO_CHAR(fj.updatetime, 'yyyy-MM-dd hh24:mi') as updatetime,
                  TO_CHAR(bc.wmsindate, 'yyyy-MM-dd hh24:mi') as wmsintime,
                  '' as pickcnttime,
                  '' as returncnttime,
                  fj.remarks as remarks,
                  bc.remark as remark,
                  bc.pkgnum as tcpieces,
                  bc.gw as tcgrswgts,
                  bc.chargeweight as tcchargeweight,
                  bc.vol as tccbms,
                  bc.declaretype as declaretype,
                  (CASE WHEN fj.ldtype = 'F' THEN 'FCL' WHEN fj.ldtype = 'L' THEN 'LCL' END) AS ldtype,
                  '' as isexternalmatching,
                  (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
                  fj.sales AS sales,
                  (CASE WHEN bc.saleidop is null THEN '' ELSE (SELECT namec from sys_user where id = bc.saleidop limit 1) END) AS opsales,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bc.id and y.isdelete = false) as csname,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'O'::text AND y.linkid = bc.id and y.isdelete = false) as opname,
                  (CASE WHEN fj.jobtype = 'D' THEN (CASE WHEN fj.ldtype2 = 'H' THEN 'FBA海运' WHEN fj.ldtype2 = 'K' THEN 'FBA空运' WHEN fj.ldtype2 = 'T' THEN 'FBA铁运' WHEN fj.ldtype2 = 'X' THEN '快递专线' WHEN fj.ldtype2 IN ('Z','M') THEN '海运整柜' ELSE '其它' END) END) as ldtype2,
                  (select name from sys_department where id = (CASE WHEN (fj.corpid = 11540072274 OR fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
                  (select name from sys_department where id = fj.deptop limit 1) as tcdeptop,
                  (CASE WHEN fj.iscomplete THEN '是' ELSE '否' END) as iscomplete,
                  (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
                  (CASE WHEN fj.iscomplete_ar THEN '是' ELSE '否' END) as complete_ar_status,
                  (CASE WHEN fj.iscomplete_ap THEN '是' ELSE '否' END) as complete_ap_status,
                  (CASE WHEN fj.iscomplete_loss THEN '确认亏损' ELSE '' END) as iscomplete_loss,
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$ $financial$) AS arrears,
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $financial$ $arapsql$ $isvirarapsql$ $arbillsql$) AS amountar,
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $arapsql$ $isvirarapsql$) AS amountap,
                  ((SELECT COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$) -
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $isvirarapsql$)):: NUMERIC(18,2) as profitrmb,
                  ((SELECT COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$) -
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $isvirarapsql$)):: NUMERIC(18,2) as profitusd,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id) THEN '未付款' ELSE '部分付款' END) AS apstatus
              FROM fina_jobs fj,
                   bus_commerce bc
              WHERE fj.id = bc.jobid
                AND fj.jobtype = 'D'
                AND fj.isdelete = FALSE $qry$ $filter$ $isinwmsin$ $nostype$ $commercesql$

              UNION ALL

              SELECT fj.id as id,
                  fj.nos as nos,
                  fj.jobtype as jobtype,
                  fj.parentid as parentid,
                  fj.customerid   as customerid,
                  fj.customerabbr as customerabbr,
                  fj.refno2 as refno2,
                  '' as pnos,
                  fj.jobdate as jobdate,
                  TO_CHAR(fj.submitime, 'yyyy-MM-dd') as submitime,
                  to_char(bc.etd, 'YYYY"年"IW"周"') AS year_week,
                  to_char(bc.etd, 'YYYY"年"MM"月"') AS year_month,
                  (SELECT f_bus_shipping_do_type(('shipid='::text || bc.id) || ';'::text) AS f_bus_shipping_do_type) as dotype,
                  (SELECT sum(cnts.cnt) FROM (SELECT count(*)::NUMERIC * (case when left(cntypedesc, 2) = '20' then 1 when left(cntypedesc, 2) = '40' then 2 else 0 end)::NUMERIC AS cnt FROM _bus_ship_container WHERE shipid = bc.id AND isselect = TRUE AND isdelete = FALSE GROUP BY cntypedesc) cnts)::TEXT as cntnum,
                  bc.pol as tcpol,
                  bc.pod as tcpod,
                  bc.jobid as jobid,
                  to_char(bc.etd, 'yyyy-MM-dd') as etd,
                  to_char(bc.eta, 'yyyy-MM-dd') as eta,
                  '' as tcproductname,
                  (CASE when fj.joborderid is null then (SELECT bsc.cntno FROM bus_ship_container bsc WHERE bsc.jobid = fj.id and bsc.isdelete = false limit 1) else fj.refno end) as ponum,
                  bc.sono as sonum,
                  fj.inputer AS inputer,
                  TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                  fj.updater AS updater,
                  TO_CHAR(fj.updatetime, 'yyyy-MM-dd hh24:mi') as updatetime,
                  '' as wmsintime,
                  TO_CHAR(bc.pickcnttime, 'yyyy-MM-dd') as pickcnttime,
                  TO_CHAR(bc.returncnttime, 'yyyy-MM-dd') as returncnttime,
                  fj.remarks as remarks,
                  bc.remark1 as remark,
                  (SELECT SUM (piece) from bus_ship_container where isdelete = false and jobid = fj.id) AS tcpieces,
                  (SELECT SUM (grswgt) from bus_ship_container where isdelete = false and jobid = fj.id) AS tcgrswgts,
                  (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = fj.id) AS tcchargeweight,
                  (SELECT SUM (cbm) from bus_ship_container where isdelete = false and jobid = fj.id) AS tccbms,
                  '' as declaretype,
                  (CASE WHEN fj.ldtype = 'F' THEN 'FCL' WHEN fj.ldtype = 'L' THEN 'LCL' END) AS ldtype,
                  (CASE WHEN isexternalmatching = 'T' THEN '外配' WHEN isexternalmatching = 'F' THEN '自采' END) as isexternalmatching,
                  (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
                  fj.sales as sales,
                  (CASE WHEN deptop = 516228802274 THEN '途C中东操作部' WHEN deptop = 516230252274 THEN '途C北美操作部' WHEN deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS opsales,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bc.id and y.isdelete = false) as csname,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'O'::text AND y.linkid = bc.id and y.isdelete = false) as opname,
                  (CASE WHEN fj.jobtype = 'S' THEN (CASE WHEN EXISTS(SELECT 1 FROM fina_jobs WHERE isdelete = FALSE AND parentid = fj.id LIMIT 1) THEN '海运拼箱' ELSE '海运整柜' END) END) as ldtype2,
                  (SELECT name from sys_department where id = (CASE WHEN (corpid = 11540072274 OR corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
                  (select name from sys_department where id = fj.deptop limit 1) as tcdeptop,
                  (CASE WHEN fj.iscomplete THEN '是' ELSE '否' END) as iscomplete,
                  (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
                  (CASE WHEN fj.iscomplete_ar THEN '是' ELSE '否' END) as complete_ar_status,
                  (CASE WHEN fj.iscomplete_ap THEN '是' ELSE '否' END) as complete_ap_status,
                  (CASE WHEN fj.iscomplete_loss THEN '确认亏损' ELSE '' END) as iscomplete_loss,
                  (SELECT  COALESCE (SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$ $financial$) AS arrears,
                  (SELECT  COALESCE (SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $arapsql$ $isvirarapsql$ $arbillsql$) AS amountar,
                  (SELECT  COALESCE (SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $arapsql$ $isvirarapsql$) AS amountap,
                  ((SELECT COALESCE (SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                  (SELECT  COALESCE (SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitrmb,
                  ((SELECT COALESCE (SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                  (SELECT  COALESCE (SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitusd,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id) THEN '未付款' ELSE '部分付款' END) AS apstatus
              FROM fina_jobs fj,
                   bus_shipping bc
              WHERE fj.id = bc.jobid
                AND fj.jobtype = 'S'
                AND fj.isdelete = FALSE
                AND bc.isdelete = FALSE $qry$ $filter$ $nostype$ $shipsql$

              UNION ALL

              SELECT fj.id as id,
                  fj.nos as nos,
                  fj.jobtype as jobtype,
                  fj.parentid as parentid,
                  fj.customerid  as customerid,
                  fj.customerabbr as customerabbr,
                  fj.refno2 as refno2,
                  '' as pnos,
                  fj.jobdate as jobdate,
                  TO_CHAR(fj.submitime, 'yyyy-MM-dd') as submitime,
                  to_char(bc.singtime, 'YYYY"年"IW"周"') AS year_week,
                  to_char(bc.singtime, 'YYYY"年"MM"月"') AS year_month,
                  '' as dotype,
                  '' as cntnum,
                  bc.pol as tcpol,
                  bc.pod as tcpod,
                  bc.jobid as jobid,
                  to_char(bc.singtime, 'yyyy-MM-dd') as etd,
                  to_char(bc.eta, 'yyyy-MM-dd') as eta,
                  '' as tcproductname,
                  (CASE when fj.joborderid is null then bc.mawbno else fj.refno end) as ponum,
                  bc.sono as sonum,
                  fj.inputer AS inputer,
                  TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                  fj.updater AS updater,
                  TO_CHAR(fj.updatetime, 'yyyy-MM-dd hh24:mi') as updatetime,
                  '' as wmsintime,
                  '' as pickcnttime,
                  '' as returncnttime,
                  fj.remarks as remarks,
                  bc.remarks as remark,
                  (select SUM (piece) from bus_goods where isdelete = false and linkid = bc.id) AS tcpieces,
                  (select SUM (grswgt) from bus_goods where isdelete = false and linkid = bc.id) AS tcgrswgts,
                  (SELECT SUM (chargeweight) from bus_goods where isdelete = false and linkid = bc.id) as tcchargeweight,
                  (SELECT SUM (cbm) from bus_goods where isdelete = false and linkid = bc.id) AS tccbms,
                  '' as declaretype,
                  (CASE WHEN fj.ldtype = 'F' THEN 'FCL' WHEN fj.ldtype = 'L' THEN 'LCL' END) AS ldtype,
                  '' as isexternalmatching,
                  (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
                  fj.sales as sales,
                  (CASE WHEN deptop = 516228802274 THEN '途C中东操作部' WHEN deptop = 516230252274 THEN '途C北美操作部' WHEN deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS opsales,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bc.id and y.isdelete = false) as csname,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'O'::text AND y.linkid = bc.id and y.isdelete = false) as opname,
                  (CASE WHEN fj.jobtype = 'A' THEN (CASE WHEN EXISTS(SELECT 1 FROM fina_jobs WHERE isdelete = FALSE AND parentid = fj.id LIMIT 1) THEN '空运拼箱' ELSE '航空货运' END) END) as ldtype2,
                  (select name from sys_department where id = (CASE WHEN (corpid = 11540072274 OR corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
                  (select name from sys_department where id = fj.deptop limit 1) as tcdeptop,
                  (CASE WHEN fj.iscomplete THEN '是' ELSE '否' END) as iscomplete,
                  (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
                  (CASE WHEN fj.iscomplete_ar THEN '是' ELSE '否' END) as complete_ar_status,
                  (CASE WHEN fj.iscomplete_ap THEN '是' ELSE '否' END) as complete_ap_status,
                  (CASE WHEN fj.iscomplete_loss THEN '确认亏损' ELSE '' END) as iscomplete_loss,
                  (SELECT  COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$ $financial$) AS arrears,
                  (SELECT  COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $arapsql$ $isvirarapsql$ $arbillsql$) AS amountar,
                  (SELECT  COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $arapsql$ $isvirarapsql$) AS amountap,
                  ((SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                  (SELECT  COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitrmb,
                  ((SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                  (SELECT  COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitusd,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id) THEN '未付款' ELSE '部分付款' END) AS apstatus
              FROM fina_jobs fj,
                   bus_air bc
              WHERE fj.id = bc.jobid
                AND fj.jobtype = 'A'
                AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $airsql$

              UNION ALL

              SELECT fj.id as id,
                  fj.nos as nos,
                  fj.jobtype as jobtype,
                  fj.parentid as parentid,
                  fj.customerid  as customerid,
                  fj.customerabbr as customerabbr,
                  fj.refno2 as refno2,
                  '' as pnos,
                  fj.jobdate as jobdate,
                  TO_CHAR(fj.submitime, 'yyyy-MM-dd') as submitime,
                  to_char(bc.loadtime, 'YYYY"年"IW"周"') AS year_week,
                  to_char(bc.loadtime, 'YYYY"年"MM"月"') AS year_month,
                  '' as dotype,
                  '' as cntnum,
                  '' as tcpol,
                  '' as tcpod,
                  bc.jobid as jobid,
                  to_char(bc.loadtime, 'yyyy-MM-dd') as etd,
                  '' as eta,
                  '' as tcproductname,
                  fj.refno as ponum,
                  bc.sono as sonum,
                  fj.inputer AS inputer,
                  TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                  fj.updater AS updater,
                  TO_CHAR(fj.updatetime, 'yyyy-MM-dd hh24:mi') as updatetime,
                  '' as wmsintime,
                  '' as pickcnttime,
                  '' as returncnttime,
                  fj.remarks as remarks,
                  bc.remarks as remark,
                  (select SUM (piece) from bus_goods where isdelete = false and linkid = bc.id) AS tcpieces,
                  (select SUM (grswgt) from bus_goods where isdelete = false and linkid = bc.id) AS tcgrswgts,
                  (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = bc.id) as tcchargeweight,
                  (SELECT SUM (cbm) from bus_goods where isdelete = false and linkid = bc.id) AS tccbms,
                  '' as declaretype,
                  (CASE WHEN fj.ldtype = 'F' THEN 'FCL' WHEN fj.ldtype = 'L' THEN 'LCL' END) AS ldtype,
                  '' as isexternalmatching,
                  (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
                  fj.sales as sales,
                  (CASE WHEN deptop = 516228802274 THEN '途C中东操作部' WHEN deptop = 516230252274 THEN '途C北美操作部' WHEN deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS opsales,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bc.id and y.isdelete = false) as csname,
                  (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'O'::text AND y.linkid = bc.id and y.isdelete = false) as opname,
                  '陆路运输' as ldtype2,
                  (SELECT name from sys_department where id = (CASE WHEN (corpid = 11540072274 OR corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
                  (select name from sys_department where id = fj.deptop limit 1) as tcdeptop,
                  (CASE WHEN fj.iscomplete THEN '是' ELSE '否' END) as iscomplete,
                  (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
                  (CASE WHEN fj.iscomplete_ar THEN '是' ELSE '否' END) as complete_ar_status,
                  (CASE WHEN fj.iscomplete_ap THEN '是' ELSE '否' END) as complete_ap_status,
                  (CASE WHEN fj.iscomplete_loss THEN '确认亏损' ELSE '' END) as iscomplete_loss,
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$ $financial$) AS arrears,
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $arapsql$ $isvirarapsql$ $arbillsql$) AS amountar,
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $arapsql$ $isvirarapsql$) AS amountap,
                  ((SELECT COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitrmb,
                  ((SELECT COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                  (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitusd,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
                  (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id) THEN '未付款' ELSE '部分付款' END) AS apstatus
              FROM fina_jobs fj,
                   bus_truck bc
              WHERE fj.id = bc.jobid
                AND fj.jobtype = 'L'
                AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $landsql$

              UNION ALL

              SELECT fj.id as id,
                   fj.nos as nos,
                   fj.jobtype as jobtype,
                   fj.parentid as parentid,
                   fj.customerid  as customerid,
                   fj.customerabbr as customerabbr,
                   fj.refno2 as refno2,
                   '' as pnos,
                   fj.jobdate as jobdate,
                   TO_CHAR(fj.submitime, 'yyyy-MM-dd') as submitime,
                   to_char(bc.singtime, 'YYYY"年"IW"周"') AS year_week,
                   to_char(bc.singtime, 'YYYY"年"MM"月"') AS year_month,
                   '' as dotype,
                   '' as cntnum,
                   '' as tcpol,
                   '' as tcpod,
                   bc.jobid as jobid,
                   to_char(bc.singtime, 'yyyy-MM-dd') as etd,
                   '' as eta,
                   '' as tcproductname,
                   fj.refno as ponum,
                   bc.sono as sonum,
                   fj.inputer AS inputer,
                   TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                   fj.updater AS updater,
                   TO_CHAR(fj.updatetime, 'yyyy-MM-dd hh24:mi') as updatetime,
                   '' as wmsintime,
                   '' as pickcnttime,
                   '' as returncnttime,
                   fj.remarks as remarks,
                   bc.remarks as remark,
                   (select SUM (piece) from bus_goods where isdelete = false and linkid = bc.id) AS tcpieces,
                   (select SUM (grswgt) from bus_goods where isdelete = false and linkid = bc.id) AS tcgrswgts,
                   (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = bc.id) as tcchargeweight,
                   (SELECT SUM (cbm) from bus_goods where isdelete = false and linkid = bc.id) AS tccbms,
                   '' as declaretype,
                   (CASE WHEN fj.ldtype = 'F' THEN 'FCL' WHEN fj.ldtype = 'L' THEN 'LCL' END) AS ldtype,
                   '' as isexternalmatching,
                   (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
                   (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
                   (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
                   fj.sales as sales,
                   (CASE WHEN deptop = 516228802274 THEN '途C中东操作部' WHEN deptop = 516230252274 THEN '途C北美操作部' WHEN deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS opsales,
                   (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bc.id and y.isdelete = false) as csname,
                   (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'O'::text AND y.linkid = bc.id and y.isdelete = false) as opname,
                   '报关单' as ldtype2,
                   (SELECT name from sys_department where id = (CASE WHEN (corpid = 11540072274 OR corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
                   (select name from sys_department where id = fj.deptop limit 1) as tcdeptop,
                   (CASE WHEN fj.iscomplete THEN '是' ELSE '否' END) as iscomplete,
                   (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
                   (CASE WHEN fj.iscomplete_ar THEN '是' ELSE '否' END) as complete_ar_status,
                   (CASE WHEN fj.iscomplete_ap THEN '是' ELSE '否' END) as complete_ap_status,
                   (CASE WHEN fj.iscomplete_loss THEN '确认亏损' ELSE '' END) as iscomplete_loss,
                   (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$ $financial$) AS arrears,
                   (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $arapsql$ $isvirarapsql$ $arbillsql$) AS amountar,
                   (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $arapsql$ $isvirarapsql$) AS amountap,
                   ((SELECT COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                   (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitrmb,
                   ((SELECT COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$ $isvirarapsql$) -
                   (SELECT  COALESCE (SUM (f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'USD', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$ $financial$ $isvirarapsql$)):: NUMERIC(18,2) as profitusd,
                   (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = fj.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
                   (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND rptype <![CDATA[ <> ]]> 'O' AND jobid = fj.id) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = fj.id) THEN '未付款' ELSE '部分付款' END) AS apstatus
              FROM fina_jobs fj,
                  bus_customs bc
              WHERE fj.id = bc.jobid
                AND fj.jobtype = 'C'
                AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $custsql$
             ) result
        WHERE 1 = 1 $greater$
        ORDER BY inputtime DESC) json
    </select>
    <!--查询电商费用列表-->
    <select id="base.commerce.araplist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS araplist
        FROM (SELECT * FROM (
            SELECT fj.id,
                   fj.id as jobid,
                   z.id as arapid,
                   fj.nos,
                   fj.jobdate,
                   fj.jobtype,
                   fj.parentid,
                   fj.corpid,
                   fj.customerid,
                   fj.customerabbr as customername,
                   (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
                   (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
                   fj.sales AS sales,
                   fj.refno2,
                   z.remarks,
                   (CASE WHEN fj.ldtype2 = 'H' THEN 'FBA海运' WHEN fj.ldtype2 = 'K' THEN 'FBA空运' WHEN fj.ldtype2 = 'T' THEN 'FBA铁运' WHEN fj.ldtype2 = 'X' THEN '快递专线' WHEN fj.ldtype2 IN ('Z','M') THEN '海运整柜' ELSE '其它' END) as ldtype2,
                   TO_CHAR(y.etd, 'yyyy-MM-dd') as etd,
                   TO_CHAR(y.eta, 'yyyy-MM-dd') as eta,
                   TO_CHAR(fj.submitime,'yyyy-MM-dd') as submitime,
                   (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
                   (CASE WHEN z.rptype = 'O' THEN 'O' END) AS rptype,
                   (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
                   z.currency,
                   z.amount,
                   (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount)) as baseamount,
                   z.inputer AS inputer,
                   TO_CHAR(z.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                   z.isconfirm,
                   z.confirmer AS confirmer,
                   TO_CHAR(z.confirmtime, 'yyyy-MM-dd hh24:mi') confirmtime,
                   z.amtstl2,
                   (z.amount - z.amtstl2) as unamtstl2,
                   (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount - z.amtstl2)) as baseunamtstl2,
                   z.arapdate,
                   z.vchdtlid,
                   y.ponum                                                                          as ponum,
                   (select nos from fina_jobs where id = fj.parentid and isdelete = false limit 1)  as pnos,
                   '' as containerno,
                   (case WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END)  AS araptype,
                   (select name from dat_feeitem where id = z.feeitemid limit 1)                    as feeitemname,
                   (select namec from sys_corporation where id = z.customerid limit 1)              as customerabbr,
                   (select merchantcode from sys_corpext where customerid = z.customerid limit 1)   as merchantcode,
                   (select daysar from sys_corporation where id = z.customerid limit 1)             as daysar,
                   (select (CASE WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN ((DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE) - INTERVAL '1 day' ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') = to_char(now(), 'YYYYMM') THEN '本月应收' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN (( DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL - INTERVAL '1 day')::DATE) ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') <![CDATA[ < ]]> to_char(now(), 'YYYYMM') THEN '逾期' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 THEN '未逾期' ELSE '' END) from sys_corporation where id = z.customerid limit 1)   as daysarstatus,
                   (SELECT xx.actpayrecno FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id LIMIT 1) AS actpayrecno,
                   (select name from sys_department where id = (CASE WHEN (fj.corpid = 11540072274 OR fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
                   (f_amtto_glp((CASE WHEN z.vchdtlid is not null THEN (SELECT x.year || '-' || x.period || '-05' FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1)::DATE ELSE z.arapdate END), z.currency, z.amount)) AS amountzq,
                   (CASE WHEN f_sys_config('rp2vch_no_rpdate_as_checkfee') = 'Y' THEN COALESCE((SELECT SUM(yy.amountwf) FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id AND xx.isdelete = FALSE AND yy.isdelete = FALSE AND xx.rpdate IS NOT NULL), 0) ELSE z.amtstl2 END) AS amtstl3,
                   (SELECT x.year || '-' || x.period FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1) AS yearperiod
          FROM fina_jobs fj, bus_commerce y, fina_arap z
          WHERE fj.id = y.jobid
          AND fj.id = z.jobid
          AND fj.jobtype = 'D'
          AND fj.isdelete = false
          AND z.isdelete = false $qry$ $filter$

        UNION ALL

        SELECT fj.id,
               fj.id as jobid,
               z.id as arapid,
               fj.nos,
               fj.jobdate,
               fj.jobtype,
               fj.parentid,
               fj.corpid,
               fj.customerid,
               fj.customerabbr as customername,
               (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
               (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
               fj.sales AS sales,
               fj.refno2,
               z.remarks,
               '海运整柜' as ldtype2,
               TO_CHAR(y.etd, 'yyyy-MM-dd') as etd,
               TO_CHAR(y.eta, 'yyyy-MM-dd') as eta,
               TO_CHAR(fj.submitime,'yyyy-MM-dd') as submitime,
               (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
               (CASE WHEN z.rptype = 'O' THEN 'O' END) AS rptype,
               (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
               z.currency,
               z.amount,
               (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount)) as baseamount,
               z.inputer AS inputer,
               TO_CHAR(z.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
               z.isconfirm,
               z.confirmer AS confirmer,
               TO_CHAR(z.confirmtime, 'yyyy-MM-dd hh24:mi') confirmtime,
               z.amtstl2,
               (z.amount - z.amtstl2) as unamtstl2,
               (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount - z.amtstl2)) as baseunamtstl2,
               z.arapdate,
               z.vchdtlid,
               fj.refno as ponum,
               '' as pnos,
               (SELECT STRING_AGG(bsc.cntno, '/') FROM bus_ship_container bsc WHERE bsc.jobid = fj.id AND bsc.isdelete = FALSE)  as containerno,
               (case WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END)     AS araptype,
               (select name from dat_feeitem where id = z.feeitemid limit 1)                    as feeitemname,
               (select namec from sys_corporation where id = z.customerid limit 1)              as customerabbr,
               (select merchantcode from sys_corpext where customerid = z.customerid limit 1)   as merchantcode,
               (select daysar from sys_corporation where id = z.customerid limit 1)   as daysar,
               (select (CASE WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN ((DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE) - INTERVAL '1 day' ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') = to_char(now(), 'YYYYMM') THEN '本月应收' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN (( DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL - INTERVAL '1 day')::DATE) ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') <![CDATA[ < ]]> to_char(now(), 'YYYYMM') THEN '逾期' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 THEN '未逾期' ELSE '' END) from sys_corporation where id = z.customerid limit 1)   as daysarstatus,
               (SELECT xx.actpayrecno FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id LIMIT 1) AS actpayrecno,
               (select name from sys_department where id = (CASE WHEN (fj.corpid = 11540072274 OR fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
               (f_amtto_glp((CASE WHEN z.vchdtlid is not null THEN (SELECT x.year || '-' || x.period || '-05' FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1)::DATE ELSE z.arapdate END), z.currency, z.amount)) AS amountzq,
               (CASE WHEN f_sys_config('rp2vch_no_rpdate_as_checkfee') = 'Y' THEN COALESCE((SELECT SUM(yy.amountwf) FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id AND xx.isdelete = FALSE AND yy.isdelete = FALSE AND xx.rpdate IS NOT NULL), 0) ELSE z.amtstl2 END) AS amtstl3,
               (SELECT x.year || '-' || x.period FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1) AS yearperiod
        FROM fina_jobs fj, bus_shipping y, fina_arap z
        WHERE fj.id = y.jobid
          AND fj.id = z.jobid
          AND fj.jobtype = 'S'
          AND fj.isdelete = false
          AND z.isdelete = false $qry$ $filter$

        UNION ALL

        SELECT fj.id,
               fj.id as jobid,
               z.id as arapid,
               fj.nos,
               fj.jobdate,
               fj.jobtype,
               fj.parentid,
               fj.corpid,
               fj.customerid,
               fj.customerabbr as customername,
               (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
               (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
               fj.sales AS sales,
               fj.refno2,
               z.remarks,
               '航空货运' as ldtype2,
               TO_CHAR(y.singtime, 'yyyy-MM-dd') as etd,
               TO_CHAR(y.eta, 'yyyy-MM-dd') as eta,
               TO_CHAR(fj.submitime,'yyyy-MM-dd') as submitime,
               (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
               (CASE WHEN z.rptype = 'O' THEN 'O' END) AS rptype,
               (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
               z.currency,
               z.amount,
               (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount)) as baseamount,
               z.inputer AS inputer,
               TO_CHAR(z.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
               z.isconfirm,
               z.confirmer AS confirmer,
               TO_CHAR(z.confirmtime, 'yyyy-MM-dd hh24:mi') confirmtime,
               z.amtstl2,
               (z.amount - z.amtstl2) as unamtstl2,
               (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount - z.amtstl2)) as baseunamtstl2,
               z.arapdate,
               z.vchdtlid,
               fj.refno                                                                          as ponum,
               ''   as pnos,
               y.mawbno as containerno,
               (CASE WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END)    as araptype,
               (select name from dat_feeitem where id = z.feeitemid LIMIT 1)                     as feeitemname,
               (select namec from sys_corporation where id = z.customerid LIMIT 1)               as customerabbr,
               (select merchantcode from sys_corpext where customerid = z.customerid LIMIT 1)    as merchantcode,
               (select daysar from sys_corporation where id = z.customerid LIMIT 1)   as daysar,
               (select (CASE WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN ((DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE) - INTERVAL '1 day' ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') = to_char(now(), 'YYYYMM') THEN '本月应收' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN (( DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL - INTERVAL '1 day')::DATE) ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') <![CDATA[ < ]]> to_char(now(), 'YYYYMM') THEN '逾期' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 THEN '未逾期' ELSE '' END) from sys_corporation where id = z.customerid limit 1)   as daysarstatus,
               (SELECT xx.actpayrecno FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id LIMIT 1) AS actpayrecno,
               (select name from sys_department where id = (CASE WHEN (fj.corpid = 11540072274 OR fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
               (f_amtto_glp((CASE WHEN z.vchdtlid is not null THEN (SELECT x.year || '-' || x.period || '-05' FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1)::DATE ELSE z.arapdate END), z.currency, z.amount)) AS amountzq,
               (CASE WHEN f_sys_config('rp2vch_no_rpdate_as_checkfee') = 'Y' THEN COALESCE((SELECT SUM(yy.amountwf) FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id AND xx.isdelete = FALSE AND yy.isdelete = FALSE AND xx.rpdate IS NOT NULL), 0) ELSE z.amtstl2 END) AS amtstl3,
               (SELECT x.year || '-' || x.period FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1) AS yearperiod
        FROM fina_jobs fj, bus_air y, fina_arap z
        WHERE fj.id = y.jobid
          AND fj.id = z.jobid
          AND fj.jobtype = 'A'
          AND fj.isdelete = false
          AND z.isdelete = false  $qry$ $filter$

        UNION ALL

        SELECT fj.id,
               fj.id as jobid,
               z.id as arapid,
               fj.nos,
               fj.jobdate,
               fj.jobtype,
               fj.parentid,
               fj.corpid,
               fj.customerid,
               fj.customerabbr as customername,
               (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
               (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
               fj.sales AS sales,
               fj.refno2,
               z.remarks,
               '陆路运输' as ldtype2,
               TO_CHAR(y.loadtime, 'yyyy-MM-dd') as etd,
               '' as eta,
               TO_CHAR(fj.submitime,'yyyy-MM-dd') as submitime,
               (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
               (CASE WHEN z.rptype = 'O' THEN 'O' END) AS rptype,
               (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
               z.currency,
               z.amount,
               (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount)) as baseamount,
               z.inputer AS inputer,
               TO_CHAR(z.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
               z.isconfirm,
               z.confirmer AS confirmer,
               TO_CHAR(z.confirmtime, 'yyyy-MM-dd hh24:mi') confirmtime,
               z.amtstl2,
               (z.amount - z.amtstl2) as unamtstl2,
               (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount - z.amtstl2)) as baseunamtstl2,
               z.arapdate,
               z.vchdtlid,
               fj.refno as ponum,
               ''  as pnos,
               '' as containerno,
               (case WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END)   AS araptype,
               (select name from dat_feeitem where id = z.feeitemid limit 1)                    AS feeitemname,
               (select namec from sys_corporation where id = z.customerid limit 1)              AS customerabbr,
               (select merchantcode from sys_corpext where customerid = z.customerid limit 1)   AS merchantcode,
               (select daysar from sys_corporation where id = z.customerid limit 1)   as daysar,
               (select (CASE WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN ((DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE) - INTERVAL '1 day' ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') = to_char(now(), 'YYYYMM') THEN '本月应收' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN (( DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL - INTERVAL '1 day')::DATE) ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') <![CDATA[ < ]]> to_char(now(), 'YYYYMM') THEN '逾期' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 THEN '未逾期' ELSE '' END) from sys_corporation where id = z.customerid limit 1)   as daysarstatus,
               (SELECT xx.actpayrecno FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id LIMIT 1) AS actpayrecno,
               (select name from sys_department where id = (CASE WHEN (fj.corpid = 11540072274 OR fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
               (f_amtto_glp((CASE WHEN z.vchdtlid is not null THEN (SELECT x.year || '-' || x.period || '-05' FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1)::DATE ELSE z.arapdate END), z.currency, z.amount)) AS amountzq,
               (CASE WHEN f_sys_config('rp2vch_no_rpdate_as_checkfee') = 'Y' THEN COALESCE((SELECT SUM(yy.amountwf) FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id AND xx.isdelete = FALSE AND yy.isdelete = FALSE AND xx.rpdate IS NOT NULL), 0) ELSE z.amtstl2 END) AS amtstl3,
               (SELECT x.year || '-' || x.period FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1) AS yearperiod
        FROM fina_jobs fj, bus_truck y, fina_arap z
        WHERE fj.id = y.jobid
          AND fj.id = z.jobid
          AND fj.jobtype = 'L'
          AND fj.isdelete = false
          AND z.isdelete = false $qry$ $filter$

              UNION ALL

              SELECT fj.id,
                  fj.id as jobid,
                  z.id as arapid,
                  fj.nos,
                  fj.jobdate,
                  fj.jobtype,
                  fj.parentid,
                  fj.corpid,
                  fj.customerid,
                  fj.customerabbr as customername,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpid AND iscustomer = FALSE LIMIT 1)  as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = fj.corpidop AND iscustomer = FALSE LIMIT 1)  as corpidopname,
                  fj.sales AS sales,
                  fj.refno2,
                  z.remarks,
                  '报关单' as ldtype2,
                  TO_CHAR(y.singtime, 'yyyy-MM-dd') as etd,
                  '' as eta,
                  TO_CHAR(fj.submitime,'yyyy-MM-dd') as submitime,
                  (CASE WHEN fj.tradeway = 'F' THEN 'FOB' WHEN fj.tradeway = 'C' THEN 'CIF' WHEN fj.tradeway = 'D' THEN 'DDP' WHEN fj.tradeway = 'G' THEN 'DDU' WHEN fj.tradeway = 'E' THEN 'EXW' WHEN fj.tradeway = 'A' THEN 'FCA' END) AS tradeway,
                  (CASE WHEN z.rptype = 'O' THEN 'O' END) AS rptype,
                  (CASE WHEN fj.isconfirm2_pp THEN '是' ELSE '否' END) as confirm_pp,
                  z.currency,
                  z.amount,
                  (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount)) as baseamount,
                  z.inputer AS inputer,
                  TO_CHAR(z.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                  z.isconfirm,
                  z.confirmer AS confirmer,
                  TO_CHAR(z.confirmtime, 'yyyy-MM-dd hh24:mi') confirmtime,
                  z.amtstl2,
                  (z.amount - z.amtstl2) as unamtstl2,
                  (f_amtto((CASE WHEN z.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN z.arapdate ELSE fj.jobdate END), z.currency, 'CNY', z.amount - z.amtstl2)) as baseunamtstl2,
                  z.arapdate,
                  z.vchdtlid,
                  fj.refno as ponum,
                  ''  as pnos,
                  '' as containerno,
                  (case WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END)   AS araptype,
                  (select name from dat_feeitem where id = z.feeitemid limit 1)                    AS feeitemname,
                  (select namec from sys_corporation where id = z.customerid limit 1)              AS customerabbr,
                  (select merchantcode from sys_corpext where customerid = z.customerid limit 1)   AS merchantcode,
                  (select daysar from sys_corporation where id = z.customerid limit 1)   as daysar,
                  (select (CASE WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN ((DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE) - INTERVAL '1 day' ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') = to_char(now(), 'YYYYMM') THEN '本月应收' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 AND TO_CHAR((CASE WHEN COALESCE(daysar, 15) > 15 THEN (( DATE_TRUNC('MONTH', (DATE_TRUNC('MONTH', fj.jobdate) + INTERVAL '1 MONTH')) + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL - INTERVAL '1 day')::DATE) ELSE (fj.jobdate + (('''' || COALESCE(daysar, 15)) || ' days' || '''')::INTERVAL)::DATE END), 'YYYYMM') <![CDATA[ < ]]> to_char(now(), 'YYYYMM') THEN '逾期' WHEN z.amount <![CDATA[ <> ]]> z.amtstl2 THEN '未逾期' ELSE '' END) from sys_corporation where id = z.customerid limit 1)   as daysarstatus,
                  (SELECT xx.actpayrecno FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id LIMIT 1) AS actpayrecno,
                  (select name from sys_department where id = (CASE WHEN (fj.corpid = 11540072274 OR fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TAE' THEN 516228802274 WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TSZ' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TBZ' OR SUBSTRING(fj.nos FROM 1 FOR 3) = 'TXM' THEN (CASE WHEN fj.deptid = 1565607982274 THEN 1565607982274 ELSE 516230252274 END) WHEN SUBSTRING(fj.nos FROM 1 FOR 3) = 'TDA' THEN 516239022274 WHEN SUBSTRING(fj.nos FROM 1 FOR 1) <![CDATA[ <> ]]> 'T' THEN fj.deptop END) ELSE fj.deptid END) limit 1) as tcdept,
                  (f_amtto_glp((CASE WHEN z.vchdtlid is not null THEN (SELECT x.year || '-' || x.period || '-05' FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1)::DATE ELSE z.arapdate END), z.currency, z.amount)) AS amountzq,
                  (CASE WHEN f_sys_config('rp2vch_no_rpdate_as_checkfee') = 'Y' THEN COALESCE((SELECT SUM(yy.amountwf) FROM fina_actpayrec xx, fina_actpayrecdtl yy WHERE xx.id = yy.actpayrecid AND yy.arapid = z.id AND xx.isdelete = FALSE AND yy.isdelete = FALSE AND xx.rpdate IS NOT NULL), 0) ELSE z.amtstl2 END) AS amtstl3,
                  (SELECT x.year || '-' || x.period FROM fs_vch x WHERE x.isdelete = FALSE AND x.id = ANY (SELECT y.vchid FROM fs_vchdtl y WHERE y.isdelete = FALSE AND y.id = z.vchdtlid LIMIT 1) LIMIT 1) AS yearperiod
              FROM fina_jobs fj, bus_customs y, fina_arap z
              WHERE fj.id = y.jobid
                AND fj.id = z.jobid
                AND fj.jobtype = 'C'
                AND fj.isdelete = false
                AND z.isdelete = false $qry$ $filter$
        ) result WHERE 1 = 1 $qry2$
        ORDER BY inputtime DESC) json
    </select>
    <!--查询电商账单列表-->
    <select id="base.commerce.billlist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS billlist
        FROM (SELECT * FROM (
            SELECT x.id,
                   x.nos,
                   x.id AS jobid,
                   x.jobtype,
                   x.corpid,
                   (CASE WHEN z.corpid = 11540072274 THEN 'TOC' WHEN z.corpid = 157970752274 THEN 'GHK' WHEN z.corpid = 399480672274 THEN 'GDB' END) as arapcorpid,
                   x.sales AS sales,
                   z.id as arapid,
                   z.currency,
                   z.amount,
                   (z.amount - z.amtstl2) AS amtstl2,
                   z.piece,
                   z.price,
                   z.arapdate,
                   TO_CHAR(z.confirmtime, 'yyyy-MM-dd') as confirmtime,
                   z.inputtime,
                   y.polnamec AS pol,
                   y.podnamec AS pod,
                   y.ponum AS ponum,
                   y.sonum AS sonum,
                   y.pkgnum AS pkgnum,
                   y.bweight::VARCHAR AS bweight,
                   z.remarks AS arapremarks,
                   (SELECT abbr FROM sys_corporation WHERE id = x.corpid AND iscustomer = FALSE LIMIT 1) as corpidname,
                   (SELECT abbr FROM sys_corporation WHERE id = x.corpidop AND iscustomer = FALSE LIMIT 1) as corpidopname,
                   (SELECT namec FROM sys_corporation WHERE id = z.customerid LIMIT 1) AS customerabbr,
                   (SELECT '派送中/签收'::TEXT FROM bus_commerce_node bcn WHERE bcn.jobid = x.id AND delivery IS NOT NULL LIMIT 1) AS isdelivery,
                   TO_CHAR(y.etd, 'yyyy-MM-dd') AS etd,
                   TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                   y.productname AS productname,
                   y.cargoname AS cargoname,
                   y.deliverytocode AS deliverytocode,
                   y.freightterm AS freightterm,
                   y.shipmentid AS shipmentid,
                   TO_CHAR(y.wmsindate, 'yyyy-MM-dd') AS wmsindate,
                   (y.vsl || ' / ' || y.voy)  as vessel,
                   (y.gw || 'KGS ' || y.vol || 'CBM ' || y.pkgnum::BIGINT || 'PACKAGES')::VARCHAR  as dotype,
                   (SELECT STRING_AGG(xx.nos,',') FROM fina_rpreq xx,fina_rpreqdtl yy WHERE xx.id = yy.rpreqid AND yy.arapid = z.id AND yy.isdelete = false AND yy.amtreq != 0) as rpreqno,
                   (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) ELSE z.amount END) AS unitamount,
                   (CASE WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END) AS araptype,(SELECT name FROM dat_feeitem WHERE id = z.feeitemid LIMIT 1) AS feeitemname,
                   (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) / z.piece ELSE z.piece END) AS unitprice,
                   (SELECT STRING_AGG(bsc.cntno || '/' || (SELECT code FROM dat_cntype t WHERE t.id = bsc.cntypeid LIMIT 1), ' ') FROM bus_ship_container bsc WHERE x.id = bsc.jobid AND bsc.isdelete = FALSE)  as containerno
            FROM fina_jobs x,bus_commerce y,fina_arap z
              WHERE x.id = y.jobid
                AND x.id = z.jobid
                AND z.rptype <![CDATA[ <> ]]> 'O'
                AND x.isdelete = FALSE
                AND z.isdelete = FALSE
                AND z.amount <![CDATA[ <> ]]> z.amtstl2 $qry$ $filter$ $commerceqry$

              UNION ALL

              SELECT x.id,
                  x.nos,
                  x.id AS jobid,
                  x.jobtype,
                  x.corpid,
                  (CASE WHEN z.corpid = 11540072274 THEN 'TOC' WHEN z.corpid = 157970752274 THEN 'GHK' WHEN z.corpid = 399480672274 THEN 'GDB' END) as arapcorpid,
                  x.sales AS sales,
                  z.id as arapid,
                  z.currency,
                  z.amount,
                  (z.amount - z.amtstl2) AS amtstl2,
                  z.piece,
                  z.price,
                  z.arapdate,
                  TO_CHAR(z.confirmtime, 'yyyy-MM-dd') as confirmtime,
                  z.inputtime,
                  y.pol AS pol,
                  y.pod AS pod,
                  x.refno AS ponum,
                  y.sono AS sonum,
                  (select SUM (piece) from bus_ship_container where isdelete = false and jobid = x.id) AS pkgnum,
                  '' AS bweight,
                  z.remarks AS arapremarks,
                  (SELECT abbr FROM sys_corporation WHERE id = x.corpid AND iscustomer = FALSE LIMIT 1) as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = x.corpidop AND iscustomer = FALSE LIMIT 1) as corpidopname,
                  (SELECT namec FROM sys_corporation WHERE id = z.customerid LIMIT 1) AS customerabbr,
                  '' AS isdelivery,
                  TO_CHAR(y.etd, 'yyyy-MM-dd') AS etd,
                  TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                  '' AS productname,
                  '' AS cargoname,
                  '' AS deliverytocode,
                  '' AS freightterm,
                  '' AS shipmentid,
                  '' AS wmsindate,
                  (y.vessel || ' / ' || y.voyage)  as vessel,
                  (SELECT f_bus_shipping_do_type(('shipid='::text || (SELECT id FROM bus_shipping WHERE jobid = x.id AND isdelete = false limit 1)) || ';'::text))  as dotype,
                  (SELECT STRING_AGG(xx.nos,',') FROM fina_rpreq xx,fina_rpreqdtl yy WHERE xx.id = yy.rpreqid AND yy.arapid = z.id AND yy.isdelete = false AND yy.amtreq != 0) as rpreqno,
                  (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) ELSE z.amount END) AS unitamount,
                  (CASE WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END) AS araptype,(SELECT name FROM dat_feeitem WHERE id = z.feeitemid LIMIT 1) AS feeitemname,
                  (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) / z.piece ELSE z.piece END) AS unitprice,
                  (SELECT STRING_AGG(bsc.cntno || '/' || (SELECT code FROM dat_cntype t WHERE t.id = bsc.cntypeid LIMIT 1), ' ') FROM bus_ship_container bsc WHERE x.id = bsc.jobid AND bsc.isdelete = FALSE)  as containerno
              FROM fina_jobs x,bus_shipping y,fina_arap z
              WHERE x.id = y.jobid
                AND x.id = z.jobid
                AND z.rptype <![CDATA[ <> ]]> 'O'
                AND x.isdelete = FALSE
                AND z.isdelete = FALSE
                AND z.amount <![CDATA[ <> ]]> z.amtstl2 $qry$ $filter$

              UNION ALL

              SELECT x.id,
                  x.nos,
                  x.id AS jobid,
                  x.jobtype,
                  x.corpid,
                  (CASE WHEN z.corpid = 11540072274 THEN 'TOC' WHEN z.corpid = 157970752274 THEN 'GHK' WHEN z.corpid = 399480672274 THEN 'GDB' END) as arapcorpid,
                  x.sales AS sales,
                  z.id as arapid,
                  z.currency,
                  z.amount,
                  (z.amount - z.amtstl2) AS amtstl2,
                  z.piece,
                  z.price,
                  z.arapdate,
                  TO_CHAR(z.confirmtime, 'yyyy-MM-dd') as confirmtime,
                  z.inputtime,
                  y.pol AS pol,
                  y.pod AS pod,
                  x.refno AS ponum,
                  '' AS sonum,
                  (select SUM (piece) from bus_goods where isdelete = false and linkid = y.id) AS pkgnum,
                  '' AS bweight,
                  z.remarks AS arapremarks,
                  (SELECT abbr FROM sys_corporation WHERE id = x.corpid AND iscustomer = FALSE LIMIT 1) as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = x.corpidop AND iscustomer = FALSE LIMIT 1) as corpidopname,
                  (SELECT namec FROM sys_corporation WHERE id = z.customerid LIMIT 1) AS customerabbr,
                  '' AS isdelivery,
                  TO_CHAR(y.singtime, 'yyyy-MM-dd') AS etd,
                  TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                  '' AS productname,
                  '' AS cargoname,
                  '' AS deliverytocode,
                  '' AS freightterm,
                  '' AS shipmentid,
                  '' AS wmsindate,
                  y.flightno1  as vessel,
                  (y.chargeweight || 'KGS ' || y.volume || 'CBM ' || y.piece || 'PACKAGES')::VARCHAR  as dotype,
                  (SELECT STRING_AGG(xx.nos,',') FROM fina_rpreq xx,fina_rpreqdtl yy WHERE xx.id = yy.rpreqid AND yy.arapid = z.id AND yy.isdelete = false AND yy.amtreq != 0) as rpreqno,
                  (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) ELSE z.amount END) AS unitamount,
                  (CASE WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END) AS araptype,(SELECT name FROM dat_feeitem WHERE id = z.feeitemid LIMIT 1) AS feeitemname,
                  (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) / z.piece ELSE z.piece END) AS unitprice,
                  (SELECT STRING_AGG(bsc.cntno || '/' || (SELECT code FROM dat_cntype t WHERE t.id = bsc.cntypeid LIMIT 1), ' ') FROM bus_ship_container bsc WHERE x.id = bsc.jobid AND bsc.isdelete = FALSE)  as containerno
              FROM fina_jobs x,bus_air y,fina_arap z
              WHERE x.id = y.jobid
                AND x.id = z.jobid
                AND z.rptype <![CDATA[ <> ]]> 'O'
                AND x.isdelete = FALSE
                AND z.isdelete = FALSE
                AND z.amount <![CDATA[ <> ]]> z.amtstl2 $qry$ $filter$

              UNION ALL

              SELECT x.id,
                  x.nos,
                  x.id AS jobid,
                  x.jobtype,
                  x.corpid,
                  (CASE WHEN z.corpid = 11540072274 THEN 'TOC' WHEN z.corpid = 157970752274 THEN 'GHK' WHEN z.corpid = 399480672274 THEN 'GDB' END) as arapcorpid,
                  x.sales AS sales,
                  z.id as arapid,
                  z.currency,
                  z.amount,
                  (z.amount - z.amtstl2) AS amtstl2,
                  z.piece,
                  z.price,
                  z.arapdate,
                  TO_CHAR(z.confirmtime, 'yyyy-MM-dd') as confirmtime,
                  z.inputtime,
                  '' AS pol,
                  '' AS pod,
                  x.refno AS ponum,
                  '' AS sonum,
                  (select SUM (piece) from bus_goods where isdelete = false and linkid = y.id) AS pkgnum,
                  '' AS bweight,
                  z.remarks AS arapremarks,
                  (SELECT abbr FROM sys_corporation WHERE id = x.corpid AND iscustomer = FALSE LIMIT 1) as corpidname,
                  (SELECT abbr FROM sys_corporation WHERE id = x.corpidop AND iscustomer = FALSE LIMIT 1) as corpidopname,
                  (SELECT namec FROM sys_corporation WHERE id = z.customerid LIMIT 1) AS customerabbr,
                  '' AS isdelivery,
                  TO_CHAR(y.loadtime, 'yyyy-MM-dd') AS etd,
                  '' AS eta,
                  '' AS productname,
                  '' AS cargoname,
                  '' AS deliverytocode,
                  '' AS freightterm,
                  '' AS shipmentid,
                  '' AS wmsindate,
                  ''  as vessel,
                  ''  as dotype,
                  (SELECT STRING_AGG(xx.nos,',') FROM fina_rpreq xx,fina_rpreqdtl yy WHERE xx.id = yy.rpreqid AND yy.arapid = z.id AND yy.isdelete = false AND yy.amtreq != 0) as rpreqno,
                  (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) ELSE z.amount END) AS unitamount,
                  (CASE WHEN z.araptype = 'AR' THEN '应收' WHEN z.araptype = 'AP' THEN '应付' END) AS araptype,(SELECT name FROM dat_feeitem WHERE id = z.feeitemid LIMIT 1) AS feeitemname,
                  (CASE WHEN (z.currency = 'USD' or z.currency = 'AED' or z.currency = 'CAD') THEN f_amtto((CASE WHEN isamend = TRUE THEN z.arapdate ELSE x.jobdate END), z.currency, 'CNY', z.amount) / z.piece ELSE z.piece END) AS unitprice,
                  (SELECT STRING_AGG(bsc.cntno || '/' || (SELECT code FROM dat_cntype t WHERE t.id = bsc.cntypeid LIMIT 1), ' ') FROM bus_ship_container bsc WHERE x.id = bsc.jobid AND bsc.isdelete = FALSE)  as containerno
              FROM fina_jobs x,bus_truck y,fina_arap z
              WHERE x.id = y.jobid
                AND x.id = z.jobid
                AND z.rptype <![CDATA[ <> ]]> 'O'
                AND x.isdelete = FALSE
                AND z.isdelete = FALSE
                AND z.amount <![CDATA[ <> ]]> z.amtstl2 $qry$ $filter$
            ) result
        ORDER BY inputtime DESC LIMIT 10000 OFFSET 0) json;
    </select>
    <!--查询预报工作单列表-->
    <select id="base.commerce.shipments" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS shipments
        FROM (SELECT *,
                     (select x.namec from sys_user x, sys_user_assign y where x.id = y.userid and y.roletype = 'C' and y.linkid = bc.id limit 1) as cusservice
            FROM fina_jobs fj,bus_commerce bc
        WHERE fj.id = bc.jobid
          AND fj.isdelete = FALSE
          AND fj.jobtype = 'D'
          AND fj.parentid = 0
          AND bc.isforecast = TRUE $filter$
        ORDER BY bc.forecastdate DESC) json
    </select>
    <!--查询并单列表-->
    <select id="base.commerce.joblist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS joblist
        FROM ( SELECT * FROM (
                    SELECT fj.*,
                           to_char(fj.submitime,'yyyy-MM-dd') as submitime,
                           to_char(bs.etd,'yyyy-MM-dd') as ETD,
                           to_char(bs.eta,'yyyy-MM-dd') as ETA,
                           fj.refno as ponumber,
                           now() as mergetime,
                           '' as productname,
                           '' as deliverytocode,
                           NULL :: TEXT as estimatedeliverydate,
                           NULL :: TEXT as wmsindate,
                           NULL :: TEXT as outwmsindate,
                           '' as cargoname,
                           '' as declaretype,
                           '' as cargotype,
                           '' as declareremarks,
                           '' as commerceremark,
                           (select namec from sys_user where id = fj.saleid limit 1) as sales,
                           (select SUM((case when y.wmsindate is null then y.bkpkgnum else y.pkgnum END)) from fina_jobs x, bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS pieces,
                           (select SUM((case when y.wmsindate is null then y.bkgw else y.gw END)) from fina_jobs x, bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS grswgts,
                           (select SUM((case when y.wmsindate is null then y.bkvol else y.vol END)) from fina_jobs x, bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS  cbms,
                           (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bs.id) as cusname,
                           (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
                           (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb
                 FROM fina_jobs fj,
                     bus_shipping bs
                 WHERE fj.isdelete = FALSE
                   AND fj.id = bs.jobid
                   AND fj.id = $id$

                 UNION ALL

                 SELECT fj.*,
                   to_char(fj.submitime,'yyyy-MM-dd') as submitime,
                     to_char(ba.singtime,'yyyy-MM-dd') as ETD,
                     to_char(ba.eta,'yyyy-MM-dd') as ETA,
                     fj.refno as ponumber,
                     now() as mergetime,
                     '' as productname,
                     '' as deliverytocode,
                     NULL :: TEXT as estimatedeliverydate,
                     NULL :: TEXT as wmsindate,
                     NULL :: TEXT as outwmsindate,
                     '' as cargoname,
                     '' as declaretype,
                     '' as cargotype,
                     '' as declareremarks,
                     '' as commerceremark,
                     (select namec from sys_user where id = fj.saleid limit 1) as sales,
                     (select SUM ((case when y.wmsindate is null then y.bkpkgnum else y.pkgnum END)) from fina_jobs x, bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS pieces,
                     (select SUM ((case when y.wmsindate is null then y.bkgw else y.gw END)) from fina_jobs x,bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS grswgts,
                     (select SUM ((case when y.wmsindate is null then y.bkvol else y.vol END)) from fina_jobs x, bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS cbms,
                     (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = ba.id) as cusname,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb
                 FROM fina_jobs fj,
                     bus_air ba
                 WHERE fj.isdelete = FALSE
                   AND fj.id = ba.jobid
                   AND fj.id = $id$

               UNION ALL

               SELECT fj.*,
                   to_char(fj.submitime,'yyyy-MM-dd') as submitime,
                   to_char(bt.loadtime,'yyyy-MM-dd') as ETD,
                   '' as ETA,
                   fj.refno as ponumber,
                   now() as mergetime,
                   '' as productname,
                   '' as deliverytocode,
                   NULL :: TEXT as estimatedeliverydate,
                   NULL :: TEXT as wmsindate,
                   NULL :: TEXT as outwmsindate,
                   '' as cargoname,
                   '' as declaretype,
                   '' as cargotype,
                   '' as declareremarks,
                   '' as commerceremark,
                    (select namec from sys_user where id = fj.saleid limit 1) as sales,
                    (select SUM ((case when y.wmsindate is null then y.bkpkgnum else y.pkgnum END)) from fina_jobs x, bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS pieces,
                    (select SUM ((case when y.wmsindate is null then y.bkgw else y.gw END)) from fina_jobs x,bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS grswgts,
                    (select SUM ((case when y.wmsindate is null then y.bkvol else y.vol END)) from fina_jobs x, bus_commerce y where x.id = y.jobid and x.isdelete = false and x.parentid = fj.id) AS cbms,
                    (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bt.id) as cusname,
                    (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
                    (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb
               FROM fina_jobs fj,
                   bus_truck bt
               WHERE fj.isdelete = FALSE
                 AND fj.id = bt.jobid
                 AND fj.id = $id$

                UNION ALL

                SELECT fj.*,
                   to_char(fj.submitime,'yyyy-MM-dd') as submitime,
                     to_char(bc.etd,'yyyy-MM-dd') as ETD,
                     to_char(bc.eta,'yyyy-MM-dd') as ETA,
                     bc.ponum as ponumber,
                     bc.mergedate as mergetime,
                     bc.productname as productname,
                     bc.deliverynamec as deliverytocode,
                     to_char(bc.estimatedeliverydate,'yyyy-MM-dd') as estimatedeliverydate,
                     to_char(bc.wmsindate,'yyyy-MM-dd') as wmsindate,
                     (SELECT to_char(outbounddate,'yyyy-MM-dd') FROM bus_commerce_node WHERE fj.id = jobid LIMIT 1) as outwmsindate,
                     bc.cargoname as cargoname,
                     bc.declaretype as declaretype,
                     (SELECT namec FROM dat_filedata WHERE fkcode = 1260 AND code = bc.cargotype LIMIT 1) as cargotype,
                     bc.declareremarks as declareremarks,
                     bc.remark as commerceremark,
                     (select namec from sys_user where id = fj.saleid limit 1) as sales,
                     (case when bc.wmsindate is null then bc.bkpkgnum else bc.pkgnum END) AS pieces,
                     (case when bc.wmsindate is null then bc.bkgw else bc.gw END) AS grswgts,
                     (case when bc.wmsindate is null then bc.bkvol else bc.vol END) AS cbms,
                     (SELECT string_agg(x.namec::text, ','::text) AS string_agg FROM sys_user x, sys_user_assign y WHERE x.id = y.userid AND y.roletype::text = 'C'::text AND y.linkid = bc.id) as cusname,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb
                FROM fina_jobs fj,
                    bus_commerce bc
                WHERE fj.isdelete = FALSE
                AND fj.id = bc.jobid
                AND fj.parentid = $id$) result
        ORDER BY (case jobtype when 'D' then 0 else 1 end) desc, mergetime ASC) json;
    </select>
    <!--分单利润-->
    <select id="base.commerce.profitchild" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS profitchild
        FROM (SELECT * FROM (SELECT x.id,
              x.nos,
              (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
              x.jobtype,
              x.customerabbr,
              x.remarks,
              (SELECT sc.daysar FROM sys_corporation sc WHERE sc.id = x.customerid LIMIT 1) AS daysar,
              (CASE WHEN iscomplete_ar THEN '是' ELSE '否' END) as complete_ar_status,
              (CASE WHEN iscomplete_ap THEN '是' ELSE '否' END) as complete_ap_status,
              (SELECT string_agg(su.namec::text, ','::text) FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C'
              AND sua.linkid = (CASE WHEN x.jobtype = 'S' THEN (SELECT bus_shipping.id FROM bus_shipping WHERE jobid = x.id LIMIT 1)
                                     WHEN x.jobtype = 'A' THEN (SELECT bus_air.id FROM bus_air WHERE jobid = x.id LIMIT 1)
                                     WHEN x.jobtype = 'D' THEN (SELECT bus_commerce.id FROM bus_commerce WHERE jobid = x.id LIMIT 1) END)) AS cusname,
             (CASE WHEN x.jobtype = 'S' THEN (SELECT to_char(etd,'yyyy-MM-dd') FROM bus_shipping WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'A' THEN (SELECT to_char(singtime,'yyyy-MM-dd') FROM bus_air WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'L' THEN (SELECT to_char(loadtime,'yyyy-MM-dd') FROM bus_truck WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'D' THEN (SELECT to_char(etd,'yyyy-MM-dd') FROM bus_commerce WHERE jobid = x.id LIMIT 1) END)          AS etd,
             (CASE WHEN x.jobtype = 'S' THEN (SELECT to_char(eta,'yyyy-MM-dd') FROM bus_shipping WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'A' THEN (SELECT to_char(eta,'yyyy-MM-dd') FROM bus_air WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'L' THEN ''
                   WHEN x.jobtype = 'D' THEN (SELECT to_char(eta,'yyyy-MM-dd') FROM bus_commerce WHERE jobid = x.id LIMIT 1) END)             eta,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT productname FROM bus_commerce WHERE jobid = x.id LIMIT 1) END) AS productname,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT deliverynamec FROM bus_commerce WHERE jobid = x.id LIMIT 1) END) AS deliverynamec,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT (CASE WHEN bc.wmsindate IS NULL THEN bc.bkgw ELSE bc.gw END) FROM bus_commerce bc WHERE bc.jobid = x.id AND bc.isdelete = FALSE)
              ELSE (SELECT SUM((CASE WHEN bc.wmsindate IS NULL THEN bc.bkgw ELSE bc.gw END)) FROM fina_jobs fj, bus_commerce bc WHERE fj.id = bc.jobid AND fj.isdelete = FALSE AND fj.parentid = x.id) END) AS gw,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT (CASE WHEN bc.wmsindate IS NULL THEN bc.bkvol ELSE bc.vol END) FROM bus_commerce bc WHERE bc.jobid = x.id AND bc.isdelete = FALSE)
              ELSE (SELECT SUM((CASE WHEN bc.wmsindate IS NULL THEN bc.bkvol ELSE bc.vol END)) FROM fina_jobs fj, bus_commerce bc WHERE fj.id = bc.jobid AND fj.isdelete = FALSE AND fj.parentid = x.id) END) AS vol,
             (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = x.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = x.id ) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = x.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
             (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = x.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = x.id ) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = x.id) THEN '未付款' ELSE '部分付款' END) AS apstatus,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb,
             (CASE WHEN (SELECT COUNT(1) AS c FROM (SELECT t.corpid, t.customerid, t.currency,COALESCE (t.amount, 0) + COALESCE (t2.amount, 0) AS amount FROM (SELECT fa.corpid, customerid, currency, sum(CASE WHEN araptype = 'AR' THEN amount ELSE -1 * amount END) AS amount FROM fina_arap fa WHERE fa.jobid = x.id AND fa.isdelete = FALSE AND fa.rptype != 'O' AND EXISTS (SELECT 1 FROM sys_corporation WHERE id = fa.customerid AND isdelete = FALSE AND iscustomer = FALSE) GROUP BY fa.corpid, customerid, currency) t
             LEFT JOIN (SELECT fa.corpid, customerid, currency, sum(CASE WHEN araptype = 'AR' THEN amount ELSE -1 * amount END) AS amount FROM fina_arap fa WHERE fa.jobid = x.id AND fa.isdelete = FALSE AND fa.rptype != 'O' AND EXISTS (SELECT 1 FROM sys_corporation WHERE id = fa.customerid AND isdelete = FALSE AND iscustomer = FALSE) GROUP BY fa.corpid, customerid, currency) t2 ON (t2.customerid = t.corpid AND t2.corpid = t.customerid AND t2.currency = t.currency) ) TT WHERE TT.amount != 0) > 0 THEN '否' ELSE '是' END) as amendeq
        FROM fina_jobs x WHERE x.isdelete = FALSE AND (x.id = $id$ OR x.parentid = $id$)
        ORDER BY (CASE x.jobtype WHEN 'D' THEN 0 ELSE 1 END) DESC  LIMIT 1000 OFFSET 0) result) json;
    </select>
    <!--查询已删除列表-->
    <select id="base.commerce.jobsdellist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS jobsdellist
        FROM (SELECT fj.id           as id,
                     fj.parentid     as parentid,
                     fj.nos          as nos,
                     fj.jobdate      as jobdate,
                     fj.joborderid   as joborderid,
                     fj.jobtype      as jobtype,
                     fj.ldtype2      as ldtype2,
                     fj.inputer      as inputer,
                     fj.inputtime    as inputtime,
                     fj.updater      as updater,
                     fj.updatetime   as updatetime,
                     fj.sales        as sales,
                     fj.customerabbr as customerabbr,
                     fj.remarks      as remarks,
                     fj.refno2       as refno2,
                     fj.refno        as refno,
                     bc.etd          as etd,
                     bc.ponum        as ponum
              FROM fina_jobs fj,
                   bus_commerce bc
              WHERE fj.id = bc.jobid
                AND fj.isdelete = true
                AND fj.jobtype = 'D'
              ORDER BY fj.jobdate DESC LIMIT 1000 OFFSET 0) json;
    </select>
    <!--查询轨迹列表-->
    <select id="base.commerce.queryJob" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS query
        FROM (SELECT jobs.*
              FROM (
              SELECT fj.id           as id,
                     fj.parentid     as parentid,
                     fj.nos          as nos,
                     fj.jobdate      as jobdate,
                     fj.joborderid   as joborderid,
                     fj.jobtype      as jobtype,
                     fj.ldtype2      as ldtype2,
                     fj.inputer      as inputer,
                     fj.inputtime    as inputtime,
                     fj.updater      as updater,
                     fj.updatetime   as updatetime,
                     fj.sales        as sales,
                     fj.customerabbr as customerabbr,
                     fj.remarks      as remarks,
                     fj.refno2       as refno2,
                     fj.refno        as refno,
                     (CASE WHEN fj.jobtype = 'D' THEN (SELECT etd FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                           WHEN fj.jobtype = 'S' THEN (SELECT etd FROM bus_shipping WHERE jobid = fj.id LIMIT 1)
                           WHEN fj.jobtype = 'A' THEN (SELECT singtime FROM bus_air WHERE jobid = fj.id LIMIT 1) END) as etd,
                     (CASE WHEN fj.jobtype = 'D' THEN (SELECT ponum FROM bus_commerce WHERE jobid = fj.id LIMIT 1) END) as ponum,
                     (CASE WHEN fj.jobtype = 'D' THEN (SELECT sonum FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                           WHEN fj.jobtype = 'S' THEN (SELECT sono FROM bus_shipping WHERE jobid = fj.id LIMIT 1)
                           WHEN fj.jobtype = 'A' THEN (SELECT sono FROM bus_air WHERE jobid = fj.id LIMIT 1) END) as sonum,
                     (CASE WHEN fj.jobtype = 'D' THEN (SELECT deliverytocode FROM bus_commerce WHERE jobid = fj.id LIMIT 1) END) as deliverytocode,
                     (CASE WHEN fj.jobtype = 'D' THEN (SELECT deliverynamec FROM bus_commerce WHERE jobid = fj.id LIMIT 1) END) as deliverynamec,
                     (select statusc from bus_goodstrack where fkid = fj.id AND iscs = true ORDER BY inputtime DESC limit 1) as newtrace
               FROM fina_jobs fj
              WHERE fj.isdelete = false $qry$ LIMIT 1000 OFFSET 0
             ) jobs WHERE 1 = 1 $qryno$ ) json;
    </select>
    <!--查询工作单-->
    <select id="base.commerce.fina_jobs" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as jobs
        FROM (
                 SELECT fj.*,
                        (SELECT name FROM sys_department WHERE id = fj.deptid) AS depter,
                        (f_checkright('commerceworkdel',(SELECT id FROM sys_user x WHERE x.isdelete = FALSE AND x.id = $userid$ limit 1)) = 0) as commerceworkdel
                 FROM fina_jobs fj,
                      bus_commerce bc
                 WHERE fj.id = bc.jobid
                   AND fj.isdelete = FALSE
                   AND fj.id = $id$ $filter$
             ) json;
    </select>
    <!--查询委托单-->
    <select id="base.commerce.bus_commerce" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as commerce
        FROM (
                 SELECT bc.*
                 FROM fina_jobs fj,
                      bus_commerce bc
                 WHERE fj.id = bc.jobid
                   AND fj.isdelete = FALSE
                   AND fj.id = $id$ $filter$
             ) json;
    </select>
    <!--查詢轨迹列表-->
    <select id="base.commerce.goodstracklist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS json
        FROM (SELECT fj.id,
                     fj.nos,
                     fj.jobdate,
                     fj.jobtype,
                     bc.ponum,
                     bc.fbaref,
                     bc.sonum,
                     to_char(wmsindate, 'yyyy-MM-dd') AS wmsindate,
                     bc.etd,
                     bc.eta,
                     bc.productname
              FROM fina_jobs fj,
                   bus_commerce bc
              WHERE fj.id = bc.jobid
                AND fj.isdelete = FALSE
                AND fj.jobtype = 'D'
                AND fj.parentid IS NOT NULL
                  $qry$
              ORDER BY fj.inputtime DESC
                  LIMIT 10) json;
    </select>
    <!--查詢电商单轨迹节点-->
    <select id="base.commerce.goodstrack" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS goodstrack
        FROM (
                 SELECT t.id,t.statusc,to_char(t.inputtime, 'yyyy-MM-dd hh24:mi') AS inputtime
                 FROM bus_goodstrack t
                 WHERE fkid = $id$
                 AND iscs = true
                 ORDER BY t.inputtime desc
             ) json;
    </select>
    <!--查詢传统整柜轨迹节点-->
    <select id="base.commerce.goodstrack_ship" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS goodstrack
        FROM (
                 SELECT t.id, t.statusc, to_char(t.inputtime, 'yyyy-MM-dd hh24:mi') AS inputtime
                 FROM bus_goodstrack t
                 WHERE fkid = $id$
                   AND iscs = true
                 UNION ALL
                 SELECT bsct.id                                      as id
                      , bsct.statuse                                 as statusc
                      , to_char(bsct.dealdate, 'yyyy-MM-dd hh24:mi') as inputtime
                 FROM bus_ship_booking bsb
                          LEFT JOIN bus_ship_book_cnt bsbc ON bsb.ID = bsbc.linkid
                          LEFT JOIN bus_ship_container_track bsct ON bsbc.ID = bsct.linkid AND bsct.statuse IS NOT NULL
                          inner join bus_ship_container bsc on bsc.isdelete = false and bsc.parentid is null
                     and coalesce(bsc.cntno, '') != '' and bsc.jobid = $id$ and bsb.sono = bsc.sono and bsbc.cntno = bsc.cntno
                 WHERE bsct.ID IS NOT NULL
                 ORDER BY inputtime desc
             ) json;
    </select>
    <!--查詢操作节点-->
    <select id="base.commerce.querynode" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as node
        FROM (
                 SELECT bcn.*
                 FROM bus_commerce_node bcn
                 WHERE bcn.isdelete = FALSE
                   AND bcn.jobid = $id$ LIMIT 300 OFFSET 0
             ) json;
    </select>
    <!--查詢操作日志-->
    <select id="base.commerce.querylog" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS log
        FROM (
                 SELECT bo.id,
                        bo.jobid,
                        bo.linkid,
                        bo.optype,
                        bo.opdesc,
                        bo.remarks,
                        (SELECT namec FROM sys_user WHERE (code = bo.opusr or namec = bo.opusr) LIMIT 1) AS opusr,
                        to_char(bo.optime, 'yyyy-MM-dd hh24:mi')                                         AS optime
            FROM bus_optrack bo
                 WHERE bo.jobid = $id$
                 ORDER BY bo.optime DESC LIMIT 300 OFFSET 0
             ) json;
    </select>
    <!--查询mbl 海运列表-->
    <select id="base.commerce.marge_mbl_ship" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS json
        FROM (
                 SELECT fj.id,
                        fj.nos,
                        fj.customerabbr,
                        fj.jobtype,
                        fj.ldtype2,
                        fj.corpid,
                        fj.saleid,
                        (SELECT namec from sys_user where id = fj.saleid LIMIT 1) AS sales,
                        fj.jobdate,
                        fj.remarks,
                        fj.inputer,
                        fj.inputtime,
                        bs.etd,
                        bs.eta,
                        bs.piece  AS piece,
                        bs.grswgt AS grswgt,
                        bs.cbm    AS cbm
                 FROM fina_jobs fj,
                      bus_shipping bs
                 WHERE fj.id = bs.jobid
                   AND fj.jobtype = 'S'
                   AND fj.parentid IS NULL
                   AND fj.isdelete = FALSE
                   AND fj.corpid IN (11540072274,1122274)
                   AND (CASE WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516230252274 THEN fj.nos ilike 'TSZ%' OR fj.nos ilike 'TBZ%'
                             WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516228802274 THEN fj.nos ilike 'TAE%'
                             WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516239022274 THEN fj.nos ilike 'TDA%'
                             WHEN (select corpid from sys_user where id = $userid$ limit 1) = 1122274 THEN fj.nos ilike 'GQDE%'
                             WHEN (select corpid from sys_user where id = $userid$ limit 1) = 100 THEN fj.nos ilike '%%' END)
                    $qry$ $filter$
                 ORDER BY fj.ldtype2 ASC, fj.inputtime desc
                     LIMIT 10 OFFSET 0
             ) json;
    </select>
    <!--查询mbl 空运列表-->
    <select id="base.commerce.marge_mbl_air" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS json
        FROM (
                 SELECT fj.id,
                        fj.nos,
                        fj.customerabbr,
                        fj.jobtype,
                        fj.ldtype2,
                        fj.corpid,
                        fj.saleid,
                        (SELECT namec from sys_user where id = fj.saleid LIMIT 1) AS sales,
                        fj.jobdate,
                        fj.remarks,
                        fj.inputer,
                        fj.inputtime,
                        ba.singtime AS etd,
                        ba.eta,
                        ba.piece  AS piece,
                        ba.weight AS grswgt,
                        ba.volume AS cbm
                 FROM fina_jobs fj,
                      bus_air ba
                 WHERE fj.id = ba.jobid
                   AND fj.jobtype = 'A'
                   AND fj.parentid IS NULL
                   AND fj.isdelete = FALSE
                   AND fj.corpid IN (11540072274,1122274)
                   AND (CASE WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516230252274 THEN fj.nos ilike 'TSZ%' OR fj.nos ilike 'TBZ%'
                             WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516228802274 THEN fj.nos ilike 'TAE%'
                             WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516239022274 THEN fj.nos ilike 'TDA%'
                             WHEN (select corpid from sys_user where id = $userid$ limit 1) = 1122274 THEN fj.nos ilike 'GQDE%'
                             WHEN (select corpid from sys_user where id = $userid$ limit 1) = 100 THEN fj.nos ilike '%%' END)
                   $qry$ $filter$
                 ORDER BY fj.ldtype2 ASC, fj.inputtime desc
                     LIMIT 10 OFFSET 0
             ) json;
    </select>
    <!--查询hbl列表-->
    <select id="base.commerce.marge_hbl" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS json
        FROM (
        SELECT fj.id,
               fj.nos,
               fj.customerabbr,
               fj.jobtype,
               fj.ldtype2,
               fj.corpid,
               fj.saleid,
               (SELECT namec from sys_user where id = fj.saleid LIMIT 1) AS sales,
               fj.jobdate,
               fj.remarks,
               fj.inputer,
               TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') AS inputtime,
               TO_CHAR(bc.etd, 'yyyy-MM-dd') AS etd,
               TO_CHAR(bc.eta, 'yyyy-MM-dd') AS eta,
               bc.ponum,
               bc.jobstatus,
               TO_CHAR(bc.mergedate, 'yyyy-MM-dd') AS mergedate,
               (case when bc.wmsindate is null then bc.bkgw else bc.gw END)                                                AS gw,
               (case when bc.wmsindate is null then bc.bkvol else bc.vol END)                                              AS vol,
               bc.pkgnum                                                                                                   AS pkgnum,
               bc.bkpkgnum                                                                                                 AS bkpkgnum,
               bc.productname,
               bc.estimatedeliverydate,
               TO_CHAR(bc.wmsindate, 'yyyy-MM-dd') AS wmsindate,
               (SELECT string_agg(bp.factoryname, ' ') FROM bus_packlist bp where bp.isfast = false AND bp.isdelete = FALSE AND bp.linkid = fj.id) as cargoname,
               bc.remark,
               bc.mark,
               bc.declaretype,
               (SELECT namec FROM dat_filedata WHERE fkcode = 1260 AND code = bc.cargotype LIMIT 1) as cargotype,
               bc.declareremarks,
               bc.deliverytocode,
               bc.deliverynamec,
               (select x.namec from sys_user x, sys_user_assign y where x.id = y.userid and y.roletype = 'C' and y.linkid = bc.id LIMIT 1) as cusservice
         FROM fina_jobs fj, bus_commerce bc
        WHERE fj.id = bc.jobid
          AND fj.jobtype = 'D'
          AND fj.parentid IS NOT NULL
          AND fj.parentid <![CDATA[ <> ]]> 0
          AND fj.isdelete = FALSE
          AND (CASE WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516230252274 THEN fj.nos ilike 'TSZ%' OR fj.nos ilike 'TBZ%'
                    WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516228802274 THEN fj.nos ilike 'TAE%'
                    WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516239022274 THEN fj.nos ilike 'TDA%'
                    WHEN (select corpid from sys_user where id = $userid$ limit 1) = 1122274 THEN fj.nos ilike 'GQDE%'
                    WHEN (select corpid from sys_user where id = $userid$ limit 1) = 100 THEN fj.nos ilike '%%' END)
          $qry$
        ORDER BY bc.mergedate ASC LIMIT 1000 OFFSET 0
            ) json;
    </select>
    <!--查询未合并列表-->
    <select id="base.commerce.marge_single" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS json
        FROM (
        SELECT fj.id,
               fj.nos,
               fj.customerabbr,
               fj.jobtype,
               fj.ldtype2,
               fj.corpid,
               fj.saleid,
               (SELECT namec from sys_user where id = fj.saleid LIMIT 1) AS sales,
               fj.jobdate,
               fj.remarks,
               fj.inputer,
               TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') AS inputtime,
               TO_CHAR(bc.etd, 'yyyy-MM-dd') AS etd,
               TO_CHAR(bc.eta, 'yyyy-MM-dd') AS eta,
               bc.ponum,
               bc.jobstatus,
               TO_CHAR(bc.mergedate, 'yyyy-MM-dd') AS mergedate,
               (case when bc.wmsindate is null then bc.bkgw else bc.gw END)                                                AS gw,
               (case when bc.wmsindate is null then bc.bkvol else bc.vol END)                                              AS vol,
               bc.pkgnum                                                                                                   AS pkgnum,
               bc.bkpkgnum                                                                                                 AS bkpkgnum,
               bc.productname,
               bc.estimatedeliverydate,
               TO_CHAR(bc.wmsindate, 'yyyy-MM-dd') AS wmsindate,
               (SELECT string_agg(distinct bp.factoryname, ' ') FROM bus_packlist bp where bp.isfast = false AND bp.isdelete = FALSE AND bp.linkid = fj.id) as cargoname,
               bc.remark,
               bc.mark,
               bc.declaretype,
               (SELECT namec FROM dat_filedata WHERE fkcode = 1260 AND code = bc.cargotype LIMIT 1) as cargotype,
               bc.declareremarks,
               bc.deliverytocode,
               bc.deliverynamec,
               (select x.namec from sys_user x, sys_user_assign y where x.id = y.userid and y.roletype = 'C' and y.linkid = bc.id limit 1) as cusservice
               FROM fina_jobs fj, bus_commerce bc
        WHERE fj.id = bc.jobid
          AND fj.jobtype = 'D'
          AND fj.parentid = 0
          AND fj.isdelete = FALSE
          AND (CASE WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516230252274 THEN fj.nos ilike 'TSZ%' OR fj.nos ilike 'TBZ%' OR fj.nos ilike 'TXM%'
            WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516228802274 THEN fj.nos ilike 'TAE%'
            WHEN (select deptid from sys_user where id = $userid$ limit 1) = 516239022274 THEN fj.nos ilike 'TDA%'
            WHEN (select corpid from sys_user where id = $userid$ limit 1) = 1122274 THEN fj.nos ilike 'GQDE%'
            WHEN (select corpid from sys_user where id = $userid$ limit 1) = 100 THEN fj.nos ilike '%%' END)
            $qry$ $filter$ $orderby$ LIMIT 1000 OFFSET 0
            ) json;
    </select>
    <!--工作单跳转-->
    <select id="base.commerce.querynos" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT as nos
        FROM (
                 SELECT x.id, x.nos, x.sales, x.customerabbr, x.jobdate,
                        (SELECT nos FROM fina_jobs WHERE id = x.parentid LIMIT 1) AS pnos, y.ponum
                 FROM fina_jobs x,bus_commerce y
                 WHERE x.id = y.jobid AND x.isdelete = FALSE AND x.jobtype = 'D' $nos$ $filter$
                 LIMIT 10
             ) json;
    </select>
    <!--工作单费用页面跳转-->
    <select id="base.commerce.querynosarap" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as nosarap
        FROM (SELECT fj.id, fj.nos, fj.customerid
              FROM fina_jobs fj
              WHERE fj.isdelete = FALSE $nos$ $filter$
              LIMIT 1) json;
    </select>
    <!--查询快速入仓工作单-->
    <select id="base.commerce.quickFinajobs" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as jobs
        FROM (
                 SELECT fj.*, (SELECT depter FROM sys_user WHERE id = fj.saleid) AS depter
                 FROM fina_jobs fj,
                      bus_commerce bc
                 WHERE fj.id = bc.jobid
                   AND fj.isdelete = FALSE
                   AND fj.id = $id$
             ) json;
    </select>
    <!--查询快速入仓委托单-->
    <select id="base.commerce.quickBusCommerce" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as commerce
        FROM (
                 SELECT bc.*,
                        to_char(bc.wmsindate, 'yyyy-MM-dd hh24:mi') as wmsintime
                 FROM fina_jobs fj,
                      bus_commerce bc
                 WHERE fj.id = bc.jobid
                   AND fj.isdelete = FALSE
                   AND fj.id = $id$
             ) json;
    </select>
    <!--查询快速入仓装箱单-->
    <select id="base.commerce.quickBusPacklist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) as buspacklist
        FROM (
                 SELECT bp.*,
                        to_char(bp.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime
                 FROM bus_packlist bp,
                      fina_jobs fj
                 WHERE fj.id = bp.linkid
                   AND fj.isdelete = FALSE
                   AND bp.isdelete = FALSE
                   AND bp.isfast = TRUE
                   AND fj.id = $id$
                 ORDER BY bp.inputtime DESC LIMIT 10000 OFFSET 0
             ) json;
    </select>
    <!--查询 入仓列表-->
    <select id="base.commerce.BusPacklistData" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) as buspacklist
        FROM (
                 SELECT fj.nos                                     as nos,
                        bc.jobid                                   as jobid,
                        fj.ldtype2                                 as ldtype2,
                        (SELECT namec FROM dat_filedata WHERE fkcode = 1260 AND code = bc.cargotype LIMIT 1) as cargotype,
                        (SELECT namec from sys_user where id = fj.saleid LIMIT 1) AS sales,
                        fj.customerabbr                            as customerabbr,
                        fj.remarks                                 as remark,
                        bp.cbmlength                               as cbmlength,
                        bp.cbmwidth                                as cbmwidth,
                        bp.cbmheight                               as cbmheight,
                        bp.piece                                   as piece,
                        bp.grswgt                                  as grswgt,
                        bp.cbm                                     as cbm,
                        bp.grswgttotal                             as grswgttotal,
                        bp.inputer                                 as inputer,
                        TO_CHAR(bp.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                        bc.productname                             as productname,
                        TO_CHAR(bc.wmsindate, 'yyyy-MM-dd')        as wmsindate
                 FROM bus_packlist bp,
                      bus_commerce bc,
                      fina_jobs fj
                 WHERE fj.id = bc.jobid
                   AND fj.id = bp.linkid
                   AND fj.isdelete = FALSE
                   AND bp.isdelete = FALSE
                   AND bp.isfast = TRUE $qry$
                 ORDER BY bp.id DESC LIMIT 10000
             ) json;
    </select>
    <!--查询 库存列表-->
    <select id="base.commerce.InventoryData" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) as inventorydata
        FROM (
                 SELECT fj.nos                                      as nos,
                        fj.id                                       as jobid,
                        fj.ldtype2                                  as ldtype2,
                        (SELECT namec FROM dat_filedata WHERE fkcode = 1260 AND code = bc.cargotype LIMIT 1) as cargotype,
                        (SELECT namec from sys_user where id = fj.saleid LIMIT 1) AS sales,
                        fj.customerabbr                             as customerabbr,
                        fj.remarks                                  as remark,
                        fj.inputer                                  as inputer,
                        bp.cbmlength                                as cbmlength,
                        bp.cbmwidth                                 as cbmwidth,
                        bp.cbmheight                                as cbmheight,
                        bp.piece                                    as piece,
                        bp.grswgt                                   as grswgt,
                        bp.cbm                                      as cbm,
                        bp.grswgttotal                              as grswgttotal,
                        TO_CHAR(fj.inputtime, 'yyyy-MM-dd hh24:mi') as inputtime,
                        bc.productname                              as productname,
                        TO_CHAR(bcn.whentrydate, 'yyyy-MM-dd')      as wmsindate,
                        TO_CHAR(bcn.outbounddate, 'yyyy-MM-dd')     as outbounddate
                 FROM fina_jobs fj,
                      bus_packlist bp,
                      bus_commerce bc,
                      bus_commerce_node bcn
                 WHERE fj.id = bc.jobid
                   AND fj.id = bcn.jobid
                   AND fj.id = bp.linkid
                   AND fj.isdelete = FALSE
                   AND bp.isdelete = FALSE
                   AND bcn.outbounddate is null
                   AND bcn.whentrydate is not null
                   AND bp.isfast = TRUE $qry$
                 ORDER BY bp.id DESC LIMIT 10000
             ) json;
    </select>
    <!--箱单发票工作单页面展示-->
    <select id="base.commerce.packlist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as buspacklist
        FROM (
                 SELECT bp.factoryname,
                        bp.factorynamee,
                        bp.markno,
                        bp.sku,
                        bp.referenceid,
                        bp.shipmentid,
                        bp.piece,
                        bp.piece2,
                        bp.packagee,
                        bp.cntype,
                        bp.grswgttotal,
                        bp.netweight,
                        bp.grswgt,
                        bp.cbmlength,
                        bp.cbmwidth,
                        bp.cbmheight,
                        bp.cbm,
                        bp.cbm2,
                        bp.price,
                        bp.piece3,
                        bp.priceall,
                        bp.outerpackagecode,
                        bp.importingcountry,
                        bp.taxrate,
                        bp.materialnamec,
                        bp.materialnamee,
                        bp.usagenamec,
                        bp.usagenamee,
                        bp.brandnamec,
                        bp.brandnamee,
                        bp.modelnamec,
                        bp.modelnamee,
                        bp.producturl,
                        bp.remark
                 FROM bus_packlist bp,
                      fina_jobs fj
                 WHERE fj.id = bp.linkid
                   AND fj.isdelete = FALSE
                   AND bp.isdelete = FALSE
                   AND bp.isregister = TRUE
                   AND fj.id = $id$ $filter$
                 order by bp.id LIMIT 10000 OFFSET 0
             ) json;
    </select>
    <!--箱单发票明细-->
    <select id="base.commerce.bus_packlist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as buspacklist
        FROM (
                 SELECT bp.*
                      , (SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT
                         from (select filename as name, url from sys_attachment where linkid = bp.id) json) as filelist
                      , (SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT
                         from (select bccm.*
                                    , (SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT
                                       from (select filename as name, url from sys_attachment sa where sa.linkid = bccm.id) json) as filelist
                               from bus_commerce_cargo_mixed bccm
                               where bccm.ctnsid = bp.id) json
                 )                                                                                          as buscommercecargomixedlist
                 FROM bus_packlist bp,
                      fina_jobs fj
                 WHERE fj.id = bp.linkid
                   AND fj.isdelete = FALSE
                   AND bp.isdelete = FALSE
                   AND bp.isregister = TRUE
                   AND fj.id = $id$
                 order by bp.id LIMIT 10000 OFFSET 0
             ) json;
    </select>
    <select id="pages.module.commerce.busCommonBean.grid.page" parameterClass="java.util.Map"
            resultClass="java.util.HashMap">
	<![CDATA[
        SELECT DISTINCT t.id, prefix, code, r.datefm, t.namec
        FROM sys_busnodesc t,
             sys_busnorule r
        WHERE $qry$
          AND t.id = r.busnotypeid
          AND code like 'commerce%'
          AND t.isdelete = FALSE
          AND r.isdelete = FALSE
          AND code NOT LIKE 'fina_jobs_air%'
          AND code NOT LIKE 'fina_jobs_lan%'
          AND code NOT LIKE 'fina_jobs_train%'
          AND code NOT LIKE 'fina_jobs_customs%'
          AND code NOT LIKE 'fina_jobs_fee%'

        order by t.namec, r.datefm, prefix
        ]]>
	</select>

    <select id="pages.module.commerce.busCommonBean.grid.count" parameterClass="java.util.Map"
            resultClass="java.util.HashMap">
        select 10000 AS counts
    </select>

    <select id="base.commerce.buspackbrieflylist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as buspackbrieflylist
        FROM (
                 SELECT bp.id
                      , bp.linkid
                      , bp.factoryname
                      , bp.piece
                      , bp.packagee
                      , bp.grswgt
                      , bp.cbmlength
                      , bp.cbmwidth
                      , bp.cbmheight
                      , bp.cbm
                 FROM bus_packlist bp,
                      fina_jobs fj
                 WHERE fj.id = bp.linkid
                   AND fj.isdelete = FALSE
                   AND bp.isdelete = FALSE
                   AND fj.id = $jobid$
                 order by bp.id
             ) json;
    </select>

    <select id="base.commerce.bus_commerce.sysgriddeflist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS json
        FROM (SELECT *
              FROM sys_griddef fj
              WHERE fj.gridid = $gridid$
                AND (fj.userid = $userid$ or fj.userid = (select corpid FROM sys_user where id = $userid$ limit 1))
        order by id) json
    </select>
    <!--途C对外提供查詢轨迹节点-->
    <select id="base.commerce.goodstrack.trackingRef" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS tracking
        FROM (
                 SELECT to_char(t.inputtime, 'yyyy-MM-dd hh24:mi')as time, t.statusc as context
                 FROM bus_goodstrack t
                 WHERE fkid = $trackingRef$
                   AND iscs = true
                 ORDER BY id asc
             ) json;
    </select>
    <!--途C对外提供查詢轨迹节点 信息-->
    <select id="base.commerce.trackingRef" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) :: TEXT as tracking
        FROM (
                 SELECT bc.nos             as jobNum,
                        bc.bkpkgnum        as packages,
                        bc.destcountrycode as destCountryCode,
                        bc.deliverystatus  as status
                 FROM bus_commerce bc
                 WHERE bc.jobid = $trackingRef$
                   AND bc.isdelete = false
             ) json;
    </select>
    <!--途C对外提供查詢轨迹节点 id-->
    <select id="base.commerce.tracking" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT bc.jobid
        FROM bus_commerce bc
        WHERE bc.isdelete = false
          AND bc.nos = $trackingRef$ limit 1;
    </select>

    <!--查询电商权限-->
    <select id="base.commerce.auth" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT row_to_json(json) as auth
        FROM ( SELECT (f_checkright('viewCommerceJobs', id) <![CDATA[ <> ]]> 0)    as viewmbl,
                      (f_checkright('commerceworkadd', id) <![CDATA[ <> ]]> 0)     as addjob,
                      (f_checkright('viewcomplete', id) <![CDATA[ <> ]]> 0)     as viewcomplete,
                      (f_checkright('commerceworkrelease', id) <![CDATA[ <> ]]> 0) as release,
                      (f_checkright('commerceMergeJob', id) <![CDATA[ <> ]]> 0) as mergejob,
                      (f_checkright('JobsComplete', id) <![CDATA[ <> ]]> 0)         as iscomplete
                 FROM sys_user
                 WHERE id = $userid$ LIMIT 1
             ) json;
    </select>

    <!--查询业务业绩统计报表-->
    <select id="base.commerce.saleprolist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS saleprolist
        FROM (
        SELECT
            saleid,sales,COUNT(nos) as nostotal,sum(cntnum) as cnttotal,sum(chargeweight) as chargeweight,sum(cbm) as cbmtotal,
            SUM(arrears) as arrears,SUM(aprears) as aprears,SUM(amountar) as amountar,SUM(amountap) as amountap,
            SUM(profitrmb) as profitrmb,CASE WHEN SUM(amountar) <![CDATA[ <> ]]> 0 THEN round((SUM(profitrmb) / SUM(amountar) * 100),2) || '%' END as rate
        FROM (
              SELECT
              fj.nos,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN bc.saleidop ELSE fj.saleid END) AS saleid,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (SELECT t.namec FROM sys_user t WHERE t.id = bc.saleidop LIMIT 1) ELSE (SELECT namec from sys_user where id = fj.saleid LIMIT 1) END) AS sales,
              bc.vol as cbm,
              bc.chargeweight as chargeweight,
              0 AS cntnum,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) AS amountar,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) AS amountap,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS aprears
              FROM fina_jobs fj, bus_commerce bc
              WHERE fj.id = bc.jobid
              AND fj.jobtype = 'D'
              AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $hqry$ $etdsql$

              UNION ALL

              SELECT
              fj.nos,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN 782340902274 WHEN fj.deptop = 516228802274 THEN 695226382274 WHEN fj.deptop = 1565607982274 THEN 1567151552274 END) ELSE fj.saleid END) AS saleid,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN '途C北美操作部' WHEN fj.deptop = 516228802274 THEN '途C中东操作部' WHEN fj.deptop = 1565607982274 THEN '途C非标准项目部' END) ELSE (SELECT namec from sys_user where id = fj.saleid LIMIT 1) END) AS sales,
              (SELECT SUM (cbm) from bus_ship_container where isdelete = false and jobid = fj.id) AS cbm,
              (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = fj.id) AS chargeweight,
              (SELECT sum(cnts.cnt) FROM (SELECT count(*)::NUMERIC * (case when left(cntypedesc, 2) = '20' then 1 when left(cntypedesc, 2) = '40' then 2 else 0 end)::NUMERIC AS cnt FROM _bus_ship_container WHERE shipid = bc.id AND isselect = TRUE AND isdelete = FALSE GROUP BY cntypedesc) cnts) as cntnum,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) AS amountar,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) AS amountap,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS aprears
              FROM fina_jobs fj, bus_shipping bc
              WHERE fj.id = bc.jobid
              AND fj.jobtype = 'S'
              AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$ $etdsql$

              UNION ALL

              SELECT
              fj.nos,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN 782340902274 WHEN fj.deptop = 516228802274 THEN 695226382274 WHEN fj.deptop = 1565607982274 THEN 1567151552274 END) ELSE fj.saleid END) AS saleid,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN '途C北美操作部' WHEN fj.deptop = 516228802274 THEN '途C中东操作部' WHEN fj.deptop = 1565607982274 THEN '途C非标准项目部' END) ELSE (SELECT namec from sys_user where id = fj.saleid LIMIT 1) END) AS sales,
              (SELECT SUM (cbm) from bus_goods where isdelete = false and linkid = bc.id) AS cbm,
              (SELECT SUM (chargeweight) from bus_goods where isdelete = false and linkid = bc.id) as chargeweight,
              0 AS cntnum,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) AS amountar,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) AS amountap,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS aprears
              FROM fina_jobs fj, bus_air bc
              WHERE fj.id = bc.jobid
              AND fj.jobtype = 'A'
              AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$ $singsql$

              UNION ALL

              SELECT
              fj.nos,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN 782340902274 WHEN fj.deptop = 516228802274 THEN 695226382274 WHEN fj.deptop = 1565607982274 THEN 1567151552274 END) ELSE fj.saleid END) AS saleid,
              (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN '途C北美操作部' WHEN fj.deptop = 516228802274 THEN '途C中东操作部' WHEN fj.deptop = 1565607982274 THEN '途C非标准项目部' END) ELSE (SELECT namec from sys_user where id = fj.saleid LIMIT 1) END) AS sales,
              (SELECT SUM (cbm) from bus_ship_container where isdelete = false and jobid = bc.id) AS cbm,
              (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = bc.id) as chargeweight,
              0 AS cntnum,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) AS amountar,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) AS amountap,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears,
              (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS aprears
              FROM fina_jobs fj, bus_truck bc
              WHERE fj.id = bc.jobid
              AND fj.jobtype = 'L'
              AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$ $etdsql$

              UNION ALL

              SELECT
                  fj.nos,
                   (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN 782340902274 WHEN fj.deptop = 516228802274 THEN 695226382274 WHEN fj.deptop = 1565607982274 THEN 1567151552274 END) ELSE fj.saleid END) AS saleid,
                   (CASE WHEN fj.corpid <![CDATA[ <> ]]> 11540072274 AND (fj.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = fj.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN fj.deptop = 516230252274 THEN '途C北美操作部' WHEN fj.deptop = 516228802274 THEN '途C中东操作部' WHEN fj.deptop = 1565607982274 THEN '途C非标准项目部' END) ELSE (SELECT namec from sys_user where id = fj.saleid LIMIT 1) END) AS sales,
                   (SELECT SUM (cbm) from bus_ship_container where isdelete = false and jobid = bc.id) AS cbm,
                   (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = bc.id) as chargeweight,
                   0 AS cntnum,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) AS amountar,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) AS amountap,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = fj.id $corpsql$) -
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount))::NUMERIC(18,2), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = fj.id $corpsql$) as profitrmb,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS aprears
              FROM fina_jobs fj, bus_customs bc
              WHERE fj.id = bc.jobid
                AND fj.jobtype = 'C'
                AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$ $singsql$
        ) result
        GROUP BY saleid,sales
        ) json;
    </select>

    <!--业务明细统计-->
    <select id="base.commerce.salechild" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS salechild
        FROM (SELECT * FROM (
                SELECT x.id,
                       x.nos,
                       (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                       (SELECT namec from sys_user where id = y.saleidop LIMIT 1) AS salesop,
                       x.jobtype,
                       x.jobdate,
                       x.customerid,
                       x.customerabbr,
                       (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                       TO_CHAR(y.etd, 'yyyy-MM-dd') AS etd,
                       TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                       y.productname AS productname,
                       y.gw AS gw,
                       y.vol AS vol,
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                       (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                       (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                       (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                       (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                       (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_commerce y
              WHERE x.id = y.jobid
                AND x.jobtype = 'D'
                AND x.isdelete = FALSE
                AND (CASE WHEN x.corpid <![CDATA[ <> ]]> 11540072274 AND (x.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = x.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN y.saleidop ELSE x.saleid END) = $saleid$ $nossql$ $qry$ $etdsql$

              UNION ALL

              SELECT x.id,
                     x.nos,
                     (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                     (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                     x.jobtype,
                     x.jobdate,
                     x.customerid,
                     x.customerabbr,
                     (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                     TO_CHAR(y.etd, 'yyyy-MM-dd') AS etd,
                     TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                     '' AS productname,
                     (SELECT SUM(grswgt) from bus_ship_container where isdelete = false and jobid = x.id) AS gw,
                     (SELECT SUM(cbm) from bus_ship_container where isdelete = false and jobid = x.id) AS vol,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_shipping y
              WHERE x.id = y.jobid
                AND x.jobtype = 'S'
                AND x.isdelete = FALSE
                AND (CASE WHEN x.corpid <![CDATA[ <> ]]> 11540072274 AND (x.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = x.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN x.deptop = 516230252274 THEN 782340902274 WHEN x.deptop = 516228802274 THEN 695226382274 WHEN x.deptop = 1565607982274 THEN 1567151552274 END) ELSE x.saleid END) = $saleid$ $nossql$ $qry$ $etdsql$

              UNION ALL

              SELECT x.id,
                     x.nos,
                     (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                     (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                     x.jobtype,
                     x.jobdate,
                     x.customerid,
                     x.customerabbr,
                     (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                     TO_CHAR(y.singtime, 'yyyy-MM-dd') AS etd,
                     TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                     '' AS productname,
                     (SELECT SUM(grswgt) from bus_goods where isdelete = false and linkid = y.id) AS gw,
                     (SELECT SUM(cbm) from bus_goods where isdelete = false and linkid = y.id) AS vol,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_air y
              WHERE x.id = y.jobid
                AND x.jobtype = 'A'
                AND x.isdelete = FALSE
                AND (CASE WHEN x.corpid <![CDATA[ <> ]]> 11540072274 AND (x.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = x.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN x.deptop = 516230252274 THEN 782340902274 WHEN x.deptop = 516228802274 THEN 695226382274 WHEN x.deptop = 1565607982274 THEN 1567151552274 END) ELSE x.saleid END) = $saleid$ $nossql$ $qry$ $singsql$

              UNION ALL

              SELECT x.id,
                     x.nos,
                     (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                     (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                     x.jobtype,
                     x.jobdate,
                     x.customerid,
                     x.customerabbr,
                     (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                     TO_CHAR(y.loadtime, 'yyyy-MM-dd') AS etd,
                     '' AS eta,
                     '' AS productname,
                     (SELECT SUM(grswgt) from bus_ship_container where isdelete = false and jobid = x.id) AS gw,
                     (SELECT SUM(cbm) from bus_ship_container where isdelete = false and jobid = x.id) AS vol,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                     (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                     (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_truck y
              WHERE x.id = y.jobid
                AND x.jobtype = 'L'
                AND x.isdelete = FALSE
                AND (CASE WHEN x.corpid <![CDATA[ <> ]]> 11540072274 AND (x.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = x.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN x.deptop = 516230252274 THEN 782340902274 WHEN x.deptop = 516228802274 THEN 695226382274 WHEN x.deptop = 1565607982274 THEN 1567151552274 END) ELSE x.saleid END) = $saleid$  $nossql$ $qry$ $etdsql$

              UNION ALL

              SELECT x.id,
                   x.nos,
                   (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                   (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                   x.jobtype,
                   x.jobdate,
                   x.customerid,
                   x.customerabbr,
                   (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                   TO_CHAR(y.singtime, 'yyyy-MM-dd') AS etd,
                   TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                   '' AS productname,
                   (SELECT SUM(grswgt) from bus_ship_container where isdelete = false and jobid = x.id) AS gw,
                   (SELECT SUM(cbm) from bus_ship_container where isdelete = false and jobid = x.id) AS vol,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_customs y
              WHERE x.id = y.jobid
                AND x.jobtype = 'C'
                AND x.isdelete = FALSE
                AND (CASE WHEN x.corpid <![CDATA[ <> ]]> 11540072274 AND (x.corpidop = 11540072274 OR (SELECT EXISTS(SELECT 1 FROM fina_corp WHERE jobid = x.id AND corpid = 11540072274 AND isdelete = FALSE))) THEN (CASE WHEN x.deptop = 516230252274 THEN 782340902274 WHEN x.deptop = 516228802274 THEN 695226382274 WHEN x.deptop = 1565607982274 THEN 1567151552274 END) ELSE x.saleid END) = $saleid$  $nossql$ $qry$ $singsql$
             ) result ORDER BY jobdate DESC) json;
    </select>
    <!--查询业务量统计报表-->
    <select id="base.commerce.businessvol" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS businessvol
        FROM (SELECT
                        customerid,
                        customerabbr,
                        daysar,
                        COUNT(nos) as nostotal,
                        SUM(cntnum) as cnttotal,
                        SUM(cbm) as cbmtotal,
                        SUM(chargeweight) as chargeweight,
                        SUM(amountar) as amountar,
                        SUM(amountap) as amountap,
                        SUM(arrears) as arrears
              FROM (
                      SELECT
                      fj.nos,
                      fj.customerid,
                      (SELECT namec FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS customerabbr,
                      (SELECT daysar FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS daysar,
                      bc.vol as cbm,
                      bc.chargeweight as chargeweight,
                      0 AS cntnum,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountar,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountap,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears
                 FROM fina_jobs fj, bus_commerce bc
                 WHERE fj.id = bc.jobid
                   AND fj.jobtype = 'D'
                   AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $hqry$

                 UNION ALL

                 SELECT
                      fj.nos,
                      fj.customerid,
                      (SELECT namec FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS customerabbr,
                      (SELECT daysar FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS daysar,
                      (SELECT SUM (cbm) from bus_ship_container where isdelete = false and jobid = fj.id) AS cbm,
                      (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = fj.id) AS chargeweight,
                      (SELECT sum(cnts.cnt) FROM (SELECT count(*)::NUMERIC * (case when left(cntypedesc, 2) = '20' then 1 when left(cntypedesc, 2) = '40' then 2 else 0 end)::NUMERIC AS cnt FROM _bus_ship_container WHERE shipid = bc.id AND isselect = TRUE AND isdelete = FALSE GROUP BY cntypedesc) cnts) as cntnum,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountar,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountap,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears
                 FROM fina_jobs fj, bus_shipping bc
                 WHERE fj.id = bc.jobid
                   AND fj.jobtype = 'S'
                   AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$

                 UNION ALL

                 SELECT
                      fj.nos,
                      fj.customerid,
                      (SELECT namec FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS customerabbr,
                      (SELECT daysar FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS daysar,
                      (SELECT SUM (cbm) from bus_goods where isdelete = false and linkid = bc.id) AS cbm,
                      (SELECT SUM (chargeweight) from bus_goods where isdelete = false and linkid = bc.id) as chargeweight,
                      0 AS cntnum,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountar,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountap,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears
                 FROM fina_jobs fj, bus_air bc
                 WHERE fj.id = bc.jobid
                   AND fj.jobtype = 'A'
                   AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$

                 UNION ALL

                 SELECT
                      fj.nos,
                      fj.customerid,
                      (SELECT namec FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS customerabbr,
                      (SELECT daysar FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS daysar,
                      (SELECT SUM (cbm) from bus_ship_container where isdelete = false and jobid = bc.id) AS cbm,
                      (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = bc.id) as chargeweight,
                      0 AS cntnum,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountar,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountap,
                      (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears
                 FROM fina_jobs fj, bus_truck bc
                 WHERE fj.id = bc.jobid
                   AND fj.jobtype = 'L'
                   AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$

                UNION ALL

                SELECT
                    fj.nos,
                    fj.customerid,
                    (SELECT namec FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS customerabbr,
                    (SELECT daysar FROM sys_corporation WHERE id = fj.customerid LIMIT 1) AS daysar,
                    (SELECT SUM (cbm) from bus_ship_container where isdelete = false and jobid = bc.id) AS cbm,
                    (SELECT SUM (chargwgt) from bus_ship_container where isdelete = false and jobid = bc.id) as chargeweight,
                    0 AS cntnum,
                    (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountar,
                    (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AP' AND a.jobid = fj.id AND a.customerid = fj.customerid $corpsql$) AS amountap,
                    (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE fj.jobdate END), a.currency, 'CNY', a.amount - a.amtstl2)), 0) FROM fina_arap a WHERE a.isdelete = FALSE AND a.araptype = 'AR' AND a.rptype <![CDATA[ <> ]]> 'O' AND a.jobid = fj.id $corpsql$) AS arrears
                FROM fina_jobs fj, bus_customs bc
                WHERE fj.id = bc.jobid
                  AND fj.jobtype = 'C'
                  AND fj.isdelete = FALSE $qry$ $filter$ $nostype$ $mqry$
             ) result
        GROUP BY customerid,customerabbr,daysar
        $desc$
        LIMIT 30
            ) json;
    </select>
    <!--业务量明细统计-->
    <select id="base.commerce.customerchild" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS customerchild
        FROM (SELECT * FROM (
          SELECT x.id,
                 x.nos,
                 (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                 (SELECT namec from sys_user where id = y.saleidop LIMIT 1) AS salesop,
                 x.jobtype,
                 x.jobdate,
                 x.customerid,
                 x.customerabbr,
                 (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                 TO_CHAR(y.etd, 'yyyy-MM-dd') AS etd,
                 TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                 y.productname AS productname,
                 y.gw AS gw,
                 y.vol AS vol,
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                 (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                 (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                 (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                 (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                 (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
                 FROM fina_jobs x,bus_commerce y
                 WHERE x.id = y.jobid
                 AND x.jobtype = 'D'
                 AND x.isdelete = FALSE
                 AND x.customerid = $customerid$ $nossql$ $qry$

              UNION ALL

              SELECT x.id,
                  x.nos,
                  (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                  (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                  x.jobtype,
                  x.jobdate,
                  x.customerid,
                  x.customerabbr,
                  (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                  TO_CHAR(y.etd, 'yyyy-MM-dd') AS etd,
                  TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                  '' AS productname,
                  (SELECT SUM(grswgt) from bus_ship_container where isdelete = false and jobid = x.id) AS gw,
                  (SELECT SUM(cbm) from bus_ship_container where isdelete = false and jobid = x.id) AS vol,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_shipping y
              WHERE x.id = y.jobid
                AND x.jobtype = 'S'
                AND x.isdelete = FALSE
                AND x.customerid = $customerid$ $nossql$ $qry$

              UNION ALL

              SELECT x.id,
                  x.nos,
                  (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                  (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                  x.jobtype,
                  x.jobdate,
                  x.customerid,
                  x.customerabbr,
                  (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                  TO_CHAR(y.singtime, 'yyyy-MM-dd') AS etd,
                  TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                  '' AS productname,
                  (SELECT SUM(grswgt) from bus_goods where isdelete = false and linkid = y.id) AS gw,
                  (SELECT SUM(cbm) from bus_goods where isdelete = false and linkid = y.id) AS vol,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_air y
              WHERE x.id = y.jobid
                AND x.jobtype = 'A'
                AND x.isdelete = FALSE
                AND x.customerid = $customerid$ $nossql$ $qry$

              UNION ALL

              SELECT x.id,
                  x.nos,
                  (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                  (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                  x.jobtype,
                  x.jobdate,
                  x.customerid,
                  x.customerabbr,
                  (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                  TO_CHAR(y.loadtime, 'yyyy-MM-dd') AS etd,
                  '' AS eta,
                  '' AS productname,
                  (SELECT SUM(grswgt) from bus_ship_container where isdelete = false and jobid = x.id) AS gw,
                  (SELECT SUM(cbm) from bus_ship_container where isdelete = false and jobid = x.id) AS vol,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                  (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                  (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_truck y
              WHERE x.id = y.jobid
                AND x.jobtype = 'L'
                AND x.isdelete = FALSE
                AND x.customerid = $customerid$ $nossql$ $qry$

              UNION ALL

              SELECT x.id,
                   x.nos,
                   (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
                   (CASE WHEN x.deptop = 516230252274 THEN '途C北美操作部' WHEN x.deptop = 516228802274 THEN '途C中东操作部' WHEN x.deptop = 1565607982274 THEN '途C非标准项目部' ELSE '' END) AS salesop,
                   x.jobtype,
                   x.jobdate,
                   x.customerid,
                   x.customerabbr,
                   (SELECT su.namec FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND rolearea = 'TOC' AND sua.linkid = y.id LIMIT 1) AS cusname,
                   TO_CHAR(y.singtime, 'yyyy-MM-dd') AS etd,
                   TO_CHAR(y.eta, 'yyyy-MM-dd') AS eta,
                   '' AS productname,
                   (SELECT SUM(grswgt) from bus_ship_container where isdelete = false and jobid = x.id) AS gw,
                   (SELECT SUM(cbm) from bus_ship_container where isdelete = false and jobid = x.id) AS vol,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
                   (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
                   (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb
              FROM fina_jobs x,bus_customs y
              WHERE x.id = y.jobid
                AND x.jobtype = 'C'
                AND x.isdelete = FALSE
                AND x.customerid = $customerid$ $nossql$ $qry$
             ) result ORDER BY jobdate DESC) json;
    </select>
    <!--查询快速入仓数据列表-->
    <select id="base.commerce.queryWarehouseData" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) as buspacklist
        FROM (
                 SELECT s1.*,
                        (CASE WHEN s1.grswgt > s1.vw THEN s1.grswgt ELSE s1.vw END) AS bweight
                 FROM (SELECT bp.cbmlength                                            AS cbmlength,
                              bp.cbmwidth                                             AS cbmwidth,
                              bp.cbmheight                                            AS cbmheight,
                              bp.piece                                                AS piece,
                              bp.grswgt                                               AS grswgt,
                              bp.cbm                                                  AS cbm,
                              (CASE
                                   WHEN fj.jobtype = 'D' AND fj.ldtype2 = 'H' THEN (bp.cbmlength * bp.cbmwidth * bp.cbmheight) / 1000
                                   WHEN fj.jobtype = 'D' AND fj.ldtype2 = 'K' THEN (bp.cbmlength * bp.cbmwidth * bp.cbmheight) / 6000
                                   WHEN fj.jobtype = 'S' THEN (bp.cbmlength * bp.cbmwidth * bp.cbmheight) / 6000
                                  END)                                                AS vw,
                              (bp.cbmlength + (bp.cbmwidth * 2) + (bp.cbmheight * 2)) AS girth
                       FROM bus_packlist bp,
                            bus_commerce bc,
                            fina_jobs fj
                       WHERE fj.id = bc.jobid
                         AND fj.id = bp.linkid
                         AND fj.isdelete = FALSE
                         AND bp.isdelete = FALSE
                         AND bp.isfast = TRUE
                         AND fj.id = $id$
                       ORDER BY bp.id DESC LIMIT 10000
                       OFFSET 0) s1
                 ) json;
    </select>
    <!--查询快速入仓数据列表 汇总-->
    <select id="base.commerce.queryWarehouseTotal" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) as buspacktotal
        FROM (
                 SELECT sum(s1.piece)                                                    AS totalpiece,
                        sum(round(s1.grswgt,2))                                          AS totalgrswgt,
                        sum(round(s1.cbm,2))                                             AS totalcbm,
                        sum(round(s1.vw,2))                                              AS totalvw,
                        sum(round((CASE WHEN s1.grswgt > s1.vw THEN s1.grswgt ELSE s1.vw END),2)) AS totalbweight
                 FROM (SELECT bp.cbmlength                                            AS cbmlength,
                              bp.cbmwidth                                             AS cbmwidth,
                              bp.cbmheight                                            AS cbmheight,
                              bp.piece                                                AS piece,
                              bp.grswgttotal::NUMERIC                                 AS grswgt,
                              bp.cbm                                                  AS cbm,
                              (CASE
                                   WHEN fj.jobtype = 'D' AND fj.ldtype2 = 'H' THEN (bp.cbmlength * bp.cbmwidth * bp.cbmheight) / 1000
                                   WHEN fj.jobtype = 'D' AND fj.ldtype2 = 'K' THEN (bp.cbmlength * bp.cbmwidth * bp.cbmheight) / 6000
                                   WHEN fj.jobtype = 'S' THEN (bp.cbmlength * bp.cbmwidth * bp.cbmheight) / 6000
                                  END)                                                AS vw,
                              (bp.cbmlength + (bp.cbmwidth * 2) + (bp.cbmheight * 2)) AS girth
                       FROM bus_packlist bp,
                            bus_commerce bc,
                            fina_jobs fj
                       WHERE fj.id = bc.jobid
                         AND fj.id = bp.linkid
                         AND fj.isdelete = FALSE
                         AND bp.isdelete = FALSE
                         AND bp.isfast = TRUE
                         AND fj.id = $id$
                       ORDER BY bp.id DESC LIMIT 10000 OFFSET 0) s1
             ) json;
    </select>
    <!--拣货列表-->
    <select id="base.commerce.goodslist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) as goodslist
        FROM (SELECT bp.id           as id,
                     bc.jobid        as jobid,
                     fj.nos          as nos,
                     bp.packagee     as packagee,
                     fj.customerabbr as customerabbr,
                     bp.cbmlength    as cbmlength,
                     bp.cbmwidth     as cbmwidth,
                     bp.cbmheight    as cbmheight,
                     bp.piece        as piece,
                     bp.grswgt       as grswgt,
                     bp.cbm          as cbm,
                     bp.cbm2         as cbm2,
                     bp.grswgttotal  as grswgttotal,
                     bp.factoryname  as factoryname,
                     bp.factorynamee as factorynamee,
                     bp.remark       as remark
            FROM bus_packlist bp, bus_commerce bc, fina_jobs fj
           WHERE fj.id = bc.jobid
             AND fj.id = bp.linkid
             AND fj.isdelete = FALSE
             AND bp.isdelete = FALSE
             AND bp.isfast = FALSE $qry$
        ORDER BY bp.id DESC LIMIT 10000) json;
    </select>
    <!--查询信用额度-->
    <select id="base.user.creditchild" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS creditlist
        FROM (
                 SELECT
                      t.nos
                      ,t.endtime
                      ,t.guaranteeuser
                      ,SUM(amount) :: NUMERIC(18,2) as amount
			          ,SUM(guaranteeamount) :: NUMERIC(18,2) as guaranteeamount
			          ,t.prono
                      ,t.prodate
                      ,SUM(amt2) :: NUMERIC(18,2) as amt2
			          ,t.paymentdate
                 FROM
                    (SELECT
                    (SELECT nos FROM fina_jobs WHERE id = a.jobid AND isdelete =FALSE limit 1) AS nos
                    ,u.namec AS guaranteeuser
                    ,(SELECT to_char(endtime, 'yyyy-mm-dd hh24:mi') FROM bpm_task where processinstanceid = g.processinstanceid ORDER BY endtime DESC nulls last LIMIT 1) AS endtime
                    ,f_amtto(a.arapdate, a.currency, 'USD', a.amount) AS amount
                    ,(f_amtto(a.arapdate, a.currency, 'USD', a.amount)-f_amtto(a.arapdate, a.currency, 'USD', COALESCE((SELECT SUM(d.amountwf) FROM fina_actpayrecdtl d WHERE d.isdelete = FALSE AND d.arapid = a.id AND EXISTS(SELECT 1 FROM fina_actpayrec WHERE id = d.actpayrecid AND isdelete = FALSE AND rpdate > '2021-01-01')  GROUP BY d.arapid),0)))	AS guaranteeamount
                    ,b.nos AS prono
                    ,to_char(COALESCE(b.endtime,b.startedtime), 'YY-MM-DD HH:MM') AS prodate
                    ,COALESCE((SELECT SUM(d.amountwf) FROM fina_actpayrecdtl d WHERE d.isdelete = FALSE AND d.arapid = a.id AND EXISTS(SELECT 1 FROM fina_actpayrec WHERE id = d.actpayrecid AND isdelete = FALSE AND rpdate > '2021-01-01')  GROUP BY d.arapid),0) AS amt2
                    ,(SELECT distinct rpdate FROM fina_actpayrec WHERE id = ANY(select d.actpayrecid from fina_actpayrecdtl d where isdelete =false AND d.arapid = a.id) AND isdelete = FALSE limit 1) AS rpdate
                    ,(SELECT (SELECT NAMEC FROM sys_user WHERE id = j.saleid AND isdelete = FALSE) FROM fina_jobs j WHERE id = a.jobid AND isdelete =FALSE limit 1) AS sales
                    ,to_char(COALESCE(b.endtime,b.startedtime), 'YY-MM-DD HH:MM')	AS	guaranteedate
                    ,(SELECT TO_CHAR(val::DATE,'YYYY-MM-DD HH:MM') from bpm_processins_var WHERE name = 'paymentdate' AND processinstanceid = g.processinstanceid)	AS	paymentdate
                     FROM sys_user_guarantee g
		             LEFT JOIN sys_user u ON (u.id =g.userid AND u.isdelete = FALSE)
                     LEFT JOIN fina_arap a ON (a.id = g.arapid AND a.isdelete = FALSE)
                     LEFT JOIN	bpm_processinstance	b ON (b.id = g.processinstanceid AND b.isdelete = FALSE)
                 WHERE
                     f_amtto(a.arapdate, a.currency, 'USD', a.amount)!=f_amtto(a.arapdate, a.currency, 'USD', COALESCE((SELECT SUM(d.amountwf) FROM fina_actpayrecdtl d WHERE d.isdelete = FALSE AND d.arapid = a.id AND EXISTS(SELECT 1 FROM fina_actpayrec WHERE id = d.actpayrecid AND isdelete = FALSE AND rpdate > '2021-01-01')  GROUP BY d.arapid),0)) $qry$) t
                 GROUP BY t.prono,t.guaranteeuser,t.nos,t.endtime,t.prodate,t.paymentdate
                 LIMIT 1000 OFFSET 0
                 ) json;
    </select>
    <!--查询轨迹时效列表-->
    <select id="base.commerce.locuslist" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS locuslist
        FROM (SELECT fj.id           as id,
                     fj.nos          as nos,
                     fj.jobdate      as jobdate,
                     fj.jobtype      as jobtype,
                     fj.inputer      as inputer,
                     fj.inputtime    as inputtime,
                     fj.sales        as sales,
                     fj.customerabbr as customerabbr,
                     fj.remarks      as remarks,
                     (CASE
                          WHEN fj.jobtype = 'D' THEN (SELECT etd FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'S' THEN (SELECT etd FROM bus_shipping WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'A' THEN (SELECT singtime FROM bus_air WHERE jobid = fj.id LIMIT 1) END) as etd,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT eta FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'S' THEN (SELECT eta FROM bus_shipping WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'A' THEN (SELECT eta FROM bus_air WHERE jobid = fj.id LIMIT 1) END) as eta,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT voy FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'S' THEN (SELECT voyage FROM bus_shipping WHERE jobid = fj.id LIMIT 1) END) as voy,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT vsl FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'S' THEN (SELECT vessel FROM bus_shipping WHERE jobid = fj.id LIMIT 1) END) as vsl,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT polnamec FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'S' THEN (SELECT pol FROM bus_shipping WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'A' THEN (SELECT pol FROM bus_air WHERE jobid = fj.id LIMIT 1) END) as polnamec,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT podnamec FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'S' THEN (SELECT pod FROM bus_shipping WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'A' THEN (SELECT pod FROM bus_air WHERE jobid = fj.id LIMIT 1) END) as podnamec,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT deliverytocode FROM bus_commerce WHERE jobid = fj.id LIMIT 1) END) as deliverytocode,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT ponum FROM bus_commerce WHERE jobid = fj.id LIMIT 1) END) as ponum,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT sonum FROM bus_commerce WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'S' THEN (SELECT sono FROM bus_shipping WHERE jobid = fj.id LIMIT 1)
                          WHEN fj.jobtype = 'A' THEN (SELECT sono FROM bus_air WHERE jobid = fj.id LIMIT 1) END) as sonum,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT deliverytocode FROM bus_commerce WHERE jobid = fj.id LIMIT 1) END) as deliverytocode,
                    (CASE WHEN fj.jobtype = 'D' THEN (SELECT deliverynamec FROM bus_commerce WHERE jobid = fj.id LIMIT 1) END) as deliverynamec,
                    bg.statusc as trace,
                    (SELECT inputtime FROM bus_goodstrack where fkid = fj.id AND inputtime is not null order by inputtime desc LIMIT 1)::DATE -
                    (SELECT inputtime FROM bus_goodstrack where fkid = fj.id AND inputtime is not null order by inputtime asc LIMIT 1)::DATE as tracedate,
                    TO_CHAR(bg.inputtime, 'yyyy-MM-dd hh24:mi') as tracetime
        FROM fina_jobs fj,
            bus_goodstrack bg
        WHERE fj.id = bg.fkid
          AND fj.isdelete = false
          AND bg.iscs = true $qry$ $filter$ order by nos desc LIMIT 10000 OFFSET 0) json;
    </select>

    <!--付款申请-分单利润-->
    <select id="base.commerce.payprofit" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS payprofit
        FROM (SELECT * FROM
             (SELECT x.id,
             x.nos,
             (SELECT namec from sys_user where id = x.saleid LIMIT 1) AS sales,
             x.jobtype,
             x.customerabbr,
             x.remarks,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT nos from fina_jobs where id = x.parentid LIMIT 1) ELSE x.nos END) as mblno,
             (SELECT sc.daysar FROM sys_corporation sc WHERE sc.id = x.customerid LIMIT 1) AS daysar,
             (CASE WHEN iscomplete_ar THEN '是' ELSE '否' END) as complete_ar_status,
             (CASE WHEN iscomplete_ap THEN '是' ELSE '否' END) as complete_ap_status,
             (SELECT string_agg(su.namec::text, ','::text) FROM sys_user su, sys_user_assign sua WHERE su.id = sua.userid AND roletype = 'C' AND sua.linkid = (CASE WHEN x.jobtype = 'S' THEN (SELECT bus_shipping.id FROM bus_shipping WHERE jobid = x.id LIMIT 1)
             WHEN x.jobtype = 'A' THEN (SELECT bus_air.id FROM bus_air WHERE jobid = x.id LIMIT 1)
             WHEN x.jobtype = 'D' THEN (SELECT bus_commerce.id FROM bus_commerce WHERE jobid = x.id LIMIT 1) END)) AS cusname,
             (CASE WHEN x.jobtype = 'S' THEN (SELECT to_char(etd,'yyyy-MM-dd') FROM bus_shipping WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'A' THEN (SELECT to_char(singtime,'yyyy-MM-dd') FROM bus_air WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'L' THEN (SELECT to_char(loadtime,'yyyy-MM-dd') FROM bus_truck WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'D' THEN (SELECT to_char(etd,'yyyy-MM-dd') FROM bus_commerce WHERE jobid = x.id LIMIT 1) END)          AS etd,
             (CASE WHEN x.jobtype = 'S' THEN (SELECT to_char(eta,'yyyy-MM-dd') FROM bus_shipping WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'A' THEN (SELECT to_char(eta,'yyyy-MM-dd') FROM bus_air WHERE jobid = x.id LIMIT 1)
                   WHEN x.jobtype = 'L' THEN ''
                   WHEN x.jobtype = 'D' THEN (SELECT to_char(eta,'yyyy-MM-dd') FROM bus_commerce WHERE jobid = x.id LIMIT 1) END)             eta,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT productname FROM bus_commerce WHERE jobid = x.id LIMIT 1) END) AS productname,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT deliverynamec FROM bus_commerce WHERE jobid = x.id LIMIT 1) END) AS deliverynamec,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT (CASE WHEN bc.wmsindate IS NULL THEN bc.bkgw ELSE bc.gw END) FROM bus_commerce bc WHERE bc.jobid = x.id AND bc.isdelete = FALSE)
              ELSE (SELECT SUM((CASE WHEN bc.wmsindate IS NULL THEN bc.bkgw ELSE bc.gw END)) FROM fina_jobs fj, bus_commerce bc WHERE fj.id = bc.jobid AND fj.isdelete = FALSE AND fj.parentid = x.id) END) AS gw,
             (CASE WHEN x.jobtype = 'D' THEN (SELECT (CASE WHEN bc.wmsindate IS NULL THEN bc.bkvol ELSE bc.vol END) FROM bus_commerce bc WHERE bc.jobid = x.id AND bc.isdelete = FALSE)
              ELSE (SELECT SUM((CASE WHEN bc.wmsindate IS NULL THEN bc.bkvol ELSE bc.vol END)) FROM fina_jobs fj, bus_commerce bc WHERE fj.id = bc.jobid AND fj.isdelete = FALSE AND fj.parentid = x.id) END) AS vol,
             (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = x.id)  THEN '无应收' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = x.id ) THEN '已收款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AR' AND jobid = x.id) THEN '未收款' ELSE '部分收款' END) AS arstatus,
             (CASE WHEN NOT EXISTS (SELECT 1 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = x.id)  THEN '无应付' WHEN (SELECT sum(amount-COALESCE(amtstl2,0)) = 0  FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = x.id ) THEN '已付款' WHEN (SELECT COALESCE(SUM(amtstl2),0) = 0 FROM fina_arap WHERE isdelete = false AND araptype = 'AP' AND jobid = x.id) THEN '未付款' ELSE '部分付款' END) AS apstatus,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originaramountrmb,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originaramountusd,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originapamountrmb,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originapamountusd,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) -
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'CNY' AND a.isdelete = FALSE $corpsql$) AS originprofitrmb,
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AR' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) -
             (SELECT COALESCE(SUM(amount), 0) FROM fina_arap a WHERE a.jobid = x.id AND a.araptype = 'AP' AND a.currency = 'USD' AND a.isdelete = FALSE $corpsql$) AS originprofitusd,
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) AS baseamountar,
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseamountap,
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AR' AND jobid = x.id $corpsql$) -
             (SELECT COALESCE(SUM(f_amtto((CASE WHEN isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN a.arapdate ELSE x.jobdate END), a.currency, 'CNY', a.amount)), 0) FROM fina_arap a WHERE isdelete = FALSE AND araptype = 'AP' AND jobid = x.id $corpsql$) AS baseprofitrmb,
             (SELECT f_arap_gross_profit('jobid='||x.id||';userid='||$userid$||';currency=CNY;'))  baserate,
             (CASE WHEN (SELECT COUNT(1) AS c FROM (SELECT t.corpid, t.customerid, t.currency,COALESCE (t.amount, 0) + COALESCE (t2.amount, 0) AS amount FROM (SELECT fa.corpid, customerid, currency, sum(CASE WHEN araptype = 'AR' THEN amount ELSE -1 * amount END) AS amount FROM fina_arap fa WHERE fa.jobid = x.id AND fa.isdelete = FALSE AND fa.rptype != 'O' AND EXISTS (SELECT 1 FROM sys_corporation WHERE id = fa.customerid AND isdelete = FALSE AND iscustomer = FALSE) GROUP BY fa.corpid, customerid, currency) t
             LEFT JOIN (SELECT fa.corpid, customerid, currency, sum(CASE WHEN araptype = 'AR' THEN amount ELSE -1 * amount END) AS amount FROM fina_arap fa WHERE fa.jobid = x.id AND fa.isdelete = FALSE AND fa.rptype != 'O' AND EXISTS (SELECT 1 FROM sys_corporation WHERE id = fa.customerid AND isdelete = FALSE AND iscustomer = FALSE) GROUP BY fa.corpid, customerid, currency) t2 ON (t2.customerid = t.corpid AND t2.corpid = t.customerid AND t2.currency = t.currency) ) TT WHERE TT.amount != 0) > 0 THEN '否' ELSE '是' END) as amendeq
             FROM fina_jobs x WHERE x.isdelete = FALSE AND x.id IN ($id$) $orderby$ LIMIT 1000 OFFSET 0) result) json;
    </select>

    <select id="base.user.arapowe" parameterClass="java.util.Map" resultClass="java.util.HashMap">
        SELECT array_to_json(ARRAY_AGG(row_to_json(json))) :: TEXT AS arapowelist
        FROM (
                 select *
                 from (
                          SELECT jobdateyear
                               , jobdatemonth
                               , SUM(cnyamount)                                     as cnyamountall
                               , SUM(actualreceivablecny)                           as actualreceivablecnyall
                               , SUM(actualreceivableusd)                           as actualreceivableusdall
                               , SUM(actualreceivablehkd)                           as actualreceivableehkdall
                               , SUM(actualreceivableaed)                           as actualreceivableaedall
                               , SUM(actualreceivablegbp)                           as actualreceivablegbpall
                               , SUM(actualreceivableeur)                           as actualreceivableeurall
                               , SUM(actualreceivableomr)                           as actualreceivableomrall
                               , SUM(actualreceivablecad)                           as actualreceivablecadall
                          FROM (
                                   SELECT arap.customerid                                                                                                                   as customerid
                                        , arap.corpid                                                                                                                       as corpid
                                        , (SELECT abbr FROM sys_corporation AS y WHERE y.id = arap.customerid)                                                              AS customerabbr
                                        , f_amtto(arap.arapdate, arap.currency, 'CNY', (arap.amount - arap.amtstl2))::NUMERIC(18, 2)                                        AS cnyamount

							   , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'CNY' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivablecny
                                        , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'USD' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivableusd
                                        , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'HKD' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivablehkd
                                        , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'AED' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivableaed
                                        , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'GBP' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivablegbp
                                        , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'EUR' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivableeur
                                        , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'OMR' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivableomr
                                        , (CASE WHEN arap.araptype = 'AR' AND arap.currency = 'CAD' THEN (COALESCE(arap.amount, 0) - COALESCE(arap.amtstl2, 0)) ELSE 0 END) AS actualreceivablecad

                                        , (SELECT x.jobdate FROM fina_jobs x WHERE x.isdelete = FALSE AND x.id = arap.jobid)                                                AS jobdate
                                        , extract(year from (SELECT x.jobdate FROM fina_jobs x WHERE x.isdelete = FALSE AND x.id = arap.jobid))                             as jobdateyear
                                        , extract(month from (SELECT x.jobdate FROM fina_jobs x WHERE x.isdelete = FALSE AND x.id = arap.jobid))                            as jobdatemonth
                                   FROM fina_arap arap
                                   WHERE arap.isdelete = false
                               ) aa
                          WHERE 1 = 1
                              $qry$
                          group by jobdateyear, jobdatemonth
                          order by jobdateyear, jobdatemonth
                      ) aaa
                 where 1 = 1
                   and cnyamountall != 0
            ) json;
    </select>

</sqlMap>