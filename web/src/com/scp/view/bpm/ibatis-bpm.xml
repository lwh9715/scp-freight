<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
	
	
	<select id="bpm.bpmdesignerBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 * 
		FROM bpm_process t 
		WHERE $qry$ 
		ORDER BY namec
	</select>
	<select id="bpm.bpmdesignerBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM bpm_process t 
		WHERE $qry$ 
	</select>
	

	<select id="bpm.bpmtaskassignBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT * FROM (SELECT 
			*
			,(SELECT x.namec FROM sys_user x where x.code = a.tousercode AND x.isdelete = false) AS usernamec 
			,(SELECT x.namee FROM sys_user x where x.code = a.tousercode AND x.isdelete = false) AS usernamee
			,(SELECT name FROM sys_department x,sys_user y WHERE y.deptid = x.id AND y.code=a.tousercode) AS departname
			,(SELECT abbr FROM sys_corporation x,sys_user y WHERE y.corpid = x.id AND y.code=a.tousercode) AS corporabbr
		FROM  bpm_assign a WHERE a.isdelete = FALSE) AS t
		WHERE $qry$	
		$filter$
		ORDER BY step,taskname,departname,tousercode								
	</select>
	<select id="bpm.bpmtaskassignBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
			count(*) AS counts 
		FROM  (SELECT 
			*
			,(SELECT x.namec FROM sys_user x where x.code = a.tousercode AND x.isdelete = false) AS usernamec 
			,(SELECT x.namee FROM sys_user x where x.code = a.tousercode AND x.isdelete = false) AS usernamee
			,(SELECT name FROM sys_department x,sys_user y WHERE y.deptid = x.id AND y.code=a.tousercode) AS departname
			,(SELECT abbr FROM sys_corporation x,sys_user y WHERE y.corpid = x.id AND y.code=a.tousercode) AS corporabbr
		FROM  bpm_assign a WHERE a.isdelete = FALSE) AS t
		WHERE $qry$	
		$filter$
	</select>

	<select id="bpm.bpmapplyBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 * 
		FROM bpm_process t 
		WHERE $qry$ 
		ORDER BY namec
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="bpm.bpmapplyBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM bpm_process t 
		WHERE $qry$ 
	</select>

	<select id="bpm.bpminstanceBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select * from (select 
		 	t.* 
		  	,(CASE t.state WHEN '0' THEN '未开始' WHEN '1' THEN '运行中' WHEN '5' THEN '挂起' WHEN '8' THEN '终止' WHEN '9' THEN '完成' END)AS statedesc
		  	,(SELECT f_sys_getls('userid=$userid$;lskey='||taskname) FROM bpm_task WHERE processinstanceid = t.id AND state!=9 AND state!=3 AND state!=8 ORDER BY id DESC limit 1) AS tasknamelanguge
		  	,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE t.processid = id) AS displayname2
			,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = createduser AND x.isdelete = FALSE LIMIT 1) createdusers
			,j.customerabbr
			,j.pol
			,j.pod
			,j.refno AS jobrefno
			,j.vessel
			,j.voyage
			,j.etd
			,j.eta
			,j.cls
			,j.sonos
			,(SELECT x.linecode FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS linecode
			,f_fina_jobs_cntdesc('jobid='|| COALESCE(j.id,0)) AS cntdesc
			,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.carrierid = y.id LIMIT 1) AS carrier
			,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.agentid = y.id LIMIT 1) AS bkagent
			,(SELECT y.namec FROM bus_shipping x , dat_line y WHERE x.jobid = j.id AND (x.routecode = y.code OR x.routecode = y.namec) LIMIT 1) AS shipline
			,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s WHERE j.saleid  = s.id )AS saledesc
			,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'B' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS affairs
			,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'Z' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS assistant
			,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'K' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS booking
			,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'C' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS services
			,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'D' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS documents
		FROM bpm_processinstance t LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1]) 
			WHERE t.isdelete = FALSE AND state != 3
			) as T
		WHERE $qry$ 
			$filter$
		ORDER BY nos desc, displayname
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="bpm.bpminstanceBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		 FROM
		 (select 
		 	t.* 
		  	,(CASE t.state WHEN '0' THEN '未开始' WHEN '1' THEN '运行中' WHEN '5' THEN '挂起' WHEN '8' THEN '终止' WHEN '9' THEN '完成' END)AS statedesc
		  	,(SELECT f_sys_getls('userid=$userid$;lskey='||taskname) FROM bpm_task WHERE processinstanceid = t.id AND state!=9 AND state!=3 AND state!=8 ORDER BY id DESC limit 1) AS taskname
		FROM bpm_processinstance t LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1]) 
			WHERE t.isdelete = FALSE AND state != 3
			) as T
		WHERE $qry$ 
			$filter$
	</select>
	
	<select id="bpm.bpmtaskmgrBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select (SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = T.procecreateduser) procecreatedusers,* from (select 
		 t.*
		 ,(SELECT nos FROM bpm_processinstance WHERE id = t.processinstanceid) AS nos
		 ,(CASE t.state WHEN '0' THEN '未开始' WHEN '1' THEN '待签收'  WHEN '2' THEN '待处理'  WHEN '3' THEN '其他人已签收' WHEN '5' THEN '挂起' WHEN '9' THEN '完成' END)AS statedesc
		 ,(SELECT displayname FROM bpm_processinstance WHERE id = t.processinstanceid) AS displayname
		 ,(SELECT createduser FROM bpm_processinstance WHERE id = t.processinstanceid) AS procecreateduser
		 ,(SELECT startedtime FROM bpm_processinstance WHERE id = t.processinstanceid) AS procestartedtime
		 ,(select remarks from bpm_processinstance where t.processinstanceid = id LIMIT 1) AS instanceremarks
		 ,(SELECT refno FROM bpm_processinstance WHERE id = t.processinstanceid) AS refno
		 ,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE t.processid = id) AS displayname2
		 ,(f_sys_getls('userid=$userid$;lskey='||t.taskname)::text) AS tasknamelanguge
		 ,f_sys_getls('userid=$userid$;lskey='||taskname) AS tasknamedesc
		 ,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = t.actorid LIMIT 1) actorer
		 ,j.customerabbr
		 ,j.pol
		 ,j.pod
		 ,j.refno AS jobrefno
		 ,j.vessel
		 ,j.voyage
		 ,j.etd
		 ,j.eta
		 ,j.cls
		 ,j.sonos
		 ,(SELECT x.linecode FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS linecode
		 ,f_fina_jobs_cntdesc('jobid='|| COALESCE(j.id,0)) AS cntdesc
		 ,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.carrierid = y.id LIMIT 1) AS carrier
		 ,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.agentid = y.id LIMIT 1) AS bkagent
		 ,(SELECT y.namec FROM bus_shipping x , dat_line y WHERE x.jobid = j.id AND (x.routecode = y.code OR x.routecode = y.namec) LIMIT 1) AS shipline
		 ,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s WHERE j.saleid  = s.id )AS saledesc
		 ,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'B' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS affairs
		 ,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'Z' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS assistant
		 ,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'K' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS booking
		 ,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'C' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS services
		 ,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'D' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS documents
		 
		FROM bpm_task t, bpm_processinstance p LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(p.refid,',')::BIGINT[])[1] ) where t.processinstanceid = p.id) as T
		WHERE $qry$ 
			$filter$
		ORDER BY nos desc, processinstanceid
		LIMIT $limit$ OFFSET $start$
	</select>
	<select id="bpm.bpmtaskmgrBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM
			(select 
			 t.*
			 ,(SELECT nos FROM bpm_processinstance WHERE id = t.processinstanceid) AS nos
			 ,(CASE t.state WHEN '0' THEN '未开始' WHEN '1' THEN '待签收'  WHEN '2' THEN '待处理'  WHEN '3' THEN '其他人已签收' WHEN '5' THEN '挂起' WHEN '9' THEN '完成' END)AS statedesc
			 ,(SELECT displayname FROM bpm_processinstance WHERE id = t.processinstanceid) AS displayname
			 ,(SELECT createduser FROM bpm_processinstance WHERE id = t.processinstanceid) AS procecreateduser
			 ,(SELECT startedtime FROM bpm_processinstance WHERE id = t.processinstanceid) AS procestartedtime
			 ,(SELECT refno FROM bpm_processinstance WHERE id = t.processinstanceid) AS refno
			 ,(select remarks from bpm_processinstance where t.processinstanceid = id LIMIT 1) AS instanceremarks
			 ,(SELECT taskname FROM bpm_task WHERE processinstanceid = t.id AND state!=9 AND state!=3 AND state!=8 ORDER BY id DESC limit 1) AS taskname
			 ,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE t.processid = id) AS displayname2
			 ,f_sys_getls('userid=$userid$;lskey='||taskname) AS tasknamedesc
			FROM bpm_task t, bpm_processinstance p LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(p.refid,',')::BIGINT[])[1] ) where t.processinstanceid = p.id ) as T
		WHERE $qry$ 
			$filter$
	</select>
	
	<select id="bpm.bpmtasktodoBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[
		select 
			(CASE WHEN fromto = 'Start' THEN fromto||'/'||COALESCE((SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),'') FROM sys_user s WHERE s.code = t.procecreateduser LIMIT 1),'') ELSE fromto END) AS fromtos
			,(CASE WHEN fromto = 'Start' THEN COALESCE(to_char(t.taskcreatedtime,'YYYY-MM-DD HH24:MI:SS'),'') ELSE fromtotime END) AS fromtotimes
			,* from	(
			select 	
				t.*
				,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE t.processid = id) AS displayname2
				,(select remarks from bpm_processinstance where t.processinstanceid = id LIMIT 1) AS instanceRemarks
				,(f_sys_getls('userid=$userid$;lskey='||t.taskname)::text) AS tasknamelanguge
				, f_bpm_task_getcheckinfos('processinstanceid='||t.processinstanceid||';taskname='||t.taskname||';userid=$userid$;type=Last') AS taskcomments
				,(SELECT string_agg(namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),''),',') FROM sys_user x WHERE code = t.actorid AND x.isdelete = false  LIMIT 1) actorer
				,(SELECT string_agg(namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),''),',') FROM sys_user x WHERE code = t.procecreateduser AND x.isdelete = false  LIMIT 1) procecreatedusers
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),',') FROM sys_user s WHERE j.saleid  = s.id )AS saledesc
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),',') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'B' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS affairs
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),',') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'Z' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS assistant
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),',') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'K' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS booking
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),',') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'C' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS services
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),',') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'D' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS documents
 				,regexp_replace(to_char(expiredtime-now(), 'DD天 HH24时MI分SS秒'),'00天|00时|00分|0秒','','g') AS timeout
 				,expiredtime-now() AS timeoutorder
 				,(CASE 
 						WHEN processcode = 'BPM-89120814' THEN (select clientname from fina_invoice where id = ANY(regexp_split_to_array(t.refid,',')::BIGINT[]))
 						WHEN processcode IN ('BPM-04BE66D6','BPM-24A01CE0','BPM-D5ADFEC6') THEN (select customerabbr from fina_rpreq where id = ANY(regexp_split_to_array(t.refid,',')::BIGINT[]))
 						WHEN processcode = 'BPM-28C01EAF' THEN (select clientname from fina_invoice where id = ANY(regexp_split_to_array(t.refid,',')::BIGINT[]))
 					ELSE
 						j.customerabbr
 					END) AS customerabbr
 				,j.pol
				,j.pod
				,j.refno AS jobrefno
				,j.vessel
				,j.voyage
				,(CASE 
 						WHEN processcode IN ('BPM-04BE66D6','BPM-24A01CE0','BPM-D5ADFEC6') THEN 
 							(select max(etd) from bus_shipping where isdelete = false and jobid = ANY(select jobid from _fina_rpreqdtl where rpreqid = ANY(regexp_split_to_array(t.refid,',')::BIGINT[])))
 					ELSE
 						j.etd
 					END) AS etd
				,j.eta
				,j.cls
				,j.sonos
				,COALESCE((select statusc from bus_goodstrack where fkid = j.id and isfinish = true order by orderno desc limit 1),'') AS jobstatedesc
				,(SELECT x.linecode FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS linecode
				,(SELECT (CASE WHEN x.carrieresi = 'Y' THEN true ELSE FALSE END) FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS carrieresi
				,f_fina_jobs_cntdesc('jobid='|| COALESCE(j.id,0)) AS cntdesc
				,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.carrierid = y.id LIMIT 1) AS carrier
				,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.agentid = y.id LIMIT 1) AS bkagent
				,(SELECT y.namec FROM bus_shipping x , dat_line y WHERE x.jobid = j.id AND (x.routecode = y.code OR x.routecode = y.namec) LIMIT 1) AS shipline
				,(COALESCE((SELECT COALESCE(x.fromnode,'')||'/'||(SELECT COALESCE((SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),'') FROM sys_user s WHERE s.code = a.actorid LIMIT 1),'') FROM bpm_task a WHERE x.fromtaskid = a.id) FROM bpm_trace x WHERE totaskid = t.id AND x.processinstanceid = t.processinstanceid)
							,(SELECT COALESCE(x.fromnode,'') FROM bpm_trace x WHERE x.tonode = t.taskname AND x.processinstanceid = t.processinstanceid LIMIT 1)
							)) AS fromto
				,(SELECT (SELECT COALESCE(to_char(a.endtime,'YYYY-MM-DD HH24:MI::SS'),'') FROM bpm_task a WHERE x.fromtaskid = a.id) FROM bpm_trace x WHERE totaskid = t.id AND x.processinstanceid = t.processinstanceid)AS fromtotime
				,(CASE WHEN EXISTS(select 1 from bus_ship_bill x where x.isdelete = false and x.jobid = j.id AND bltype = 'H') THEN (SELECT string_agg(COALESCE(x.hblno,''),',')  FROM bus_ship_bill x WHERE x.isdelete = false and x.jobid = j.id) ELSE (SELECT x.hblno FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) END) AS hblno
				,(CASE WHEN EXISTS(select 1 from bus_ship_bill x where x.isdelete = false and x.jobid = j.id AND bltype = 'M') THEN (SELECT string_agg(COALESCE(x.mblno,''),',')  FROM bus_ship_bill x WHERE x.isdelete = false and x.jobid = j.id) ELSE (SELECT x.mblno FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) END) AS mblno
				
				,(SELECT x.bltype FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS bltype
				,(SELECT x.sidate FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS sidate
				,(SELECT x.vgmdate FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS vgmdate
				,(SELECT x.poa FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS poa
				,(SELECT x.bargecls FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS bargecls
				,(SELECT x.vgmtype FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS vgmtype
				,(CASE WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = j.id and x.vgmtype = 'M' and x.vgmstatus = 'A') THEN true WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = j.id and x.vgmtype = 'M' and x.vgmstatus <> 'A') THEN FALSE ELSE NULL END) AS vgmstatus
				,(CASE WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = j.id and (x.trucktype = 'A' or x.trucktype = 'B')) and EXISTS(select 1 from bus_truck x where x.isdelete = false and x.jobid = j.id and x.truckstate = 'F') THEN true WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = j.id and (x.trucktype = 'A' or x.trucktype = 'B')) THEN FALSE ELSE NULL END) AS trucktype
				,(CASE WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = j.id and x.custype = 'F') and EXISTS(select 1 from bus_customs x where x.isdelete = false and x.jobid = j.id and x.customstate = 'F') THEN true WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = j.id and x.custype = 'F') THEN FALSE ELSE NULL END) AS custype
				,(CASE WHEN EXISTS(select 1 from fina_arap x where x.isdelete = false and x.jobid = j.id and x.araptype = 'AP' and x.isconfirm = true) THEN true  ELSE false END) AS billcheck
				
				,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 140 AND code =(SELECT hbltype FROM bus_shipping WHERE jobid = j.id and isdelete = false)) AS hbltypedesc
				,(SELECT namec FROM dat_filedata WHERE isdelete = false AND fkcode = 150 AND isleaf = TRUE AND code = j.mbltype LIMIT 1) AS mbltypedesc
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = j.id and d.roletype = 'F' and d.name = 'SO') THEN true ELSE false END ) AS sofile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = j.id and d.roletype = 'F' and d.name = '原始补料') THEN true ELSE false END ) AS feedingfile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = j.id and d.roletype = 'F' and d.name = '提单COPY') THEN true ELSE false END ) AS bolcopyfile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = j.id and d.roletype = 'F' and d.name = '提单确认件') THEN true ELSE false END ) AS bolconfirmfile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = j.id and d.roletype = 'F' and d.name = '客户SO') THEN true ELSE false END ) AS customsofile
				,(SELECT x.waybillno FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS waybillno
				,(SELECT x.datesign FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS datesign
				,(CASE WHEN t.processid = 6492648888 THEN (SELECT x.remark FROM fina_rpreq x WHERE x.id::text = t.refid LIMIT 1) END) AS rpreqremark
				,f_fina_jobs_cnts('jobid='|| COALESCE(j.id,0)) AS cnts
				,(CASE COALESCE((SELECT editype FROM fina_invoice WHERE id = split_part( t.refid::text,',',1) :: bigint limit 1),'')
					WHEN	'E'	THEN	'增值税电子普票'	
					WHEN	'P'	THEN	'增值税纸质普票'	
					WHEN	'Z'	THEN	'增值税纸质专票'	
					WHEN	'D'	THEN	'增值税电子税票'	
					WHEN	'C'	THEN	'增值税电子专票'	
					ELSE	''
					END) AS invtype
 			FROM  _bpm_task t LEFT JOIN _fina_jobs j ON (j.id =  COALESCE((regexp_split_to_array(t.refid,',')::BIGINT[])[1],(SELECT jobid FROM bus_ship_bill WHERE isdelete = FALSE AND id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1]::BIGINT)))
 			WHERE 1=1 $dynamicClauseWhere$) as T 
 		WHERE $qry$ 
	 		AND t.state != 9 AND t.instancestate != 9
	 		AND t.state != 3
	 		AND t.state != 8
	 		$ORDER$
	 	LIMIT $limit$ OFFSET $start$
	]]>
	</select>
	<select id="bpm.bpmtasktodoBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 	count(*) AS counts 
		FROM  (select 	
				 t.*
				,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE t.processid = id) AS displayname2
				,(select remarks from bpm_processinstance where t.processinstanceid = id LIMIT 1) AS instanceRemarks
				,(f_sys_getls('userid=$userid$;lskey='||t.taskname)::text) AS tasknamelanguge
 			FROM  _bpm_task t LEFT JOIN _fina_jobs j ON(j.id =  COALESCE((regexp_split_to_array(t.refid,',')::BIGINT[])[1],(SELECT jobid FROM bus_ship_bill WHERE isdelete = FALSE AND id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1]::BIGINT))) WHERE 1=1 $dynamicClauseWhere$)  as T
		WHERE $qry$ 
			AND t.state != 9 AND t.instancestate != 9
			AND t.state != 3
			AND t.state != 8
	</select>
	
	
	<select id="bpm.bpmtaskdoneBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[
		select * from	(select 	
				t.*
				,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE t.processid = id) AS displayname2
				,(select remarks from bpm_processinstance where t.processinstanceid = id LIMIT 1) AS instanceRemarks
				,(f_sys_getls('userid=$userid$;lskey='||t.taskname)::text) AS tasknamelanguge
				,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = t.actorid LIMIT 1) actorer
 				,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = t.procecreateduser LIMIT 1) procecreatedusers
 				
 				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s WHERE j.saleid  = s.id )AS saledesc
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'B' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS affairs
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'Z' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS assistant
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'K' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS booking
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'C' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS services
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'D' AND c.jobid = j.id AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS documents
 				
 				,(CASE 
 						WHEN processcode = 'BPM-89120814' THEN (select clientname from fina_invoice where id = ANY(regexp_split_to_array(t.refid,',')::BIGINT[]))
 						WHEN processcode IN ('BPM-04BE66D6','BPM-24A01CE0','BPM-D5ADFEC6') THEN (select customerabbr from fina_rpreq where id = ANY(regexp_split_to_array(t.refid,',')::BIGINT[]))
 					ELSE
 						j.customerabbr
 					END) AS customerabbr
 				,j.pol
				,j.pod
				,j.refno AS jobrefno
				,j.vessel
				,j.voyage
				,j.etd
				,j.eta
				,j.cls
				,j.sonos
				,(CASE COALESCE((SELECT editype FROM fina_invoice WHERE id = split_part( t.refid::text,',',1) :: bigint limit 1),'')
					WHEN	'E'	THEN	'增值税电子普票'	
					WHEN	'P'	THEN	'增值税纸质普票'	
					WHEN	'Z'	THEN	'增值税纸质专票'	
					WHEN	'D'	THEN	'增值税电子税票'	
					WHEN	'C'	THEN	'增值税电子专票'	
					ELSE	''
					END) AS invtype
				,(SELECT x.linecode FROM bus_shipping x WHERE x.jobid = j.id LIMIT 1) AS linecode
				,f_fina_jobs_cntdesc('jobid='|| COALESCE(j.id,0)) AS cntdesc
				,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.carrierid = y.id LIMIT 1) AS carrier
				,(SELECT y.abbr FROM bus_shipping x , sys_corporation y WHERE x.jobid = j.id AND x.agentid = y.id LIMIT 1) AS bkagent
				,(SELECT y.namec FROM bus_shipping x , dat_line y WHERE x.jobid = j.id AND (x.routecode = y.code OR x.routecode = y.namec) LIMIT 1) AS shipline
				, f_bpm_task_getcheckinfos('processinstanceid='||t.processinstanceid||';taskname='||t.taskname||';userid=$userid$;type=Last') AS taskcomments
				,(select statusc from bus_goodstrack where fkid = j.id and isfinish = true order by orderno desc limit 1) AS jobstatedesc
				,j.cntnos
				,j.id as jobid
 			FROM  _bpm_task t LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1])
 		) as T
 		WHERE $qry$ 
	 		AND t.state = 9
	 		$order$
	 	LIMIT $limit$ OFFSET $start$
	 	]]>
	</select>
	<select id="bpm.bpmtaskdoneBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM (select 	
				t.*
				,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE t.processid = id) AS displayname2
				,(select remarks from bpm_processinstance where t.processinstanceid = id LIMIT 1) AS instanceRemarks
				,(f_sys_getls('userid=$userid$;lskey='||t.taskname)::text) AS tasknamelanguge
				,j.refno AS jobrefno
				,j.id as jobid
 			FROM  _bpm_task t LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1])
 		) as T
		WHERE $qry$ 
			AND t.state = 9
	</select>
	
	<select id="bpm.bpmworkitemBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 	
				*
 		FROM  bpm_workitem t 
 		WHERE $qry$ 
	 		$filter$
	 		$filter2$
	</select>
	<select id="bpm.bpmworkitemBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  bpm_workitem t 
		WHERE $qry$ 
			$filter$
			$filter2$
	</select>
	<select id="bpm.bpmcommentstempBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 	
				*
 		FROM  bpm_comments_temp t 
 		WHERE $qry$ 
	</select>
	<select id="bpm.bpmcommentstempBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM  bpm_comments_temp t 
		WHERE $qry$ 
	</select>
	
	<select id="bpm.bpmsubmitedBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<![CDATA[
		SELECT
				 T.*
				,(SELECT refno FROM bpm_processinstance WHERE id = T.processinstanceid) AS refno
				,(SELECT CASE WHEN f_sys_user_language($userid$) = 'en' THEN namee ELSE namec END FROM bpm_process WHERE T.processid = id) AS displayname2
				,(select remarks from bpm_processinstance where T.processinstanceid = id LIMIT 1) AS instanceRemarks
				,(f_sys_getls('userid=$userid$;lskey='||T.taskname)::text) AS tasknamelanguge
				, f_bpm_task_getcheckinfos('processinstanceid='||T.processinstanceid||';taskname='||T.taskname||';userid=$userid$;type=Last') AS taskcomments
				,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = T.actorid AND x.isdelete = FALSE limit 1) actorer
				,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = T.procecreateduser AND x.isdelete = FALSE limit 1) procecreatedusers
				,(SELECT b.code FROM bus_shipping a,sys_corporation b WHERE a.jobid = T.jobid AND b.id = a.carrierid AND b.isdelete = FALSE) AS carrier
				,(SELECT pol FROM bus_shipping WHERE jobid = T.jobid ) AS pol
				,(SELECT pod FROM bus_shipping WHERE jobid = T.jobid ) AS pod
				,(SELECT poa FROM bus_shipping WHERE jobid = T.jobid ) AS poa
				,(SELECT destinationcode FROM bus_shipping WHERE jobid = T.jobid ) AS destinationcode
				,(SELECT bargecls FROM bus_shipping WHERE jobid = T.jobid ) AS bargecls
				,(SELECT cls FROM bus_shipping WHERE jobid = T.jobid ) AS cls
				,(SELECT vessel FROM bus_shipping WHERE jobid = T.jobid ) AS vessel
				,(SELECT voyage FROM bus_shipping WHERE jobid = T.jobid ) AS voyage
				,(SELECT etd FROM bus_shipping WHERE jobid = T.jobid ) AS etd
				,(SELECT eta FROM bus_shipping WHERE jobid = T.jobid ) AS eta
				,(SELECT clstime FROM bus_shipping WHERE jobid = T.jobid ) AS clstime
				,(SELECT sidate FROM bus_shipping WHERE jobid = T.jobid ) AS sidate
				,(SELECT vgmdate FROM bus_shipping WHERE jobid = T.jobid ) AS vgmdate
				,(SELECT f_fina_jobs_cntdesc('jobid='::text||T.jobid)) AS cntdesc
				,(SELECT string_agg(cntno,',') FROM bus_ship_container WHERE jobid = T.jobid) AS cntno
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s WHERE T.saleid  = s.id )AS saledesc
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'B' AND c.jobid = T.jobid AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS affairs
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'Z' AND c.jobid = T.jobid AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS assistant
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'K' AND c.jobid = T.jobid AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS booking
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'C' AND c.jobid = T.jobid AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS services
				,(SELECT string_agg(COALESCE(namec,'')||'/'||COALESCE(namee,'')||'/'||COALESCE((SELECT name FROM sys_department WHERE id = s.deptid),''),'') FROM sys_user s,sys_user_assign b,bus_shipping c WHERE b.roletype = 'D' AND c.jobid = T.jobid AND c.isdelete = FALSE AND b.userid = s.id AND b.linkid = c.id AND s.isdelete = FALSE AND b.isdelete = FALSE)AS documents
				,(SELECT customerabbr FROM fina_jobs WHERE id = T.jobid ) AS customerabbr
				,(SELECT sono FROM bus_shipping WHERE jobid = T.jobid ) AS sono
				,(select statusc from bus_goodstrack where fkid = T.jobid and isfinish = true order by orderno desc limit 1) AS jobstatedesc
				,(SELECT abbr FROM sys_corporation WHERE id = T.corpidop AND isdelete = FALSE) AS opcompany

				,(CASE WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = T.jobid and x.vgmtype = 'M' and x.vgmstatus = 'A') THEN true WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = T.jobid and x.vgmtype = 'M' and x.vgmstatus <> 'A') THEN FALSE ELSE NULL END) AS vgmstatus
				,(CASE WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = T.jobid and (x.trucktype = 'A' or x.trucktype = 'B')) and EXISTS(select 1 from bus_truck x where x.isdelete = false and x.jobid = T.jobid and x.truckstate = 'F') THEN true WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = T.jobid and (x.trucktype = 'A' or x.trucktype = 'B')) THEN FALSE ELSE NULL END) AS trucktype
				,(CASE WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = T.jobid and x.custype = 'F') and EXISTS(select 1 from bus_customs x where x.isdelete = false and x.jobid = T.jobid and x.customstate = 'F') THEN true WHEN EXISTS(select 1 from bus_shipping x where x.isdelete = false and x.jobid = T.jobid and x.custype = 'F') THEN FALSE ELSE NULL END) AS custype
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = T.jobid and d.roletype = 'F' and d.name = 'SO') THEN true ELSE false END ) AS sofile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = T.jobid and d.roletype = 'F' and d.name = '原始补料') THEN true ELSE false END ) AS feedingfile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = T.jobid and d.roletype = 'F' and d.name = '提单COPY') THEN true ELSE false END ) AS bolcopyfile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = T.jobid and d.roletype = 'F' and d.name = '提单确认件') THEN true ELSE false END ) AS bolconfirmfile
				,(CASE WHEN EXISTS(select 1 from sys_attachment s, sys_role d where s.isdelete = false and s.roleid = d.id and d.isdelete = false and s.linkid = T.jobid and d.roletype = 'F' and d.name = '客户SO') THEN true ELSE false END ) AS customsofile
				,(CASE WHEN EXISTS(select 1 from fina_arap x where x.isdelete = false and x.jobid = T.jobid and x.araptype = 'AP' and x.isconfirm = true) THEN true  ELSE false END) AS billcheck
				,(SELECT x.vgmtype FROM bus_shipping x WHERE x.jobid = T.jobid LIMIT 1) AS vgmtype
				,(SELECT (CASE WHEN x.carrieresi = 'Y' THEN true ELSE FALSE END) FROM bus_shipping x WHERE x.jobid = T.jobid LIMIT 1) AS carrieresi
				,(SELECT namec from dat_filedata WHERE isleaf = TRUE AND isdelete = false AND fkcode = 140 AND code =(SELECT hbltype FROM bus_shipping WHERE jobid = T.jobid and isdelete = false)) AS hbltypedesc
				,(SELECT namec FROM dat_filedata WHERE isdelete = false AND fkcode = 150 AND isleaf = TRUE AND code = T.mbltype LIMIT 1) AS mbltypedesc
				,(SELECT bltype FROM bus_shipping WHERE isdelete = FALSE AND jobid = T.jobid) AS bltype
				,(SELECT x.waybillno FROM bus_shipping x WHERE x.jobid = T.jobid LIMIT 1) AS waybillno
				,(SELECT x.datesign FROM bus_shipping x WHERE x.jobid = T.jobid LIMIT 1) AS datesign
			FROM(
				select
					t.*,j.id AS jobid , j.saleid AS saleid , j.corpidop AS corpidop , j.mbltype AS mbltype
		 		FROM _bpm_task t LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1])
		 		WHERE $qry$
			 		$dynamicClauseWhere$
			 		$filter$
			 		AND t.instancestate != 8
					AND t.instancestate != 9
				$ORDER$
			 	LIMIT $limit$ OFFSET $start$
			 ) AS T
	  ]]>
	</select>
	<select id="bpm.bpmsubmitedBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
				count(*) AS counts
 		FROM _bpm_task t LEFT JOIN _fina_jobs j ON(j.id = (regexp_split_to_array(t.refid,',')::BIGINT[])[1])
 		WHERE $qry$
 			$dynamicClauseWhere$
 			$filter$
 			AND t.instancestate != 8
			AND t.instancestate != 9
	</select>
	
	<select id="bpm.bpmassignrefuserBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		  t.code,t.namec,t.namee,t.company,t.depter2
		 ,x.id,x.expression
		FROM _sys_user t , bpm_assign_ref x
		WHERE $qry$ 
			AND isdelete = FALSE 
			AND isadmin = 'N'
			AND iscsuser = FALSE
			AND x.assignid = $libid$ 
			AND x.userid = t.id
		ORDER BY t.corpid,t.depter2,t.isinvalid DESC, t.code
	</select>
	<select id="bpm.bpmassignrefuserBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _sys_user t , bpm_assign_ref x 
		WHERE $qry$ 
			AND isdelete = false 
			AND isadmin = 'N'
			AND iscsuser = FALSE
			AND x.assignid = $libid$ 
			AND x.userid = t.id
	</select>
	<select id="bpm.bpmassignrefcustBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		 * 
		FROM _sys_user t 
		WHERE $qry$ 
			AND isdelete = FALSE 
			AND isadmin = 'N'
			AND iscsuser = FALSE
			AND NOT EXISTS(SELECT 1 FROM bpm_assign_ref x WHERE x.assignid = $libid$ AND x.userid = t.id)
		ORDER BY corpid,depter2,isinvalid DESC, code
	</select>
	<select id="bpm.bpmassignrefcustBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _sys_user t 
		WHERE $qry$ 
			AND isdelete = false 
			AND isadmin = 'N'
			AND iscsuser = FALSE
			AND NOT EXISTS(SELECT 1 FROM bpm_assign_ref x WHERE x.assignid = $libid$ AND x.userid = t.id)
	</select>
	
	<select id="bpm.bpmlogsBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
		(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = t.opusr LIMIT 1) opusr 
		,(SELECT namec||'/'||namee||'/'||COALESCE((SELECT name FROM sys_department WHERE id = x.deptid),'') FROM sys_user x WHERE code = t.actorid LIMIT 1) actor 
		 ,* 
		FROM bpm_log t 
		WHERE $qry$ 
			$filter$
		ORDER BY processinstance_id, optime
	</select>
	<select id="bpm.bpmlogsBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM bpm_log t 
		WHERE $qry$ 
			$filter$
	</select>
	
</sqlMap>
