<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>


	<select id="bpm.todo.bpmpayapplydtlcheckBean.grid.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			a.id                                             AS pkid,
			a.arapid,
			a.rpreqid,
			r.customerid,
			a.id                                             AS rpreqdtlid,
			a.amtreq,
			a.araptype,
			a.jobno,
			a.feeitemdec,
			a.arapdate,
			a.currency,
			a.amount                                         AS arapamt,
			a.amount - ((SELECT sum(COALESCE(x.amtreq, 0::numeric)) AS sum FROM _fina_rpreqdtl x WHERE x.arapid = a.arapid AND x.isdelete = false AND x.reqtype::text = 'Q'::text)) AS amount,
			a.arapdesc,
			a.arapremarks,
			a.arapbranch,
			(SELECT j.customerabbr FROM fina_jobs j WHERE j.id = a.jobid AND j.isdelete = false) AS customerabbr,
			(SELECT string_agg(x.cntno::text, ','::text) AS string_agg FROM bus_ship_container x WHERE x.cntno IS NOT NULL AND x.cntno::text <![CDATA[ <> ]]> ''::text AND x.isdelete = false AND x.jobid = a.jobid) AS cntno,
			(SELECT y.sono FROM bus_shipping y WHERE y.isdelete = false AND y.jobid = a.jobid) AS sono,
			CASE WHEN (EXISTS(SELECT 1 FROM fina_jobs j WHERE j.parentid = a.jobid AND j.jobtype::text = 'D'::text AND j.isdelete = false)) THEN
			CASE WHEN (EXISTS(SELECT 1 FROM fina_jobs WHERE fina_jobs.parentid = a.jobid AND fina_jobs.isdelete = false AND fina_jobs.arstatus::text = '部分收款'::text)) THEN '部分收款'::text
			WHEN (EXISTS(SELECT 1 FROM fina_jobs WHERE fina_jobs.parentid = a.jobid AND fina_jobs.isdelete = false AND fina_jobs.arstatus::text = '未收款'::text)) THEN '未收款'::text
			WHEN (EXISTS(SELECT 1 FROM fina_jobs WHERE fina_jobs.parentid = a.jobid AND fina_jobs.isdelete = false AND (fina_jobs.arstatus::text = ''::text OR fina_jobs.arstatus IS NULL))) THEN '无应收'::text
			ELSE '已收款'::text END::character varying ELSE (SELECT j.arstatus FROM fina_jobs j WHERE j.id = a.jobid AND j.isdelete = false) END                                          AS arstatus,
			(SELECT y.contractno FROM bus_shipping y WHERE y.isdelete = false AND y.jobid = a.jobid)                        AS contno,
			a.isconfirm,
			a.confirmer,
			a.confirmdate,
			(SELECT j.jobtype FROM fina_jobs j WHERE j.id = a.jobid AND j.isdelete = false) AS jobtype,
			a.jobid,
			(SELECT string_agg(DISTINCT x.invoiceno::text, ','::text) AS string_agg FROM fina_invoice x, fina_arap y
			WHERE y.id = a.arapid AND x.isdelete = false AND y.isdelete = false AND y.invoiceid = x.id AND x.invoiceno::text <![CDATA[ <> ]]> ''::text) AS invoiceno,
			f_amtto(COALESCE((SELECT jobdate FROM fina_jobs WHERE id = a.jobid),CURRENT_DATE),currency,'CNY',amtreq) AS amtreqamtto,
			(SELECT y.etd FROM bus_shipping as y WHERE y.isdelete = FALSE AND y.jobid = a.jobid) AS etd,
			(SELECT COALESCE (SUM (f_amtto((CASE WHEN fa.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN fa.arapdate ELSE (SELECT fj.jobdate FROM fina_jobs fj WHERE fj.id = a.jobid LIMIT 1) END), fa.currency, 'USD', fa.amount)), 0) FROM fina_arap fa WHERE fa.isdelete = FALSE AND fa.araptype = 'AR' AND fa.jobid = a.jobid $corpidcurrent$) -
			(SELECT COALESCE (SUM (f_amtto((CASE WHEN fa.isamend = TRUE AND (CASE WHEN COALESCE(f_sys_config('fina_arap_porfit_isamend_jobdate'),'N') = 'Y' THEN TRUE ELSE FALSE END) = FALSE THEN fa.arapdate ELSE (SELECT fj.jobdate FROM fina_jobs fj WHERE fj.id = a.jobid LIMIT 1) END), fa.currency, 'USD', fa.amount)), 0) FROM fina_arap fa WHERE fa.isdelete = FALSE AND fa.araptype = 'AP' AND fa.jobid = a.jobid $corpidcurrent$) as usdprofit,
			(CASE WHEN (SELECT COUNT(1) AS c FROM (SELECT t.corpid, t.customerid, t.currency,COALESCE (t.amount, 0) + COALESCE (t2.amount, 0) AS amount
			FROM (SELECT fa.corpid, customerid, currency, sum(CASE WHEN araptype = 'AR' THEN amount ELSE -1 * amount END) AS amount
			FROM fina_arap fa WHERE fa.jobid = a.jobid AND fa.isdelete = FALSE AND fa.rptype != 'O'
			AND EXISTS (SELECT 1 FROM sys_corporation WHERE id = fa.customerid AND isdelete = FALSE AND iscustomer = FALSE) GROUP BY fa.corpid, customerid, currency) t
			LEFT JOIN (SELECT fa.corpid, customerid, currency, sum(CASE WHEN araptype = 'AR' THEN amount ELSE -1 * amount END) AS amount
			FROM fina_arap fa WHERE fa.jobid = a.jobid AND fa.isdelete = FALSE AND fa.rptype != 'O'
			AND EXISTS (SELECT 1 FROM sys_corporation WHERE id = fa.customerid AND isdelete = FALSE AND iscustomer = FALSE)
			GROUP BY fa.corpid, customerid, currency) t2 ON (t2.customerid = t.corpid AND t2.corpid = t.customerid AND t2.currency = t.currency)
			) TT WHERE TT.amount != 0) > 0 THEN '否' ELSE '是' END) as amendeq,
			(SELECT f_arap_gross_profit('jobid='||a.jobid||';userid='||$userid$||';currency=USD;'))::numeric(18, 2) as retgpr
			FROM fina_rpreq r,
			_fina_rpreqdtl a
			WHERE r.id = a.rpreqid
			AND r.reqtype::text = 'Q'::text
			AND a.isdelete = false
			AND $qry$
			AND $clause$ $araptype$
			ORDER BY arapdate
			LIMIT $limit$ OFFSET $start$
	</select>
	<select id="bpm.todo.bpmpayapplydtlcheckBean.grid.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			COUNT(*) AS counts
		FROM fina_rpreq r,
			 _fina_rpreqdtl a
		WHERE r.id = a.rpreqid
		  AND r.reqtype::text = 'Q'::text
		  AND a.isdelete = false
		  AND $qry$
		  AND $clause$
			$araptype$
	</select>
	
	<select id="bpm.todo.bpmtodoapplyapBean.gridUser.page" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 * 
		FROM _sys_user t 
		WHERE $qry$ 
			AND isdelete = FALSE
			AND isinvalid = TRUE 
			AND iscsuser = FALSE
		ORDER BY company,depter2,code
	</select>
	<select id="bpm.todo.bpmtodoapplyapBean.gridUser.count" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select 
		 count(*) AS counts 
		FROM _sys_user t 
		WHERE $qry$ 
			AND isdelete = FALSE
			AND isinvalid = TRUE 
			AND iscsuser = FALSE
	</select>
	
</sqlMap>
