<?xml version="1.0" encoding="UTF-8"?>
<f:view xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://java.sun.com/jsf/core"
	xmlns:w="http://www.apusic.com/jsf/widget" xmlns:layout="http://www.apusic.com/jsf/layout"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:ajax="http://www.apusic.com/jsf/ajax"
	xmlns:ui="http://java.sun.com/jsf/facelets" renderKitId="AJAX">
	<w:head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<link rel="shortcut icon" href="#{constantBean.contextPath}/favicon.ico" />
		<link rel="icon" type="image/gif" href="#{constantBean.contextPath}/favicon.ico" />
		
		<w:stylesheet src="/common/css/common.css"></w:stylesheet><link rel="stylesheet" id="cmsbg" type="text/css"/>
		<w:script src="/common/js/common.js?t=4"></w:script>
		<script type="text/javascript" src="/scp/common/js/jquery-2.0.0.min.js"></script>
	
		<script type="text/javascript" src="/scp/_global/resource/ext/src/locale/ext-lang.js?#{commonBean.lang}"></script>
		<script type="text/javascript" src="/scp/_global/resource/om/locale/om-lang.js?#{commonBean.lang}"></script>
	</w:head>
	<w:page loadMask="true" loadMaskText="Loading..." title="">
		<ajax:conversationActivator/>
		<layout:borderLayout fitToBody="true">
			<layout:panel id="gridPanel" height="400" split="true" jsvar="gridPanelJsvar" hideBorders="true"
				region="north">
				<w:form>
					<div style="height: 0px;">
					
					</div>
					<w:toolBar>
						
						<w:button id="refresh" label="#{l.m['刷新']}" jsvar="refreshJsVar"
							image="#{constantBean.contextPath}/images/refresh.png" />
						<w:button id="del" jsvar="del" title="删除" label="#{l.m['删除']}"
							onclick="return confirm('#{l.m['确定要删除吗?']}');"
							image="#{constantBean.contextPath}/images/delete.png" />
						
						<w:button id="stop" label="#{l.m['停止']}"
							image="#{constantBean.contextPath}/images/refresh.png" />
							
						<w:button id="start" label="#{l.m['运行']}"
							image="#{constantBean.contextPath}/images/refresh.png" />
						
						<w:button id="refreshJobs" label="#{l.m['刷新任务']}"
							image="#{constantBean.contextPath}/images/new.png" />	
							
						<w:button id="qryAdd" label="#{l.m['新增']}"
							image="#{constantBean.contextPath}/images/new.png" />
							
						<w:button label="#{l.m['自动刷新']}" onclick="setInterval('running()',1000*5);"
							image="#{constantBean.contextPath}/images/refresh.png" />	
					</w:toolBar>

					<layout:panelGrid columns="20" cellspacing="0" cellpadding="0">
						<layout:cell style="width: 25px;">
							<w:button id="clearQryKey" label="" width="25"
								image="#{constantBean.contextPath}/images/clear.png" />
						</layout:cell>
						<w:textField selectOnFocus="true" width="80" blankText="#{l.m['任务名称']}"
							value="#{pages.sysmgr.user.securitylevelBean.qryMap['jobname']}" />
					</layout:panelGrid>

					<w:dataGrid height="700" paged="false" rows="10000" id="grid" jsvar="gridJsvar" loadMask="true"
						toolBarPosition="bottom" idColumn="id" selectable="true" selectionModel="#{constantBean.checkBox}">
						<w:outputColumn id="id" header="ID" hidden="true" />
						<w:outputColumn header="#{l.m['任务组']}" id="groupname" width="80" sortable="true"/>
						<w:outputColumn header="#{l.m['任务名称']}" id="jobname" width="120" sortable="true" />
						<w:outputColumn header="#{l.m['发布状态']}" id="jobstatus" width="80" sortable="true" clientFormatter="formatJobStatus"/>
						
						<w:outputColumn header="#{l.m['执行次数']}" id="runcount" width="80" sortable="true" align="right"/>
						<w:outputColumn header="#{l.m['上次执行时间']}" id="lastruntime" width="120" sortable="true" >
							<f:convertDateTime pattern="yy/MM/dd HH:mm:ss" timeZone="GMT+8" />
						</w:outputColumn>
						
						<w:outputColumn header="#{l.m['上次执行状态']}" id="lastrunstatus" width="120" sortable="true" >
						</w:outputColumn>
						<w:outputColumn header="#{l.m['上次执行日志']}" id="lastrunlogs" width="120" sortable="true" >
						</w:outputColumn>
						<w:outputColumn header="#{l.m['中断']}" id="concurrent" width="60" sortable="true"  type="check"/>
						<w:outputColumn header="Cron" id="cron" width="130" sortable="true"/>
						<w:outputColumn header="#{l.m['类别']}" id="jobtype" width="60" sortable="true" />
						
						<w:outputColumn header="#{l.m['指令']}" id="commond" width="320" sortable="true" />
						<w:outputColumn header="#{l.m['类名']}" id="beanname" width="180" sortable="true" />
						<w:outputColumn header="#{l.m['方法名']}" id="methodname" width="80" sortable="true" />
						<w:outputColumn header="#{l.m['参数']}" id="jobdata" width="60" sortable="true" />

						<w:outputColumn header="#{l.m['录入人']}" id="inputer" sortable="true" width="80" />
						<w:outputColumn header="#{l.m['录入时间']}" id="inputtime" width="90" sortable="true">
							<f:convertDateTime pattern="yy/MM/dd HH:mm" timeZone="GMT+8" />
						</w:outputColumn>
						<w:outputColumn header="#{l.m['修改人']}" id="updater" sortable="true" width="80" />
						<w:outputColumn header="#{l.m['修改时间']}" id="updatetime" width="90" sortable="true">
							<f:convertDateTime pattern="yy/MM/dd HH:mm" timeZone="GMT+8" />
						</w:outputColumn>

					</w:dataGrid>
				</w:form>
			</layout:panel>
			
			<layout:panel id="logPanel" height="100%" split="true" jsvar="logPanelJsvar" hideBorders="true"
				region="center">
				<w:iframe height="90" style="width: 100%; height: 100%;" frameborder="no" id="dtlIFrame"
											name="dtlIFrame"/>
			</layout:panel>
		</layout:borderLayout>
	</w:page>
	
	<layout:window maximizable="true" width="680" height="405" id="editWindow">
			<layout:panel id="editPanel"  hideBorders="true" style="font-size:12px">
				<w:form>
					<w:toolBar>
						<w:button id="add" label="#{l.m['新增']}"
							image="#{constantBean.contextPath}/images/new.png" />
						<w:button id="addCopy" label="#{l.m['复制新增']}"
							image="#{constantBean.contextPath}/images/new.png" />
						<w:button id="save" value="#{l.m['保存']}"
							image="#{constantBean.contextPath}/images/save.png" />
					</w:toolBar>
					<layout:panelGrid columns="2" cellspacing="2" >
						<h:outputLabel value="#{l.m['任务组']}" />
						<w:textField selectOnFocus="true" value="#{pages.sysmgr.timetask.systimetaskBean.data.groupName}" width="500"
							   />
						<h:outputLabel value="#{l.m['名称']}" />
						<w:textField selectOnFocus="true" value="#{pages.sysmgr.timetask.systimetaskBean.data.jobName}" width="500"
							  />
							
						<h:outputLabel value="#{l.m['状态']}" />
						<w:combo typeAhead="true" width="500" forceSelection="true"
							value="#{pages.sysmgr.timetask.systimetaskBean.data.jobStatus}">
							<f:selectItem itemLabel="Running" itemValue="Running"></f:selectItem>
							<f:selectItem itemLabel="Stop" itemValue="Stop"></f:selectItem>
						</w:combo>
						
						<h:outputLabel value="#{l.m['类型']}" />
						<w:combo typeAhead="true" width="500" forceSelection="true"
							value="#{pages.sysmgr.timetask.systimetaskBean.data.jobType}">
							<f:selectItem itemLabel="SQL" itemValue="SQL"></f:selectItem>
							<f:selectItem itemLabel="Shell" itemValue="Shell"></f:selectItem>
							<f:selectItem itemLabel="JAVA" itemValue="JAVA"></f:selectItem>
						</w:combo>
						<h:outputLabel value="#{l.m['中断']}" />
						<w:checkBox value="#{pages.sysmgr.timetask.systimetaskBean.data.concurrent}"></w:checkBox>
						
						<layout:cell colspan="2">
							<layout:panelGrid>
								<h:outputLabel value="Cron" />
								<w:textField selectOnFocus="true" value="#{pages.sysmgr.timetask.systimetaskBean.data.cron}" width="500" jsvar="cronJsVar"   />
								<w:button id="cfgCron" label="#{l.m['配置']}" onclick="cfgCronWindowJsvar.show();"
									image="#{constantBean.contextPath}/images/new.png" />
							</layout:panelGrid>
						</layout:cell>
						
						
						<h:outputLabel value="#{l.m['指令']}" />
						<w:textField selectOnFocus="true" value="#{pages.sysmgr.timetask.systimetaskBean.data.commond}" width="500"    />
						
						<h:outputLabel value="#{l.m['类名']}" />
						<w:textField selectOnFocus="true" value="#{pages.sysmgr.timetask.systimetaskBean.data.beanName}" width="500"    />
						
						<h:outputLabel value="#{l.m['方法名']}" />
						<w:textField selectOnFocus="true" value="#{pages.sysmgr.timetask.systimetaskBean.data.methodName}" width="500"    />
						
						<h:outputLabel value="#{l.m['参数']}" />
						<w:textField selectOnFocus="true" value="#{pages.sysmgr.timetask.systimetaskBean.data.jobData}" width="500"    />
						
					</layout:panelGrid>
					
					<div style="height: 0px; display: none">
						<w:textField selectOnFocus="true" id="pkVal" hidden="true" />
					</div>
				</w:form>
			</layout:panel>
	</layout:window>
	
	<layout:window maximizable="true" width="855" height="738" id="cfgCronWindow" jsvar="cfgCronWindowJsvar">
			<w:iframe style="width: 100%; height: 100%;" frameborder="no" id="cronIFrame" 
			name="cronIFrame"/>
	</layout:window>
	
	<script>
	//<![CDATA[
	
	function formatJobStatus(v,m,r) {
		var temp = '';
    	if(v == 'Running'){
			m.attr="style='background-color:green;'";
			temp=temp+'<image src="/scp/main/img/clock.ico" style="height:14px;" />'+v;
		}else{
			m.attr="style='background-color:#ff8282;'";
			temp=temp+'<image src="/scp/main/img/exclamation-mark.ico" style="height:14px;" />'+v;
		}
        return temp;
    }
     
    function running() {
		refreshJsVar.fireEvent("click");
	}
	
	
	function refreshCron(v) {
	    cronJsVar.setValue(v);
	    cfgCronWindowJsvar.hide();
	}
	     
	Ext.onReady(function(){
		var newHeight = (gridPanelJsvar.getSize().height) - 55;
		var newWidth = (gridPanelJsvar.getSize().width);
        //alert(newHeight);
        //alert(newWidth);
        gridJsvar.setHeight(newHeight);
        gridJsvar.setWidth(newWidth);
        
        
     });
     //]]>
</script>
</f:view>