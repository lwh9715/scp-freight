(function(g){g.fn.extend({diyUpload:function(k,j){if(typeof k!="object"){alert("参数错误!");return;}var i=g(this);var n=i.attr("id");if(k.url){k.server=k.url;delete k.url;}if(k.success){var l=k.success;delete k.success;}if(k.error){var m=k.error;delete k.error;}g.each(e("#"+n),function(o,p){k[o]=k[o]||p;});if(k.buttonText){k.pick["label"]=k.buttonText;delete k.buttonText;}var h=d(k);if(!WebUploader.Uploader.support()){alert(" 上传组件不支持您的浏览器！");return false;}h.on("fileQueued",function(o){c(i,o,h);});h.on("uploadProgress",function(q,p){var o=g("#fileBox_"+q.id);var r=o.find(".diyBar");r.show();p=p*100;f(p.toFixed(2),r);});h.on("uploadFinished",function(){i.next(".parentFileBox").children(".diyButton").remove();});h.on("uploadAccept",function(o,p){if(j){j(p);}});h.on("uploadSuccess",function(q,p){var o=g("#fileBox_"+q.id);var r=o.find(".diyBar");o.removeClass("diyUploadHover");r.fadeOut(1000,function(){o.children(".diySuccess").show();});if(l){l(p);}});h.on("uploadError",function(p,r){var o=g("#fileBox_"+p.id);var s=o.find(".diyBar");f(0,s,"上传失败!");var q="上传失败! 文件:"+p.name+" 错误码:"+r;if(m){m(q);}});h.on("error",function(o){var p="";switch(o){case"F_DUPLICATE":p="该文件已经被选择了!";break;case"Q_EXCEED_NUM_LIMIT":p="上传文件数量超过限制!";break;case"F_EXCEED_SIZE":p="文件大小超过限制!";break;case"Q_EXCEED_SIZE_LIMIT":p="所有文件总大小超过限制!";break;case"Q_TYPE_DENIED":p="文件类型不正确或者是空文件!";break;default:p="未知错误!";break;}alert(p);});}});function e(h){return{pick:{id:h,label:"点击选择图片"},accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},thumb:{width:170,height:150,quality:70,allowMagnify:false,crop:true,type:"image/jpeg"},method:"POST",server:"",sendAsBinary:false,chunked:true,chunkSize:512*1024,fileNumLimit:50,fileSizeLimit:5000*1024,fileSingleSizeLimit:500*1024};}function d(h){return new WebUploader.Uploader(h);}function f(i,l,k){if(i>=100){i=i+"%";k=k||"上传完成";}else{i=i+"%";k=k||i;}var j=l.find(".diyProgress");var h=l.find(".diyProgressText");j.width(i);h.text(k);}function b(j,i,h){h.removeFile(i);if(j.siblings("li").length<=0){j.parents(".parentFileBox").remove();}else{j.remove();}}function c(m,l,j){var p=l.id;var t=m.next(".parentFileBox");if(t.length<=0){var i='<div class="parentFileBox"> 						<ul class="fileBoxUl"></ul>					</div>';m.after(i);t=m.next(".parentFileBox");}if(t.find(".diyButton").length<=0){var i='<div class="diyButton"> 						<a class="diyStart" href="javascript:void(0)">开始上传</a> 						<a class="diyCancelAll" href="javascript:void(0)">全部取消</a> 					</div>';t.append(i);var q=t.find(".diyStart");var o=t.find(".diyCancelAll");var n=function(){j.upload();q.text("暂停上传").one("click",function(){j.stop();g(this).text("继续上传").one("click",function(){n();});});};q.one("click",n);o.bind("click",function(){var w=j.getFiles("queued");g.each(w,function(y,x){b(g("#fileBox_"+x.id),x.id,j);});});}var v='<li id="fileBox_'+p+'" class="diyUploadHover"> 					<div class="viewThumb"></div> 					<div class="diyCancel"></div> 					<div class="diySuccess"></div> 					<div class="diyFileName">'+l.name+'</div>					<div class="diyBar"> 							<div class="diyProgress"></div> 							<div class="diyProgressText">0%</div> 					</div> 				</li>';t.children(".fileBoxUl").append(v);var h=g(".fileBoxUl>li").length*180;var k=m.parent().width();h=k>h?h:k;t.width(h);var s=t.find("#fileBox_"+p);var u=s.children(".diyCancel").one("click",function(){b(g(this).parent("li"),p,j);});if(l.type.split("/")[0]!="image"){var r=a(l.name.split(".").pop());s.addClass(r);return;}j.makeThumb(l,function(x,w){if(!x){s.find(".viewThumb").append('<img src="'+w+'" >');}});}function a(i){var h={};var j="_diy_bg";h.pdf="pdf";h.zip="zip";h.rar="rar";h.csv="csv";h.doc="doc";h.xls="xls";h.xlsx="xls";h.txt="txt";h=h[i]||"txt";return h+j;}})(jQuery);