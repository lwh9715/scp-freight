<?xml version="1.0" encoding="UTF-8"?>
<f:view xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://java.sun.com/jsf/core"
	xmlns:w="http://www.apusic.com/jsf/widget" xmlns:layout="http://www.apusic.com/jsf/layout"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:ajax="http://www.apusic.com/jsf/ajax"
	xmlns:ui="http://java.sun.com/jsf/facelets" renderKitId="AJAX">
	<w:head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<link rel="stylesheet" type="text/css" href="/scp/layui/css/layui.css"></link>
		<script type="text/javascript" src="/scp/common/js/jquery.min.js"></script>
		<w:script type="text/javascript" src="/common/ckeditor/config.js?t=3"></w:script>
		<w:script type="text/javascript" src="/common/ckeditor/ckeditor.js?t=3"></w:script>
		<w:script type="text/javascript" src="/common/ckeditor/extckeditor.js?t=3"></w:script>
		
	</w:head>
	<w:page title="" >
		<div style="display: none;height: 0px;">
			<ajax:submitAction id="saveAction" jsvar="saveAction" />
			<ajax:submitAction id="sendAction" jsvar="sendAction" />
			<ajax:submitAction id="addEmail" jsvar="addEmail" />
			<ajax:submitAction id="delAttachment" jsvar="delAttachment" />
		</div>
		<div style="height: 0px;"><ui:include src="/common/gridpage.xhtml"/></div>
		
		<layout:panel id="editPanel" jsvar="gridPanelJsvar" height="100%" width="100%" hideBorders="true" autoScroll="true" 
			fit="true">
			<w:form id="formedt">
				<layout:panelGrid columns="3">
					<w:toolBar>
						<w:button id="send" value="#{l.m['发送']}" allowReEnter="false" onclick="sendSubmit()"
							image="#{constantBean.contextPath}/images/save.png" />
						<w:button id="save" value="#{l.m['保存']}" allowReEnter="false" onclick="beforeSubmit()"
							image="#{constantBean.contextPath}/images/save.png" />
						<w:button id="mgrAttachment" value="#{l.m['附件']}"
							image="#{constantBean.contextPath}/pages/module/common/resources/images/excel.gif" />
						<w:button id="intoJobsEmail" value="#{l.m['工作单附件导入']}"
							image="#{constantBean.contextPath}/pages/module/common/resources/images/excel.gif" />
						<w:button id="open" value="#{l.m['编辑']}" allowReEnter="false" onclick="openitself()"
									image="#{constantBean.contextPath}/images/query-small.png" />
						<w:button id="showAddresslist" value="#{l.m['通讯录']}"
							image="#{constantBean.contextPath}/pages/module/common/resources/images/execute.png" />
						<w:button id="saveAddresslist" value="#{l.m['保存到通讯录']}" onclick="saveAddressList()"
							image="#{constantBean.contextPath}/pages/module/common/resources/images/execute.png" />
						<w:button id="showHisEmail" value="#{l.m['历史']}"
							image="#{constantBean.contextPath}/pages/module/common/resources/images/execute.png" />
						<w:button id="showEmailFastext" value="#{l.m['快速文本']}" onclick="emailFastextWindowJs.show()"
							image="#{constantBean.contextPath}/pages/module/common/resources/images/execute.png" />
						<!--<w:button id="delJobsEmail" value="#{l.m['工作单附件清除']}"
							image="#{constantBean.contextPath}/pages/module/common/resources/images/excel.gif" />
					--></w:toolBar>
				</layout:panelGrid>
				<layout:panelGrid columns="3" style="font-size:12px" cellpadding="0" cellspacing="0">
					<h:outputText value="#{l.m['收件人']}" escape="false" style="width: 100px; color:red" />
					<w:textField width="500" selectOnFocus="true" jsvar="addressee"
						value="#{pages.sysmgr.mail.emaileditBean.selectedRowData.addressee}" />
					<layout:cell colspan="1">
						<layout:panelGrid columns="10" cellpadding="0" cellspacing="0"> 
							<w:button label="#{l.m['清空']}" onclick="addressee.setValue('')"></w:button>
							<w:checkBox boxLabel="#{l.m['委托人']}" id="customCheck" oncheck="customCheck()" jsvar="customCheckJsvar"></w:checkBox>
							<w:checkBox boxLabel="#{l.m['订舱代理']}" id="agentCheck" oncheck="customCheck()" jsvar="agentCheckJsvar"></w:checkBox>
						</layout:panelGrid>
					</layout:cell>
					<h:outputText value="#{l.m['抄送']}" escape="false" style="width: 100px" />
					<w:textField width="500" selectOnFocus="true" jsvar="copys"
						value="#{pages.sysmgr.mail.emaileditBean.selectedRowData.copys}" />
					<layout:cell colspan="1">
						<layout:panelGrid columns="10" cellpadding="0" cellspacing="0"> 
							<w:button label="#{l.m['清空']}" onclick="copys.setValue('')"></w:button>
							<w:checkBox boxLabel="#{l.m['委托人']}" id="customCheck1" oncheck="agentCheck()" jsvar="customCheck1Jsvar"></w:checkBox>
							<w:checkBox boxLabel="#{l.m['订舱代理']}" id="agentCheck1" oncheck="agentCheck()" jsvar="agentCheck1Jsvar"></w:checkBox>
						</layout:panelGrid>
					</layout:cell>
					
					<h:outputText value="#{l.m['主题']}" escape="false" style="width: 100px; color:red" />
					<w:textField width="500" selectOnFocus="true" id="subject" jsvar="subject"
						value="#{pages.sysmgr.mail.emaileditBean.selectedRowData.subject}" />
					<layout:cell colspan="1">
						<layout:panelGrid columns="10" cellpadding="0" cellspacing="0"> 
							<w:button label="#{l.m['清空']}"></w:button>
							<w:button id="gettemplate" label="#{l.m['获取模板']}"></w:button>
							<w:checkBox boxLabel="#{l.m['样单']}" id="samplelist" oncheck="samplelist()" jsvar="samplelistJsvar"></w:checkBox>
                            <w:button id="intoJobsEmailqingdao" label="#{l.m['入货通知']}"></w:button>
						</layout:panelGrid>
					</layout:cell>
					<w:textField id="customEmail1" jsvar="customEmail1Jsvar" hidden="true"></w:textField>
					<w:textField id="agentEmail1" jsvar="agentEmail1Jsvar" hidden="true"></w:textField>
					<w:textArea id="emailTemplateContent" jsvar="emailTemplateContentJsvar" hidden="true"></w:textArea>
					
				</layout:panelGrid>
				<layout:panelGrid>
					<layout:cell colspan="3">
						<span>
							<span id="attachment">附件：
							</span>
						</span>
					</layout:cell>
				</layout:panelGrid>
				<layout:panelGrid columns="2" style="font-size:12px">
					<layout:cell colspan="2" styleClass="td-editor" style="width:100%; height:100%">
						<h:outputText id="ckeditor"  escape="false" style="width: 100%;height: 100%;"
							value="#{pages.sysmgr.mail.emaileditBean.selectedRowData.content}" />
					</layout:cell>
				</layout:panelGrid>
				<f:verbatim></f:verbatim>
			</w:form>
		</layout:panel>
	</w:page>
	
	<layout:window maximizable="true" width="850" height="380" id="emailtemplateWindow"
		constrainHeader="true">
		<layout:panel id="gridPanel" jsvar="gridPanelJsvar" height="400" width="850" region="center"
					hideBorders="true" fit="true">
				<w:form groupId="templateForm">
					<w:toolBar>
						<w:button id="refreshTemplate" jsvar="refreshTemplateJsVar" label="#{l.m['刷新']}"
							image="#{constantBean.contextPath}/images/refresh.png" />
						<w:button id="imputtemp" label="#{l.m['导入']}"
							image="#{constantBean.contextPath}/images/save.png" />
					</w:toolBar>
					<layout:panelGrid columns="20" cellspacing="0" cellpadding="0">
						<layout:cell style="width: 25px;">
							<w:button id="clearQryKey" label="" width="25"
								image="#{constantBean.contextPath}/images/clear.png" />
						</layout:cell>
						<w:textField selectOnFocus="true" width="125"
							value="#{pages.sysmgr.mail.emaileditBean.qryMap['namec']}" />
						<w:textField selectOnFocus="true" width="125"
							value="#{pages.sysmgr.mail.emaileditBean.qryMap['namee']}" />
						<w:textField selectOnFocus="true" width="150"
							value="#{pages.sysmgr.mail.emaileditBean.qryMap['subject']}" />
						<w:dateField selectOnFocus="true" width="200"
							value="#{pages.sysmgr.mail.emaileditBean.qryMap['content']}">
							<f:convertDateTime pattern="yy/MM/dd" timeZone="GMT+8" />
						</w:dateField>
						<w:button id="refresh" value="#{l.m['查询']}"
							image="#{constantBean.contextPath}/images/query-small.png" />
	
						<ajax:status startStyle="color: red"
							onstart="document.getElementsByTagName('body').item(0).style.cursor='progress'"
							onstop="document.getElementsByTagName('body').item(0).style.cursor='auto'">
							<f:facet name="start">
								<f:verbatim>
									<img src="#{constantBean.contextPath}/images/waiting.gif" style="height: 16px;" />
								</f:verbatim>
							</f:facet>
						</ajax:status>
					</layout:panelGrid>
					<w:dataGrid id="grid" jsvar="gridJsvar" idColumn="id" selectable="true" height="320" paged="true" rows="20"
 						selections=""  selectionModel="#{constantBean.checkBox}" onrowdeselect="return false" toolBarPosition="bottom">
						<w:outputColumn id="id" header="ID" hidden="true" />
						<w:outputColumn header="#{l.m['中文名']}" id="namec" width="125"  sortable="true">
						</w:outputColumn>
						<w:outputColumn header="#{l.m['英文名']}" id="namee" width="125" sortable="true" >
						</w:outputColumn>
						<w:outputColumn header="#{l.m['主题']}" id="subject" width="150" sortable="true" >
						</w:outputColumn>
						<w:outputColumn header="#{l.m['内容']}" id="content" width="200" sortable="true" >
						</w:outputColumn>
						<w:outputColumn header="#{l.m['录入人']}" id="inputer" sortable="true" width="60" />
						<w:outputColumn header="#{l.m['录入时间']}" id="inputtime" width="100" sortable="true">
						</w:outputColumn>
					</w:dataGrid>
				</w:form>
		</layout:panel>
	</layout:window>
	
	
	
	<layout:window maximizable="true" width="840" height="400" id="attachmentWindow" jsvar="attachmentWindowJsVar" title="Attachment">
		<w:iframe id="attachmentIframe" style="height:100%; width:100%;">
		</w:iframe>
	</layout:window>
	
	<layout:window maximizable="true" width="1000" height="270" id="jobemailtemplateWindow"
		constrainHeader="true">
		<layout:panel id="gridPanelemail" jsvar="gridPanelemailJsvar" height="270" width="1000" region="center"
					hideBorders="true" fit="true">
				<w:form groupId="templateForm">
					<w:toolBar>
						<w:button id="setEmail" label="#{l.m['确认']}"
							image="#{constantBean.contextPath}/images/save.png" />
						<h:outputText value="#{l.m['请选择需要导入的附件']}" escape="false" style="width: 100px; color:red" />
					</w:toolBar>
					<w:dataGrid id="emailGrid" jsvar="emailGridJsvar" idColumn="id" selectable="true" height="200"
						selections=""  selectionModel="#{constantBean.checkBox}" onrowdeselect="return false">
						<w:outputColumn id="id" header="ID" hidden="true" />
						<w:outputColumn header="#{l.m['名称']}" id="filename" width="180" />
						<w:outputColumn header="#{l.m['路径']}" id="filepath" hidden="true" />
						<w:outputColumn header="#{l.m['类型']}" id="contenttype" width="120" />
						<!--<w:outputColumn header="Show" id="thisshow" width="120"/>
						--><w:outputColumn header="#{l.m['大小']}/b" id="filesize" align="right" />
						<w:outputColumn header="#{l.m['分组']}" id="rolegroup" width="120"/>
						<w:outputColumn header="#{l.m['上传人']}" id="inputername" sortable="true" width="80" />
						<w:outputColumn header="#{l.m['上传时间']}" id="inputtime" width="120" sortable="true">
							<f:convertDateTime pattern="yy/MM/dd HH:mm" timeZone="GMT+8" />
						</w:outputColumn>
						<w:outputColumn header="#{l.m['备注']}" id="remake" width="120" />
					</w:dataGrid>
				</w:form>
		</layout:panel>
	</layout:window>
	
	<layout:window maximizable="true" width="700" height="390" id="addresslistWindow" title="Address List">
		<layout:panel id="addsPanel" height="700" hideBorders="true" style="font-size:12px">
			<w:form>
				<w:toolBar>
					<w:button id="qryRefresh" label="#{l.m['刷新']}"
						image="#{constantBean.contextPath}/images/refresh.png" />
					<w:button id="addAddressee" value="#{l.m['导入收件人']}"
						image="#{constantBean.contextPath}/pages/module/common/resources/images/down.gif" />
					<w:button id="addCC" value="#{l.m['导入抄送人']}"
						image="#{constantBean.contextPath}/pages/module/common/resources/images/down.gif" />
					<w:button id="perAddMgr" label="#{l.m['管理个人通讯录']}" onclick="showUserAddressList()"
							image="#{constantBean.contextPath}/images/refresh.png" />
				</w:toolBar>

				<layout:panelGrid columns="20" cellspacing="0" cellpadding="0">
					<layout:cell style="width: 25px;">
						<w:button id="clearQryKey" label="" width="25"
							image="#{constantBean.contextPath}/images/clear.png" />
					</layout:cell>
					<w:combo value="#{pages.sysmgr.mail.emaileditBean.qryMapAdrr['adrtype$']}" width="55">
						<f:selectItem itemLabel="#{l.m['个人']}" itemValue="2" />
						<f:selectItem itemLabel="#{l.m['客户']}" itemValue="1" />
						<f:selectItem itemLabel="#{l.m['系统']}" itemValue="0" />
					</w:combo>
					<w:textField id="queryStr" selectOnFocus="true" width="300" emptyText="#{l.m['检索']}"
						 />
					
				</layout:panelGrid>
				<layout:panelGrid columns="4" cellspacing="1" style="font-size:12px">
					<w:dataGrid height="300" jsvar="gridAdressJsvar" paged="true" rows="14" id="gridAdress"
						toolBarPosition="bottom" idColumn="id" selectable="true"
						selectionModel="#{constantBean.checkBox}">
						<w:outputColumn id="id" header="ID" hidden="true" />
						<w:outputColumn header="#{l.m['类别']}" id="adrtype" sortable="true" width="45"
							clientFormatter="formateAddType" />
						<w:outputColumn header="#{l.m['代码']}" id="code" sortable="true" width="80"
							clientFormatter="formateAddTypeColor" />
						<w:outputColumn header="#{l.m['中文名']}" id="namec" width="80" sortable="true"
							clientFormatter="formateAddTypeColor" />
						<w:outputColumn header="#{l.m['客户简称']}" id="customerabbr" width="100" sortable="true" />
						<w:outputColumn header="#{l.m['工作岗位']}" id="jobtitle" width="100" sortable="true" />
						<w:outputColumn header="email1" id="email1" width="120" sortable="true" />
						<w:outputColumn header="email2" id="email2" width="120" sortable="true" />
					</w:dataGrid>
				</layout:panelGrid>
			</w:form>
		</layout:panel>
	</layout:window>
	<layout:window maximizable="true" width="700" height="450" id="hisEmailWindow" title="History">
		<layout:panel id="addsPanel1" height="700" hideBorders="true" style="font-size:12px">
			<w:form>
				<w:toolBar>
					<w:button id="qryRefreshHis" label="#{l.m['刷新']}"
						image="#{constantBean.contextPath}/images/refresh.png" />
					<w:button id="addHisAddressee" value="#{l.m['导入收件人']}"
						image="#{constantBean.contextPath}/pages/module/common/resources/images/down.gif" />
					<w:button id="addHisCC" value="#{l.m['导入抄送人']}"
						image="#{constantBean.contextPath}/pages/module/common/resources/images/down.gif" />
				</w:toolBar>
				<layout:panelGrid columns="20" cellspacing="0" cellpadding="0">
					<layout:cell style="width: 25px;">
						<w:button id="clearQryKeyHis" label="" width="25"
							image="#{constantBean.contextPath}/images/clear.png" />
					</layout:cell>
					<w:textField selectOnFocus="true" width="150"
						value="#{pages.sysmgr.mail.emaileditBean.qryMapHis['addressee']}" />
					<w:textField selectOnFocus="true" width="150"
						value="#{pages.sysmgr.mail.emaileditBean.qryMapHis['copys']}" />
					<w:textField selectOnFocus="true" width="200"
						value="#{pages.sysmgr.mail.emaileditBean.qryMapHis['subject']}" />
				</layout:panelGrid>
				<layout:panelGrid columns="4" cellspacing="5px" width="600" style="font-size:12px">
					<w:dataGrid height="350" paged="true" rows="14" id="gridHisEmail" toolBarPosition="bottom"
						idColumn="id" selectable="true" selectionModel="#{constantBean.checkBox}">
						<w:outputColumn id="id" header="ID" hidden="true" />
						<w:outputColumn header="#{l.m['收件人']}" id="addressee" sortable="true" width="150" />
						<w:outputColumn header="#{l.m['抄送']}" id="copys" sortable="true" width="150" />
						<w:outputColumn header="#{l.m['主题']}" id="subject" width="200" sortable="true" />
					</w:dataGrid>
				</layout:panelGrid>
			</w:form>
		</layout:panel>
	</layout:window>
	
	<layout:window maximizable="true" width="840" height="600" id="emailFastextWindow" jsvar="emailFastextWindowJs" title="#{l.m['快速文本']}">
		<w:iframe id="emailFastextIframe" style="height:100%; width:100%;">
		</w:iframe>
	</layout:window>
	
	<script type="text/javascript">
	//<![CDATA[
        Ext.onReady(function() {
        	var height = gridPanelJsvar.getHeight()-240;
			var width = gridPanelJsvar.getWidth()-35;
			console.log("height:"+height + " width:"+ width);
        	editor1 = Ext.form.CKEditor.create("formedt:ckeditor",width,height );
        	$('td').attr('valign','top');
        	setTimeout("resizeCKEdit()","200"); 
        	setTimeout("resizeCKEdit()","2000"); 
        });
        function setValue(text) {
        	editor1.setValue(text);
        }
        
        function setValueAdd(text) {
        	editor1.setValue(editor1.getValue()+text);
        }
        
        
        function changelang(){
	       CKEDITOR.on('instanceCreated', function(event){ 
	  			var editor = event.editor;
	  			editor.on('configLoaded', function(){ 
	    			editor.config.language = "en-uk"; 
	  			});
	       });
		}
		
		function refreshEmailContent(){
			editor1.setValue(emailTemplateContentJsvar.getValue());
		}
		
		
		function showUserAddressList(){
			window.open("/scp/pages/sysmgr/addresslist/usraddress.xhtml");
		}
		
		function saveAddressList(){
			var email = getSelectionText();
			var url = "/scp/pages/sysmgr/addresslist/usraddress.xhtml?type=new&email="+email;
			$('#attachmentIframe').attr('src',url);
			attachmentWindowJsVar.show();
		}
        
        function beforeSubmit() {
        	saveAction.addParam('editor1',editor1.getValue());
        	saveAction.addParam('addressee',addressee.getValue());
        	saveAction.addParam('copys',copys.getValue());
        	saveAction.addParam('subject',subject.getValue());
        	saveAction.submit();
	    }
	    function sendSubmit() {
        	sendAction.addParam('editor1',editor1.getValue());
        	sendAction.addParam('addressee',addressee.getValue());
        	sendAction.addParam('copys',copys.getValue());
        	sendAction.addParam('subject',subject.getValue());
        	sendAction.submit();
	    }
	    
	    function customCheck(){//赋值对应的委托人和订舱单位，当两个都有值时用;号分开
	    	var value = "";
	    	if(customCheckJsvar.getValue()==true&&customEmail1Jsvar.getValue()!=''){
	    		value = customEmail1Jsvar.getValue();
	    	}
	    	if(agentCheckJsvar.getValue()==true&&agentEmail1Jsvar.getValue()!=''){
	    		if(value!=""){
	    			value=value+";"+agentEmail1Jsvar.getValue();
	    		}else{
	    			value=agentEmail1Jsvar.getValue();
	    		}
	    	}
	    	addressee.setValue(value);
	    }
	    
	    function agentCheck(){//赋值对应的委托人和订舱单位，当两个都有值时用;号分开
	    	var value = "";
	    	if(customCheck1Jsvar.getValue()==true&&customEmail1Jsvar.getValue()!=''){
	    		value = customEmail1Jsvar.getValue();
	    	}
	    	if(agentCheck1Jsvar.getValue()==true&&agentEmail1Jsvar.getValue()!=''){
	    		if(value!=""){
	    			value=value+";"+agentEmail1Jsvar.getValue();
	    		}else{
	    			value=agentEmail1Jsvar.getValue();
	    		}
	    	}
	    	copys.setValue(value);
	    }
	    
	    function samplelist(){
	    	if(samplelistJsvar.getValue()==true && samplelistJsvar.getValue()!=''){
	    	addEmail.submit();
	    	}
	    }
	    
	    function openitself(){
	    	var url = window.location.href;
	    	window.open(url);   
	    }
	    
	    function formateAddType(v,m,r) {
		        var adrtype = r.get('adrtype');
				if(adrtype == 0){
					v = "#{l.m['系统']}";
					 m.attr="style='color:red;'";
				}else if(adrtype==1){
					v = "#{l.m['客户']}";
					 m.attr="style='color:blue;'";
				}else if(adrtype == 2){
					v = "#{l.m['个人']}";
					m.attr="style='color:green;'";
				}else {
					v = "~~~";
				}	
		        return v;
	     	}
	     function formateAddTypeColor(v,m,r) {
	        var adrtype = r.get('adrtype');
			if(adrtype == 0){
				 m.attr="style='color:red;'";
			}else if(adrtype==1){
				 m.attr="style='color:blue;'";
			}else if(adrtype == 2){
				m.attr="style='color:green;'";
			}else {
			}	
	        return v;
	     }
	     	
	    function resizeCKEdit() {
        	$('.cke_contents').css("height",(gridPanelJsvar.getHeight()-240)+"px");
			$('span[id*=cke_formedt:ckeditor]').css("width",(gridPanelJsvar.getWidth()-35)+"px");
        }
        $("#attachment").empty();

        function showAttachmentFile(mailid){
			$.ajax({
				type:'POST',
				url:'/scp/service?src=webServer&action=commonQueryByXml&sqlId=servlet.web.ff.queryattach&qry=linkid='+mailid+'',
				contentType:'application/json',
				success:function(data){
					$("#attachment").empty();
					if(data == null || data == "")return;
					if(typeof(data)=="string"){
						data = JSON.parse(data);
					}
					console.log(data);
					var html;
					if(data.length > 0){
						 
						 $("#attachment").append("附件：");
						 for(var i = 0; i < data.length; i++) {
						 	var j = i+1;
						 	var fileUrl = data[i].url;
						 	if(fileUrl == undefined || fileUrl == null || fileUrl == ''){
						 		fileUrl = '/scp/attachment/"+data[i].id+""+data[i].filename+"';
						 	}
						 	console.log("fileUrl:"+fileUrl);
							html="<a class='layui-btn layui-btn-xs layui-btn-primary' style='text-decoration: underline;' target='_blank' href='"+fileUrl+"'>"+j+"."+data[i].filename+"("+ ( parseInt( data[i].filesize/1024 * 100 ) / 100 ).toFixed(2)+"KB)"+"</a>";
							html +="		";
							$("#attachment").append(html);
						};
					}
				}
			});
		}		
		
		function getSelectionText() { 
			if(window.getSelection) { 
				return window.getSelection().toString(); 
			} else if(document.selection && document.selection.createRange) { 
				return document.selection.createRange().text; 
			} 
			return ''; 
		} 
        
	    
	    //]]>
	</script>
</f:view>